<!--Description: Main page -->
<!--Project: https://github.com/issalig/toshiba_air_cond -->
<!--Author: Ismael Salvador -->
<!--Date: February 2025 -->

<!DOCTYPE html>
<html>

<head>
    <title>Air conditioning</title>
    <!-- <link href='main.css' rel='stylesheet' type='text/css'> -->
    <!-- begin inline css -->
    <style>
        body {
            background: #f4f8fb;
            font-family: 'Roboto', sans-serif;
            margin: 0;
        }

        .controller-card {
            max-width: 420px;
            margin: 30px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px #002F7A22;
            padding: 24px 18px 18px 18px;
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .status-icon {
            font-size: 32px;
            color: #00878f;
            margin-right: 8px;
        }

        .temp-display {
            font-size: 48px;
            font-weight: bold;
            color: #002F7A;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .temp-display .material-icons {
            font-size: 48px;
            margin-right: 8px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            margin: 18px 0;
        }

        .control-btn {
            flex: 1;
            margin: 0 6px;
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            background: #00878f;
            color: #fff;
            font-size: 20px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 8px #002F7A22;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-btn.active,
        .control-btn:active {
            background: #ffbe0b;
            color: #002F7A;
        }

        .control-btn .material-icons {
            font-size: 28px;
            margin-bottom: 2px;
        }

        .control-btn .material-symbols-outlined {
            font-size: 28px;
            margin-bottom: 2px;
        }

        .timer-section .control-btn {
            margin: 4px 2px;
            padding: 10px 0;
            font-size: 16px;
        }

        .timer-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #00878f;
            color: #fff;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 4px #002F7A22;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-btn:hover {
            background: #006d73;
        }

        .timer-btn.active {
            background: #ffbe0b;
            color: #002F7A;
        }

        .timer-btn .material-icons {
            font-size: 16px;
        }

        .timer-adjust-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            background: #002F7A;
            color: #fff;
            font-size: 12px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 1px 3px #002F7A22;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-adjust-btn:hover {
            background: #004080;
        }

        .timer-adjust-btn .material-icons {
            font-size: 16px;
        }

        @media (max-width: 500px) {
            .controller-card {
                max-width: 98vw;
            }

            .button-row {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .control-btn {
                margin: 6px 4px;
                min-width: 90px;
                flex: 0 1 auto;
            }
        }
    </style>
    <!-- end of inline css -->

    <!--    <link rel="icon" type="image/png" sizes="144x144"  href="/favicon-144x144.png"> -->
    <!--    <link rel="icon" type="image/png" sizes="48x48" href="/favicon.ico"> -->
    <link rel="shortcut icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAAAAAByaaZbAAAA53pUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjadVFbEsMgCPz3FD2CAlE5jmnSmd6gxy8g5jUJMyIC7rIa1t/3E15qUHOgqdTMOUcxYmJoEtTYbTafIpk3Qy/J+ZQPWwEkhXsng/ePfNoA+tYkmg5A7OxpPhfawK8XICdCnUjJFgdqDoTQC4lcVXYClOzNRJlrOUl7D+phdV9YjHMDv56pyKsukzJBgBWVVH3tk6EuwCZ7Eo82kvRITFjMK5BNzDEWRZSJumy7Kqo5jYLL6LL0xQ557MD24kN2OOqO+vd3X40PebfwB1IRdQnTQs4ZAAABI2lDQ1BJQ0MgcHJvZmlsZQAAeJydkL1KxFAQhb+s4h9aKRYiEtB20cZUNqtCEBRiXMHVKptkcTGJIcmy7Bv4JvowWwiCj+ADKFh7brSwMI0Dw3wMM+fMvdCykzAtZ/cgzarC9Tu9q961Pf+GxRaL7LIdhGXe8bxTGuPzVdOKl7bRap77M+aiuAxVp8oszIsKrAOxM65yw0rW7rr+kfhBbEdpFomfxDtRGhk2u36ajMIfTXPNcpxdXpi+chOXE87wsOkzYkhCRVs1U+cYh31Vl4KACSWhakKs3lgzFbeiUkouh6KuSNc0+G3Ufp5c+tIYSss43JNK0/hh/vd77eO83rTWp3lQBHVrRtkaDOD9EVZ6sPoMSzcNXgu/39Yw49Qz/3zjFx6yUIDsQg7GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5gEeCS8zI3I51wAABL5JREFUSMeNVn9oVVUc/3zOe8/Z2j1ibNfQd9Pd0oeu0lZBIEPzHxsqYRmJhUkkQUgEIRiBECWbFYVoQoSFSAaRpFIGiWRQyCiW6KY9FdfymbY317b73K97z/n2x33vbaM97Vwul8/3fM/5fC/n+/18Dy0AUEoPbgNJCwgFxLj1VhBJCIvGiQ4VoaIVERCAMH5REQIgk0KF/z8EFJw7PxSvKYfNqaG9Y9EiwehukuCkURnuGeOhdQvC/x1R6sJXbMqOBDFizYwUABRiQ/kQMP51pmcIFle703Kljep7gwn+TpkgAIU63t+ZkcMjG+pnp4Lc2VZgzl+T9hdVgg6hBEBdHm+sX2B7CphWVz3cvvtI7UhQ9K+rwmjVaNVoFZADhASAdG7ZrvsvHmlfMDN6J3hpVVP1t8/ACUBBOvfjQkMAkERfc5cTACQ9bhns2br2RJ+I9G8g1cGxc77WiqTP81Ia/Q3UAEmXW8bO8PURERONyT7d6HJTf7fnaZI+z0pooshEoc1nqAko120eaiezEkbWGLtLecxwRdBBj6TPDomMscYYuVFk8HjpGjP6kg2tMXZ4FTXp80XZT4/0VYeExhpjI+ltoCbo8QPZpBvUTxKZaEw66ZFkhodHlmpNn50SWWNsmQEer/xKX+v1gY1EpFV7JJX2vMLX9JXPs3FINpLeBqUJl5ujrdqjx50i7e+9Rk1SkT5P9HBWzGBsmYGqBiuD95FDLr3tiwMP1yxrCRwnPa++ruB8P2NdjwNIqagRn7bPM1nlk6THB6+LyHGqGDUO76U3iSFDjSTgXBUADqrTH84KmVix+Z8VSZz6rO63wkykAAtRRYYkwGQoMgCkU11SEM8yYZKZ2o3AxnWrMZoEQIWyxESAqBSVg1Sua37zGlxWMAmcrJcomta806mKAIiN/wEoMgA3XefCx4/Nrk60Lev2gCOnl4AqSmQCHSBMQRWFy4IRgSSYXR4cXQ1Amg7M3XNX9q0OJ0oIef05dZIDtRCIElAASQoELrfYZ7N2zJjIyu/NpH9ZImNs9OTRG3Qn5VJvhpqqp+6j/MsdJKBE5s+uf6DrEwsIrx19vA01KBc04/gF9LjXvNInobWhtNGnx28kiqTl03C51jGDNcaaUvJBefzzwgvDEobWvKpdao+nRH5ear6kN3V6z3LXh8c39InIIbqkomZrC3svKo9Tpreiy+32h8bDp94u+ns+G67/3ejqYgGFxhhjojg1ijW9fbhrLUnP932X5L6Ry01x2vrsLNd0X4PSRd301Nqs6Xh3MUhyzf5rY98puiQVPf5ys39wcCAYGCxcyVAzVj7OyaH16XuinlGbcGZGnXsP1CAoythDd8ImjLJQYRsA6njCmZ7HUyvvvTs53J3dl2U69191BQDUECxa0rhamqkv5Mcdx6UVAQA+2t0rk9U7HKio3qiby4PPLxxMAYU8pa6mQlso5MHaGiDU5z/H0I64y/ieX7kHlSZVyxAlOn3Ggn/sAN6cN+H3xhu7JLp2ANvuM+SSxUmaWL/zx6rGnnArhJQ/Nn14dS0AiFBsqfqAaLxrlrqzUBhPGkBIRRsXoFiClS4DsCBjCNrb3hYmwZgBkxxuCUGxSiYc/oRbz9TwX9V0AeR8vcR8AAAAAElFTkSuQmCC">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="theme-color" content="#00878f">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


    <!-- begin inline js -->
    <script type=text/javascript>

// Global variables

var power = false;
var save = false;
//var debug_cmd = false;
var chart;
var ac_sensor_values=[];
var ac_target_values=[];

var timeStamp = [0,1,2,3];
var chart_obj;

var trafficCaptureEnabled = true; // Start enabled by default

var button_pressed_color = '#002F7A';
var button_released_color = '#99C0FF';

var debug_cmd_typed = false;
var debug_cmd_timestamp = false;
var debug_rx = false;

var addressesRefreshInterval = null;
var sensorsRefreshInterval = null;

var currentTimerMode = 'off'; // Default to 'off'

// Fan speed cycling state
var fanSpeedStates = [
    { value: "low", text: "Low", icon: "density_large" },
    { value: "medium", text: "Med", icon: "density_medium" },
    { value: "high", text: "High", icon: "density_small" },
    { value: "auto", text: "Auto", icon: "hdr_auto" }
];
var currentFanSpeedIndex = 0;

// Mode cycling state  
var modeStates = [
    { value: "fan", text: "Fan", icon: "mode_fan" },
    { value: "dry", text: "Dry", icon: "opacity" },
    { value: "cool", text: "Cool", icon: "ac_unit" },
    { value: "heat", text: "Heat", icon: "sunny" },
    { value: "auto", text: "Auto", icon: "autorenew" }
];
var currentModeIndex = 0;

// Power cycling state
var powerStates = [
    { value: "off", text: "OFF", icon: "power_off" },
    { value: "on", text: "ON", icon: "power_settings_new" }
];
var currentPowerIndex = 0;

// Sensor ID descriptions mapping
const sensorDescriptions = {
    0x00: "Indoor Room Control Temp",
    0x01: "Indoor Room Remote Temp",
    0x02: "Indoor TA",
    0x03: "Indoor TC",
    0x04: "Indoor TCJ",
    0x07: "Indoor Fan Speed",
    0xF2: "Indoor Fan Run Time",
    0xF3: "Indoor Filter Time",
    0xF8: "Indoor Discharge Temp",

    0x60: "Outdoor TE",
    0x61: "Outdoor TO",
    0x62: "Outdoor TD",
    0x63: "Outdoor TS",
    0x65: "Outdoor THS",
    0x6A: "Outdoor Current",
    0x6D: "Outdoor TL",
    0x70: "Outdoor Comp Freq",
    0x72: "Outdoor Lower Fan Speed",
    0x73: "Outdoor Upper Fan Speed",
    0xF0: "Outdoor Capacity Code",
    0xF1: "Outdoor Compressor Hours",

    /* to be verified */
    0x74: "Inverter Operation Current",
    0x75: "DC Bus Voltage",
    0x76: "IPDU Heatsink Temperature",
    0x77: "Compressor Current",
    0x78: "Outdoor Heat Exchanger Temperature",
    0x79: "PMV Valve Status"
};

// DN Code descriptions mapping
const dnCodeDescriptions = {
    0x01: "Filter alarm time",
    0x02: "Dirty state",
    0x03: "Central ctl address",
    0x04: "Specific indoor priority",
    0x05: "Fan control heating",
    0x06: "Heating temp shift",
    0x0C: "Preparing indication",
    0x0D: "Auto mode existence",
    0x0E: "FS Box",
    0x0F: "Heat mode",
    0x10: "Type",
    0x11: "Indoor unit capacity",
    0x12: "System address",
    0x13: "Indoor unit address",
    0x14: "Group master/slave",
    0x16: "Indoor fan speed",
    0x1E: "Dead band",
    0x1F: "Max set temp cool",
    0x20: "Min set temp cool",
    0x21: "Max set temp heat",
    0x22: "Min set temp heat",
    0x23: "Max set temp dry",
    0x24: "Min set temp dry",
    0x25: "Max set temp auto",
    0x26: "Min set temp auto",
    0x28: "Auto restart",
    0x2A: "CN70",
    0x2E: "CN61",
    0x31: "External fan control",
    0x32: "TA sensor (0 Body, 1 Remote)",
    0x33: "Temperature unit (0 C, 1 F)",
    0x45: "Anti-smudge louver",
    0x49: "24h ventilation",
    0x4C: "Night purge",    
    0x5D: "Standard ducted",
    0x60: "Timer set",
    0x62: "Anti-smudge fan speed",
    0x69: "Louver position",
    0x77: "Dust set point",
    0x86: "Correction strong heating",
    0x88: "Air direction setting",
    0x9A: "Fan control cooling",
    0x9B: "Hot start",
    0xD0: "Power saving",    
    0xF0: "Swing mode",
    0xF1: "Louver 1",
    0xF2: "Louver 2",
    0xF3: "Louver 3",
    0xF4: "Louver 4",
    0xF6: "Application ctl kit",
    0xFE: "Group control"
};

///////////////////////
//Websocket connections
///////////////////////

//small delay not to interrupt the load of files
setTimeout(() => {
  console.log('Waiting 0.6 sec')
}, 600);
 

var connection;

  window.addEventListener('load', onLoad);
  function initWebSocket() {
    try {
        // Defensive: Only try to open a WebSocket if location.hostname is valid
        if (!location.hostname) {
            updateConnectionStatus("error");
            console.error('WebSocket error: location.hostname is empty');
            return;
        }
        // Try to open a WebSocket connection
        connection = new WebSocket('ws://' + location.hostname + ':81/', ['arduino']);
        connection.onopen    = onOpen;
        connection.onclose   = onClose;
        connection.onmessage = onMessage;
        connection.onerror   = onError;
    } catch (e) {
        updateConnectionStatus("error");
        console.error('WebSocket exception:', e);
    }
}

function onOpen(event) {
    console.log('Connection opened');
    updateConnectionStatus("open");
    //connection.send('Connect ' + new Date());
    //document.getElementById('connection').textContent = "open";
    
   (function scheduleRequestStatus() {
      //send json            
	  var today = new Date();
      var curr_time = today.toLocaleTimeString('default', { hour12: false });

        let data = {
			id: "status",
			value: curr_time + " - auto"
		}

        console.log("Scheduled STATUS at " + curr_time);
		let json = JSON.stringify(data);
		connection.send(json);
      //end send json

      //call sendRequestStatus() every X seconds.
      //pressing buttons calls sendRequestStatus() directly. this way update is faster and do not send a lot of requests when doing nothing.
    
      setTimeout(scheduleRequestStatus, 20 * 1000); 
   })();

   (function scheduleRequestTimeSeries() {	  
		getTimeseries();
      setTimeout(scheduleRequestTimeSeries, 60*1000); //ask for time series every minute
   })();
  }
  function onClose(event) {    
    console.log('WebSocket connection closed');
    updateConnectionStatus("closed");
    console.log('Reconnecting ...');
    setTimeout(initWebSocket, 2000);
  }
  function onMessage(event) {
    console.log('Server: ', event.data);
    processData(event.data);
  }
  
   function onError(e) {
    console.log('WebSocket Error ', e);
    updateConnectionStatus("error");
};

  function onLoad(event) {
    initWebSocket();
  }

////////////////////
// Process requests
////////////////////

function processData(data)
{
    let json = JSON.parse(data); 
    console.log(json);

    if (json.id=="status") parseStatus(json);

    if (json.id=="master_info") parseMasterInfo(json);
    if (json.id=="sensors") parseSensors(json);
    if (json.id=="addresses") parseAddresses(json);
    if (json.id=="system_info") parseSystemInfo(json);
    if (json.id=="timeseries") parseTimeSeries(json);
    if (json.id=="debug") parseSerialLog(json);
    if (json.id=="explore_dn_code") parseDNCode(json);
    if (json.id=="explore_sensor") parseSensorExplore(json);

    if (json.id=="txrx") parseTXRXData(json);

    if (json.id=="announce_status") parseAnnounceStatus(json);

    if (json.id=="serial_config") parseSerialConfig(json);
    if (json.id=="i2c_config") parseI2CConfig(json);

    if (json.id === "save_settings" || json.id === "load_settings" || json.id === "reset_settings") {
        const statusElem = document.getElementById('settings_status');
        if (statusElem) {
            statusElem.textContent = json.message;
            statusElem.style.color = json.status === "success" ? '#4caf50' : '#f44336';
            
            setTimeout(() => {
                statusElem.textContent = '';
            }, 5000);
        }
    }

    // MQTT response handling
    if (json.id && json.id.startsWith("mqtt_")) {
    parseMQTTResponse(json);
    }

    // Simulation mode response handling
    if (json.id === "simulation_mode") {
        if (json.status === "enabled") {
            alert('Simulation mode enabled!');
        } else if (json.status === "disabled") {
            alert('Simulation mode disabled! Normal AC operation restored.');
        }
    } 
}

function parseSerialLog(json) {
    if (json.message) {
        appendSerialLog(json.message);
    }
}

// Global variable to store log lines
let serialLogLines = [];

function appendSerialLog(msg) {
    const maxLines = 100; // Maximum number of lines to keep in the log
    const log = document.getElementById('serial-log');
    if (log) {
        // Add newline to the message if it doesn't already end with one
        const messageWithNewline = msg.endsWith('\n') ? msg : msg + '\n';
        log.textContent += messageWithNewline;
        
        // Keep only the last 100 lines by splitting and rejoining
        const lines = log.textContent.split('\n');
        if (lines.length > maxLines) {
            const trimmedLines = lines.slice(-maxLines);
            log.textContent = trimmedLines.join('\n');
        }
        
        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
    }
}

function clearSerialLog() {
    const log = document.getElementById('serial-log');
    if (log) {
        log.textContent = "";
        serialLogLines = []; // Clear the array too
    }
}

function clearAll() {
    clearLastCmd();
    clearRxData();
    clearSerialLog();
}

function copyLastCmd() {
    const log = document.getElementById('last_cmd');
    if (!log) return;

    const textForClipboard = log.innerHTML
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/&nbsp;/gi, ' ')
        .trim();

    const textarea = document.createElement('textarea');
    textarea.value = textForClipboard;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}

function clearLastCmd() {
    const log = document.getElementById('last_cmd');
    if (log) {
        log.textContent = "";        
    }
}

function toggleLastCmdSize() {
    const lastCmdDiv = document.getElementById('last_cmd');
    const toggleBtn = document.getElementById('toggle_last_cmd_btn');
    
    if (lastCmdDiv.style.maxHeight === '400px') {
        lastCmdDiv.style.maxHeight = '80px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_more</span> Expand';
    } else {
        lastCmdDiv.style.maxHeight = '400px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_less</span> Collapse';
    }
}

function copySerialLog() {
    const log = document.getElementById('serial-log');
    if (!log) return;

    const textForClipboard = log.innerHTML
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/&nbsp;/gi, ' ')
        .trim();

    const textarea = document.createElement('textarea');
    textarea.value = textForClipboard;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}

function copyRxData() {
    const log = document.getElementById('rx_data');
    if (!log) return;

    // Get HTML, replace <br> with newlines, strip other tags (like error spans), replace nbsp
    const textForClipboard = log.innerHTML
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<[^>]+>/g, '') // Strip HTML tags
        .replace(/&nbsp;/gi, ' ')
        .trim();

    const textarea = document.createElement('textarea');
    textarea.value = textForClipboard;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}

function clearRxData() {
    const log = document.getElementById('rx_data');
    if (log) {
        log.textContent = "";        
    }
}

function toggleRxDataSize() {
    const rxDiv = document.getElementById('rx_data');
    const toggleBtn = document.getElementById('toggle_rx_data_btn');
    
    if (rxDiv.style.maxHeight === '400px') {
        rxDiv.style.maxHeight = '80px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_more</span> Expand';
    } else {
        rxDiv.style.maxHeight = '400px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_less</span> Collapse';
    }
}

function toggleSerialLogSize() {
    const logDiv = document.getElementById('serial-log');
    const toggleBtn = document.getElementById('toggle_serial_log_btn');
    
    if (logDiv.style.height === '400px') {
        logDiv.style.height = '150px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_more</span> Expand';
    } else {
        logDiv.style.height = '400px';
        toggleBtn.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">unfold_less</span> Collapse';
    }
}

function parseSerialConfig(json) {
    const statusElem = document.getElementById('serial_config_status');
    
    if (json.status === "applied") {
        statusElem.textContent = 'Configuration applied successfully!';
        statusElem.style.color = '#4caf50';
        
        // Update current configuration display
        if (json.tx_pin !== undefined) {
            document.getElementById('current_tx_pin').textContent = 
                'GPIO ' + json.tx_pin;
        }
        if (json.rx_pin !== undefined) {
            document.getElementById('current_rx_pin').textContent = 
                'GPIO ' + json.rx_pin;
        }
        if (json.rx_buffer_size !== undefined) {
            document.getElementById('current_rx_buffer_size').textContent = json.rx_buffer_size;
        }
        
        // Clear the status message after 3 seconds
        setTimeout(() => {
            statusElem.textContent = '';
        }, 3000);
        
    } else if (json.status === "error") {
        statusElem.textContent = 'Error: ' + (json.message || 'Unknown error');
        statusElem.style.color = '#f44336';
        
        // Clear error after 5 seconds
        setTimeout(() => {
            statusElem.textContent = '';
        }, 5000);
    }
}

function applySerialConfig() {
    const txPin = parseInt(document.getElementById('new_tx_pin').value);
    const rxPin = parseInt(document.getElementById('new_rx_pin').value);
    const rxBuffer = parseInt(document.getElementById('new_rx_buffer_size').value);
    
    // Validation
    if (isNaN(txPin) || txPin < 0 || txPin > 16) {
        document.getElementById('serial_config_status').textContent = 'Invalid TX pin';
        return;
    }
    
    if (isNaN(rxPin) || rxPin < 0 || rxPin > 16) {
        document.getElementById('serial_config_status').textContent = 'Invalid RX pin';
        return;
    }
    
    if (isNaN(rxBuffer) || rxBuffer < 64 || rxBuffer > 2048) {
        document.getElementById('serial_config_status').textContent = 'Invalid buffer size';
        return;
    }
    
    let data = {
        id: "serial_config",
        tx_pin: txPin,
        rx_pin: rxPin,
        rx_buffer: rxBuffer
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Apply Serial Config: ' + json);
    
    document.getElementById('serial_config_status').textContent = 'Applying configuration...';
    document.getElementById('serial_config_status').style.color = '#ff9800';
}

function applyI2CConfig() {
    const sdaPin = parseInt(document.getElementById('new_sda_pin').value);
    const sclPin = parseInt(document.getElementById('new_scl_pin').value);
    
    // Validation
    if (isNaN(sdaPin) || sdaPin < 0 || sdaPin > 16) {
        document.getElementById('i2c_config_status').textContent = 'Invalid SDA pin';
        document.getElementById('i2c_config_status').style.color = '#f44336';
        return;
    }
    
    if (isNaN(sclPin) || sclPin < 0 || sclPin > 16) {
        document.getElementById('i2c_config_status').textContent = 'Invalid SCL pin';
        document.getElementById('i2c_config_status').style.color = '#f44336';
        return;
    }
    
    let data = {
        id: "i2c_config",
        sda_pin: sdaPin,
        scl_pin: sclPin
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Apply I2C Config: ' + json);
    
    document.getElementById('i2c_config_status').textContent = 'Applying configuration...';
    document.getElementById('i2c_config_status').style.color = '#ff9800';
}

function parseI2CConfig(json) {
    const statusElem = document.getElementById('i2c_config_status');
    
    if (json.status === "applied") {
        statusElem.textContent = 'Configuration applied successfully!';
        statusElem.style.color = '#4caf50';
        
        // Update current configuration display
        if (json.sda_pin !== undefined) {
            document.getElementById('current_sda_pin').textContent = 
                'GPIO ' + json.sda_pin;
        }
        if (json.scl_pin !== undefined) {
            document.getElementById('current_scl_pin').textContent = 
                'GPIO ' + json.scl_pin;
        }
        
        // Clear the status message after 3 seconds
        setTimeout(() => {
            statusElem.textContent = '';
        }, 3000);
        
    } else if (json.status === "error") {
        statusElem.textContent = 'Error: ' + (json.message || 'Unknown error');
        statusElem.style.color = '#f44336';
        
        // Clear error after 5 seconds
        setTimeout(() => {
            statusElem.textContent = '';
        }, 5000);
    }
}

function saveSettings() {
    let data = {
        id: "save_settings"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Save Settings: ' + json);
    
    const statusElem = document.getElementById('settings_status');
    statusElem.textContent = 'Saving settings...';
    statusElem.style.color = '#ff9800';
}

function loadSettings() {
    if (confirm('This will apply saved settings and may require a restart. Continue?')) {
        let data = {
            id: "load_settings"
        };
        
        let json = JSON.stringify(data);
        connection.send(json);
        console.log('Load Settings: ' + json);
        
        const statusElem = document.getElementById('settings_status');
        statusElem.textContent = 'Loading settings...';
        statusElem.style.color = '#ff9800';
    }
}

function resetSettings() {
    if (confirm('This will delete all saved settings and use defaults on next restart. Continue?')) {
        let data = {
            id: "reset_settings"
        };
        
        let json = JSON.stringify(data);
        connection.send(json);
        console.log('Reset Settings: ' + json);
        
        const statusElem = document.getElementById('settings_status');
        statusElem.textContent = 'Resetting settings...';
        statusElem.style.color = '#f44336';
    }
}


function parseStatus(json)
{
  if (json.save=='1') save = true; else save=false;
  if (json.power=='1') power = true; else power=false;
  
  // Update target temperature display based on power state
  const tempDisplay = document.getElementById('target_temperature');
  const tempIcon = tempDisplay.previousElementSibling; // Get the thermostat icon
  
  if (json.power=='1') {
    // Power is ON - show target temperature
    tempDisplay.textContent = json.target_temperature;
    tempDisplay.nextSibling.textContent = '°C';
    tempIcon.textContent = 'thermostat';
    tempIcon.style.color = '#002F7A';
  } else {
    // Power is OFF - show power off status
    tempDisplay.textContent = 'OFF';
    tempDisplay.nextSibling.textContent = '';
    tempIcon.textContent = 'power_off';
    tempIcon.style.color = '#f44336';
  }
  
  //document.getElementById('target_temperature').textContent = json.target_temperature;
  document.getElementById('ac_sensor_temperature').textContent = json.ac_sensor_temperature;

  if (json.sensor_pressure !== undefined && document.getElementById('sensor_pressure')) {
    document.getElementById('sensor_pressure').textContent = json.sensor_pressure;
}
 
  if (json.sensor_humidity !== undefined && document.getElementById('sensor_humidity')) {
    document.getElementById('sensor_humidity').textContent = json.sensor_humidity;
}
  
    if (json.announce_state) {
        updateAnnounceStatusDisplay(json.announce_state);
    }

  if (json.discarded_msgs !== undefined) {
    document.getElementById('discarded_msgs').textContent = json.discarded_msgs;
  }

  if (json.decoded_msgs !== undefined) {
    document.getElementById('decoded_msgs').textContent = json.decoded_msgs;
  }
  
  // Calculate and display error ratio
  if (json.decoded_msgs !== undefined && json.discarded_msgs > 0) {
    const errorRatio = ((json.discarded_msgs / (json.discarded_msgs + json.decoded_msgs)) * 100).toFixed(2);
    document.getElementById('error_ratio').textContent = errorRatio + '%';
  } else {
    document.getElementById('error_ratio').textContent = '0%';
  }

  //display recovred messages
  if (json.recovered_msgs !== undefined) {
        document.getElementById('recovered_msgs').textContent = json.recovered_msgs;
 }

  document.getElementById('heap').textContent = json.heap;

  // Update status icons based on power state
  updateStatusIcons(json);

    
  //document.getElementById('timer_time').textContent = json.timer_time;
  document.getElementById('timer_pending').textContent = json.timer_pending;


  //reset color
  document.getElementById('fan_low').style.backgroundColor = button_released_color;
  document.getElementById('fan_medium').style.backgroundColor = button_released_color;
  document.getElementById('fan_high').style.backgroundColor = button_released_color;
  document.getElementById('fan_auto').style.backgroundColor = button_released_color;
 
  document.getElementById('mode_fan').style.backgroundColor = button_released_color;
  document.getElementById('mode_dry').style.backgroundColor = button_released_color;
  document.getElementById('mode_cool').style.backgroundColor = button_released_color;
  document.getElementById('mode_heat').style.backgroundColor = button_released_color;
  document.getElementById('mode_auto').style.backgroundColor = button_released_color;
  
  document.getElementById('power_on').style.backgroundColor = button_released_color;
  document.getElementById('power_off').style.backgroundColor = button_released_color;

  document.getElementById('save_button').style.backgroundColor = button_released_color;
  document.getElementById('save_button_compact').style.backgroundColor = button_released_color;

  document.getElementById('sw_set_timer_button').style.backgroundColor = button_released_color;
  

  //set color
  if (json.fan == 'LOW') { document.getElementById('fan_low').style.backgroundColor = button_pressed_color;}
  else if (json.fan == 'MED') { document.getElementById('fan_medium').style.backgroundColor = button_pressed_color; }
  else if (json.fan == 'HIGH') { document.getElementById('fan_high').style.backgroundColor = button_pressed_color; }
  else if (json.fan == 'AUTO') { document.getElementById('fan_auto').style.backgroundColor = button_pressed_color; }       
  
  if (json.mode == 'DRY') { document.getElementById('mode_dry').style.backgroundColor = button_pressed_color;}
  else if (json.mode == 'COOL') { document.getElementById('mode_cool').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'FAN') { document.getElementById('mode_fan').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'HEAT') { document.getElementById('mode_heat').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'AUTO') { document.getElementById('mode_auto').style.backgroundColor = button_pressed_color; }
    
  if (json.power == '1') { document.getElementById('power_on').style.backgroundColor = button_pressed_color;} 
  else { document.getElementById('power_off').style.backgroundColor = button_pressed_color;} 
  
  if (json.save == '1') { document.getElementById('save_button').style.backgroundColor = button_pressed_color;}
  if (json.save == '1') { document.getElementById('save_button_compact').style.backgroundColor = button_pressed_color;}
  
  if (json.timer_enabled =='1')   {
    document.getElementById('sw_set_timer_button').style.backgroundColor = button_pressed_color;
  }
  
    // Update timer status display
    const timerStatusElem = document.getElementById('timer_status');
    const timerPendingElem = document.getElementById('timer_pending');

    // Update timer_pending as before
    if (timerPendingElem) {
        timerPendingElem.textContent = json.timer_pending;
    }

    // Update timer_status based on timer state
    if (timerStatusElem) {
        if (json.timer_enabled){
        // Timer is active - show mode and pending time
        const timerMode = json.timer_mode == '1' ? 'ON' : 'OFF';
        timerStatusElem.textContent = `${timerMode} ${json.timer_pending} / ${json.timer_time} min`;
        } else {
        // Timer is not active - show nothing
        timerStatusElem.textContent = '';
        }
    }
  
    //reset color for fan button
document.getElementById('fan_speed_btn').style.backgroundColor = button_released_color;
updateFanSpeedButton(json.fan);

// Reset color for mode button
document.getElementById('mode_btn').style.backgroundColor = button_released_color;
updateModeButton(json.mode);

// Reset color for power button
document.getElementById('power_btn').style.backgroundColor = button_released_color;
updatePowerButton(json.power);
    
                                                                       
  var d = new Date(parseInt(json.boot_time*1000));
  document.getElementById('boot_time').innerHTML = d.toLocaleTimeString() + " " + d.toLocaleDateString()
  
  document.getElementById('compile_date').textContent = json.compile || '--';

  
  document.getElementById('ip').textContent = json.ip;  

   
    if (json.mqtt_config) {
        // Update the form fields with current configuration
        document.getElementById('mqtt_server').value = json.mqtt_config.server || '';
        document.getElementById('mqtt_port').value = json.mqtt_config.port || 1883;
        document.getElementById('mqtt_username').value = json.mqtt_config.username || '';
        document.getElementById('mqtt_password').value = json.mqtt_config.password || '';
        document.getElementById('mqtt_device_name').value = json.mqtt_config.device_name || '';
    }
    
    // Update MQTT status display
    if (json.mqtt !== undefined) {
        const statusElem = document.getElementById('mqtt_status');
        if (statusElem) {
            if (json.mqtt == true) {
                statusElem.textContent = 'Connected';
                statusElem.style.color = '#4caf50';
            } else {
                statusElem.textContent = 'Disconnected';
                statusElem.style.color = '#f44336';
            }
        }
    }


    // Update MQTT config display if available
    if (json.mqtt_config) {
        const serverElem = document.getElementById('mqtt_status_server');
        const deviceElem = document.getElementById('mqtt_status_device');
        
        if (serverElem && json.mqtt_config.server) {
            serverElem.textContent = json.mqtt_config.server + ':' + json.mqtt_config.port;
        }
        
        if (deviceElem && json.mqtt_config.device_name) {
            deviceElem.textContent = json.mqtt_config.device_name;
        }
        
        // Update form fields with current configuration
        document.getElementById('mqtt_server').value = json.mqtt_config.server || '';
        document.getElementById('mqtt_port').value = json.mqtt_config.port || 1883;
        document.getElementById('mqtt_username').value = json.mqtt_config.username || '';
        document.getElementById('mqtt_password').value = json.mqtt_config.password || '';
        document.getElementById('mqtt_device_name').value = json.mqtt_config.device_name || '';
    }
    

    // Update autonomous mode status
    if (json.autonomous !== undefined) {
        const statusElem = document.getElementById('autonomous_status');
        if (statusElem) {
        if (json.autonomous == true) {
            statusElem.textContent = 'Active';
            statusElem.style.color = '#4caf50';
        } else {
            statusElem.textContent = 'Disabled';
            statusElem.style.color = '#f44336';
        }
        }
    }

    // Update simulation mode status
    if (json.simulation_mode !== undefined) {
        const statusElem = document.getElementById('simulation_mode_status');
        if (statusElem) {
            if (json.simulation_mode == true) {
                statusElem.textContent = 'Enabled';
                statusElem.style.color = '#ff9800';
            } else {
                statusElem.textContent = 'Disabled';
                statusElem.style.color = '#6c757d';
            }
        }
    }

    // Update address displays
    if (json.master !== undefined) {
        document.getElementById('current_master').textContent = '0x' + json.master.toString(16).toUpperCase().padStart(2, '0');
    }
    if (json.remote !== undefined) {
        document.getElementById('current_remote').textContent = '0x' + json.remote.toString(16).toUpperCase().padStart(2, '0');
    }
    if (json.observed_master !== undefined) {
        const observedMasterElem = document.getElementById('observed_master');
        if (json.observed_master === 255) { // 0xFF means not detected yet
        observedMasterElem.textContent = '0x--';
        observedMasterElem.style.color = '#999';
        } else {
        observedMasterElem.textContent = '0x' + json.observed_master.toString(16).toUpperCase().padStart(2, '0');
        observedMasterElem.style.color = '#28a745';
        }
    }
    if (json.observed_remotes !== undefined && Array.isArray(json.observed_remotes)) {
        const observedRemotesElem = document.getElementById('observed_remotes');
        if (json.observed_remotes.length === 0) {
            observedRemotesElem.textContent = '0x--';
            observedRemotesElem.style.color = '#999';
        } else {
            observedRemotesElem.textContent = json.observed_remotes
                .map(val => '0x' + val.toString(16).toUpperCase().padStart(2, '0'))
                .join(', ');
            observedRemotesElem.style.color = '#28a745';
        }
    }
    if (json.id === "reset_observed_remotes") {
    console.log("Observed remotes cleared:", json.message);
    // Update UI to show empty observed remotes
    const observedRemotesElem = document.getElementById('observed_remotes');
    if (observedRemotesElem) {
        observedRemotesElem.textContent = '0x--';
        observedRemotesElem.style.color = '#999';
    }
}



  // Update Master Info section if data is available
  if (json.model_str !== undefined) {
    const modelElem = document.getElementById('master_model');
    if (modelElem) {
      modelElem.textContent = json.model_str || '--';
    }
  }

  if (json.temp_limit_min !== undefined && json.temp_limit_max !== undefined) {
    const limitsElem = document.getElementById('master_temp_limits');
    if (limitsElem) {
      limitsElem.textContent = `${json.temp_limit_min}°C - ${json.temp_limit_max}°C`;
    }
  }

  if (json.temp_frost_protection !== undefined) {
    const frostElem = document.getElementById('master_frost_protection');
    if (frostElem) {
      frostElem.textContent = `${json.temp_frost_protection}°C`;
    }
  }

  if (json.temp_default_auto !== undefined) {
    const autoElem = document.getElementById('master_setpoint_auto');
    if (autoElem) {
      autoElem.textContent = `${json.temp_default_auto}°C`;
    }
  }

  if (json.temp_default_heat !== undefined) {
    const heatElem = document.getElementById('master_setpoint_heat');
    if (heatElem) {
      heatElem.textContent = `${json.temp_default_heat}°C`;
    }
  }

  if (json.temp_default_dry !== undefined) {
    const dryElem = document.getElementById('master_setpoint_dry');
    if (dryElem) {
      dryElem.textContent = `${json.temp_default_dry}°C`;
    }
  }

  if (json.temp_default_cool !== undefined) {
    const coolElem = document.getElementById('master_setpoint_cool');
    if (coolElem) {
      coolElem.textContent = `${json.temp_default_cool}°C`;
    }
  }

    // Update Serial Configuration display
    if (json.tx_pin !== undefined) {
        document.getElementById('current_tx_pin').textContent = 'GPIO ' + json.tx_pin;
    }
    if (json.rx_pin !== undefined) {
        document.getElementById('current_rx_pin').textContent = 'GPIO ' + json.rx_pin;
    }
    if (json.rx_buffer_size !== undefined) {
        document.getElementById('current_rx_buffer_size').textContent = json.rx_buffer_size;
    }
  
    // Update I2C Configuration display
    if (json.sda_pin !== undefined) {
        const sdaElem = document.getElementById('current_sda_pin');
        if (sdaElem) {
            sdaElem.textContent = 'GPIO ' + json.sda_pin;
            
        }
    }
    if (json.scl_pin !== undefined) {
        const sclElem = document.getElementById('current_scl_pin');
        if (sclElem) {
            sclElem.textContent = 'GPIO ' + json.scl_pin;
        }
    }


} // end parseStatus

function getCommandTypeString(cmdType) {
    switch(cmdType) {
        case  0: return '[UNKNOWN]';
        case  1: return '[SENSOR_ERROR]';
        case  2: return '[STATUS]';
        case  3: return '[STATUS_EXT]';
        case  4: return '[MASTER_ACK]';
        case  5: return '[MASTER_ALIVE]';
        case  6: return '[STATUS_MODE]';
        case  7: return '[SENSOR_ANS]';
        case  8: return '[MODEL]';
        case  9: return '[TEMP_LIMITS]';
        case 10: return '[FEATURES]';
        case 11: return '[SETPOINT]';
        case 12: return '[DN_CODE]';
        case 13: return '[MASTER_BUSY]';
        case 14: return '[ANNOUNCE]';
        case 15: return '[SAVE_RATIO]';
        case 16: return '[SAVE_RATIO_ANSWER]';
        case 17: return '[TIME_COUNTER]';
        case 18: return '[DN_CODE_REQUEST]';
        case 19: return '[FAN_MODES_REQ]';
        case 20: return '[FAN_MODES_ANS]';
        case 21: return '[REMOTE_TEMP]';
        case 22: return '[REMOTE_PING]';
        case 23: return '[MASTER_PONG]';
        case 24: return '[MODEL_REQUEST]';
        case 25: return '[SETPOINT_REQUEST]';
        case 26: return '[TEMP_LIMITS_REQUEST]';
        case 27: return '[SENSOR_QUERY]';
        case 28: return '[POWER]';
        case 29: return '[SET_TEMP_FAN]';
        case 30: return '[SET_MODE]';
        case 31: return '[TIME_COUNTER_ANSWER]';
        default: return '[TYPE_' + cmdType + ']';
    }
}

function parseTXRXData(json) {
    // Only process if traffic capture is enabled
    const trafficCaptureCheckbox = document.getElementById('check_traffic_capture');
    if (trafficCaptureCheckbox && !trafficCaptureCheckbox.checked) {
        console.log('Traffic capture is disabled, skipping TXRX display');
        return;
    }

    debug_cmd_typed = document.getElementById('check_cmd_typed').checked;
    debug_cmd_timestamp = document.getElementById('check_cmd_timestamp').checked;
    debug_rx = document.getElementById('check_rx').checked;

    // Handle last_cmd
    if (json.last_cmd) {
        const lastCmdElem = document.getElementById('last_cmd');
        if (!lastCmdElem) {
            console.error('last_cmd element not found');
            return;
        }
        
        const currentText = lastCmdElem.textContent;
        
        // Add line break only if there's existing content
        const separator = (currentText.trim() !== '' && currentText !== '--') ? '<br>' : '';
        
        // Get current time in HH:MM:SS format if timestamp is enabled
        let timestamp = '';
        if (debug_cmd_timestamp) {
            const now = new Date();
            timestamp = '[' + now.toLocaleTimeString('default', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) + '] ';
        }
        
        if (debug_cmd_typed && json.last_cmd_type != undefined) {
            lastCmdElem.innerHTML += separator + timestamp + json.last_cmd_type_str + ' ' + json.last_cmd;
        } else {
            lastCmdElem.innerHTML += separator + timestamp + json.last_cmd;
        }
        
        // Auto-scroll to bottom
        lastCmdElem.scrollTop = lastCmdElem.scrollHeight;
    }

    // Handle rx_data with error highlighting
    if (debug_rx && json.rx_data) {
        const cmdlen = json.rx_data.length;
        if (cmdlen > 1) {
            const rxDataElem = document.getElementById('rx_data');
            if (!rxDataElem) {
                console.error('rx_data element not found');
                return;
            }
            
            const currentText = rxDataElem.textContent;
            
            // Add line break only if there's existing content
            const separator = (currentText.trim() !== '' && currentText !== '--') ? '<br>' : '';
            
            // Get current time in HH:MM:SS format if timestamp is enabled
            let timestamp = '';
            if (debug_cmd_timestamp) {
                const now = new Date();
                timestamp = '[' + now.toLocaleTimeString('default', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }) + '] ';
            }
            
            // Process rx_data to highlight errors
            let processedData = json.rx_data.replace(/<ERR>((.*?))<\/ERR>/g, 
                '<span style="background: #f44336; color: white; font-weight: bold; padding: 0 2px; border-radius: 2px;">$1</span>');
            
            // Process rx data to highlight recovered bytes
            processedData = processedData.replace(/<REC>((.*?))<\/REC>/g, 
                '<span style="background: #4caf50; color: white; font-weight: bold; padding: 0 2px; border-radius: 2px;">$1</span>');

            rxDataElem.innerHTML += separator + timestamp + processedData;
            
            // Auto-scroll to bottom
            rxDataElem.scrollTop = rxDataElem.scrollHeight;
        }
    }
}

// Add function to toggle traffic capture
function toggleTrafficCapture() {
    const checkbox = document.getElementById('check_traffic_capture');
    trafficCaptureEnabled = checkbox ? checkbox.checked : true;
    console.log('Traffic capture ' + (trafficCaptureEnabled ? 'enabled' : 'disabled'));
}

function parseMasterInfo(json) {
    console.log("Parsing master info:", json);
    
    if (json.model_str !== undefined) {
        const modelElem = document.getElementById('master_model');
        if (modelElem) {
            modelElem.textContent = json.model_str || '--';
        }
    }

    if (json.temp_limit_min !== undefined && json.temp_limit_max !== undefined) {
        const limitsElem = document.getElementById('master_temp_limits');
        if (limitsElem) {
            limitsElem.textContent = `${json.temp_limit_min}°C - ${json.temp_limit_max}°C`;
        }
    }

    if (json.temp_frost_protection !== undefined) {
        const frostElem = document.getElementById('master_frost_protection');
        if (frostElem) {
            frostElem.textContent = `${json.temp_frost_protection}°C`;
        }
    }

    // Update default setpoints
    if (json.temp_default_auto !== undefined) {
        const autoElem = document.getElementById('master_setpoint_auto');
        if (autoElem) autoElem.textContent = `${json.temp_default_auto}°C`;
    }

    if (json.temp_default_heat !== undefined) {
        const heatElem = document.getElementById('master_setpoint_heat');
        if (heatElem) heatElem.textContent = `${json.temp_default_heat}°C`;
    }

    if (json.temp_default_dry !== undefined) {
        const dryElem = document.getElementById('master_setpoint_dry');
        if (dryElem) dryElem.textContent = `${json.temp_default_dry}°C`;
    }

    if (json.temp_default_cool !== undefined) {
        const coolElem = document.getElementById('master_setpoint_cool');
        if (coolElem) coolElem.textContent = `${json.temp_default_cool}°C`;
    }
}

function parseSensorExplore(json) {
    if (json.status === "ignored") {
        console.log("Sensor explore ignored in simulation mode");
        return;
    }
    
    if (json.status === "valid" && json.value !== undefined && json.value !== -1) {
        const sensor_id = json.sensor_id;
        const value = json.value;
        
        console.log(`Sensor 0x${sensor_id.toString(16).toUpperCase().padStart(2, '0')}: value=${value}`);
        
        // Add to results table
        const table = document.getElementById('explore_sensor_results_table');
        if (table) {
            const row = table.insertRow(0); // Insert at top
            row.style.borderBottom = '1px solid #e9ecef';
            
            const idCell = row.insertCell(0);
            idCell.style.padding = '4px';
            idCell.style.fontFamily = 'monospace';
            idCell.innerHTML = '0x' + sensor_id.toString(16).toUpperCase().padStart(2, '0');
            
            const valueCell = row.insertCell(1);
            valueCell.style.padding = '4px';
            valueCell.style.fontFamily = 'monospace';
            valueCell.innerHTML = value;
            
            const descCell = row.insertCell(2);
            descCell.style.padding = '4px';
            descCell.style.fontSize = '11px';
            const description = sensorDescriptions[sensor_id] || 'Unknown';
            descCell.innerHTML = description;
        }
        
        // Show results container
        const container = document.getElementById('explore_sensor_results');
        if (container) container.style.display = 'block';
    } else if (json.value === -1) {
        console.log(`Sensor 0x${json.sensor_id.toString(16).toUpperCase().padStart(2, '0')}: No response or timeout`);
    }
}

function exploreSensor() {
    const input = document.getElementById('explore_sensor_input');
    const sensorStr = input.value.trim();
    
    if (!sensorStr) {
        alert('Please enter a hex sensor ID (00-FF)');
        return;
    }
    
    // Validate hex input
    if (!/^[0-9A-Fa-f]{1,2}$/.test(sensorStr)) {
        alert('Invalid hex sensor ID. Use format like 01, 07, 60, F2');
        return;
    }
    
    const sensor_id = parseInt(sensorStr, 16);
    if (sensor_id < 0 || sensor_id > 255) {
        alert('Sensor ID must be between 00 and FF');
        return;
    }
    
    console.log(`Exploring sensor 0x${sensor_id.toString(16).toUpperCase().padStart(2, '0')}`);
    
    // Send explore request
    let data = {
        id: "explore_sensor",
        sensor_id: sensor_id
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    
    // Visual feedback
    input.value = '';
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_empty</span> Exploring...';
    button.style.background = '#7b1fa2';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#9c27b0';
        button.disabled = false;
    }, 1000);
}

function exploreRangeSensors() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_empty</span> Exploring...';
    button.style.background = '#f57c00';
    
    console.log('Exploring sensors 0x00 to 0xFF');
    
    // Show results container
    const container = document.getElementById('explore_sensor_results');
    if (container) container.style.display = 'block';
    
    // Known sensor IDs to explore
    const knownSensors = [
        0x00, 0x01, 0x02, 0x03, 0x04, 0x07, 0xF2, 0xF3, 0xF8,
        0x60, 0x61, 0x62, 0x63, 0x65, 0x6A, 0x6D, 0x70, 0x72, 0x73,
        0xF0, 0xF1,
        0x74, 0x75, 0x76, 0x77, 0x78, 0x79
    ];
    
    let currentIndex = 0;
    
    function exploreNext() {
        if (currentIndex < knownSensors.length) {
            let data = {
                id: "explore_sensor",
                sensor_id: knownSensors[currentIndex]
            };
            connection.send(JSON.stringify(data));
            
            currentIndex++;
            setTimeout(exploreNext, 300); // 300ms delay between requests
        } else {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalText;
            button.style.background = '#ff9800';
        }
    }
    
    exploreNext();
}

function exploreFullRangeSensors() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_empty</span> Exploring...';
    button.style.background = '#e65100';
    
    console.log('Exploring all sensors 0x00 to 0xFF');
    
    // Show results container
    const container = document.getElementById('explore_sensor_results');
    if (container) container.style.display = 'block';
    
    let currentSensor = 0;
    const maxSensor = 0xFF;
    
    function exploreNext() {
        if (currentSensor <= maxSensor) {
            let data = {
                id: "explore_sensor",
                sensor_id: currentSensor
            };
            connection.send(JSON.stringify(data));
            
            currentSensor++;
            setTimeout(exploreNext, 300); // 300ms delay between requests
        } else {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalText;
            button.style.background = '#ff5722';
        }
    }
    
    exploreNext();
}

function clearExploreSensorResults() {
    const table = document.getElementById('explore_sensor_results_table');
    if (table) {
        table.innerHTML = '';
    }
    const container = document.getElementById('explore_sensor_results');
    if (container) {
        container.style.display = 'none';
    }
}

function parseSensors(json) {
    console.log("Parsing sensors:", json);
    
    // Indoor sensors
    if (json.indoor_room_temp !== undefined) {
        document.getElementById('indoor_room_temp').textContent = json.indoor_room_temp;
    }
    if (json.indoor_ta !== undefined) {
        document.getElementById('indoor_ta').textContent = json.indoor_ta;
    }
    if (json.indoor_tcj !== undefined) {
        document.getElementById('indoor_tcj').textContent = json.indoor_tcj;
    }
    if (json.indoor_tc !== undefined) {
        document.getElementById('indoor_tc').textContent = json.indoor_tc;
    }
    if (json.indoor_filter_time !== undefined) {
        document.getElementById('indoor_filter_time').textContent = json.indoor_filter_time;
    }
    if (json.indoor_fan_run_time !== undefined) {
        document.getElementById('indoor_fan_run_time').textContent = json.indoor_fan_run_time;
    }
    if (json.indoor_fan_speed !== undefined) {
        document.getElementById('indoor_fan_speed').textContent = json.indoor_fan_speed;
    }
    
    // Outdoor sensors
    if (json.outdoor_te !== undefined) {
        document.getElementById('outdoor_te').textContent = json.outdoor_te;
    }
    if (json.outdoor_to !== undefined) {
        document.getElementById('outdoor_to').textContent = json.outdoor_to;
    }
    if (json.outdoor_td !== undefined) {
        document.getElementById('outdoor_td').textContent = json.outdoor_td;
    }
    if (json.outdoor_ts !== undefined) {
        document.getElementById('outdoor_ts').textContent = json.outdoor_ts;
    }
    if (json.outdoor_ths !== undefined) {
        document.getElementById('outdoor_ths').textContent = json.outdoor_ths;
    }
    if (json.outdoor_current !== undefined) {
        document.getElementById('outdoor_current').textContent = json.outdoor_current;
    }
    if (json.outdoor_cumhour !== undefined) {
        document.getElementById('outdoor_cumhour').textContent = json.outdoor_cumhour;
    }
    if (json.outdoor_tl !== undefined) {
        document.getElementById('outdoor_tl').textContent = json.outdoor_tl;
    }
    if (json.outdoor_comp_freq !== undefined) {
        document.getElementById('outdoor_comp_freq').textContent = json.outdoor_comp_freq;
    }
    if (json.outdoor_lower_fan_speed !== undefined) {
        document.getElementById('outdoor_lower_fan_speed').textContent = json.outdoor_lower_fan_speed;
    }
    if (json.outdoor_upper_fan_speed !== undefined) {
        document.getElementById('outdoor_upper_fan_speed').textContent = json.outdoor_upper_fan_speed;
    }
}

function parseAddresses(json) {
    console.log("Parsing addresses:", json);
    
    if (json.master !== undefined) {
        document.getElementById('current_master').textContent = 
            '0x' + json.master.toString(16).toUpperCase().padStart(2, '0');
    }
    
    if (json.remote !== undefined) {
        document.getElementById('current_remote').textContent = 
            '0x' + json.remote.toString(16).toUpperCase().padStart(2, '0');
    }
    
    if (json.observed_master !== undefined) {
        const observedMasterElem = document.getElementById('observed_master');
        if (json.observed_master === 255) { // 0xFF means not detected yet
            observedMasterElem.textContent = '0x--';
            observedMasterElem.style.color = '#999';
        } else {
            observedMasterElem.textContent = 
                '0x' + json.observed_master.toString(16).toUpperCase().padStart(2, '0');
            observedMasterElem.style.color = '#28a745';
        }
    }
    
    if (json.observed_remotes !== undefined && Array.isArray(json.observed_remotes)) {
        const observedRemotesElem = document.getElementById('observed_remotes');
        if (json.observed_remotes.length === 0) {
            observedRemotesElem.textContent = '0x--';
            observedRemotesElem.style.color = '#999';
        } else {
            observedRemotesElem.textContent = json.observed_remotes
                .map(val => '0x' + val.toString(16).toUpperCase().padStart(2, '0'))
                .join(', ');
            observedRemotesElem.style.color = '#28a745';
        }
    }
}

function parseSystemInfo(json) {
    console.log("Parsing system info:", json);
    
    if (json.boot_time !== undefined) {
        var d = new Date(parseInt(json.boot_time * 1000));
        document.getElementById('boot_time').innerHTML = 
            d.toLocaleTimeString() + " " + d.toLocaleDateString();
    }
    
    if (json.heap !== undefined) {
        document.getElementById('heap').textContent = json.heap;
    }
    
    if (json.compile !== undefined) {
        // You can add a compile info element if needed
        console.log("Compile date:", json.compile);
    }
    
    if (json.ip !== undefined) {
        document.getElementById('ip').textContent = json.ip;
    }

    if (json.discarded_msgs !== undefined) {
        document.getElementById('discarded_msgs').textContent = json.discarded_msgs;
    }

    if (json.decoded_msgs !== undefined) {
        document.getElementById('decoded_msgs').textContent = json.decoded_msgs;
    }
        
    if (json.decoded_msgs !== undefined && json.decoded_msgs > 0) {
        const errorRatio = ((json.discarded_msgs / json.decoded_msgs) * 100).toFixed(2);
        document.getElementById('error_ratio').textContent = errorRatio + '%';
    }

}

function enableMQTT() {
    let data = {
        id: "mqtt_enable",
        value: true
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Enable MQTT: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Enabling...';
    button.style.background = '#ff9800';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#4caf50';
    }, 2000);
}

function disableMQTT() {    
    let data = {
        id: "mqtt_enable",
        value: false
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Disable MQTT: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Disabling...';
    button.style.background = '#ff9800';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#f44336';
    }, 2000);
}

function parseMQTTResponse(json) {
    if (json.id === "mqtt_enable") {
        if (json.status === "enabled") {
            console.log('MQTT enabled successfully');
            // Update status display
            const statusElem = document.getElementById('mqtt_status');
            if (statusElem) {
                statusElem.textContent = json.mqtt_status ? 'Connected' : 'Disconnected';
                statusElem.style.color = json.mqtt_status ? '#4caf50' : '#f44336';
            }
        } else if (json.status === "disabled") {
            console.log('MQTT disabled successfully');
            // Update status display
            const statusElem = document.getElementById('mqtt_status');
            if (statusElem) {
                statusElem.textContent = 'Disabled';
                statusElem.style.color = '#999';
            }
        }
    }

    if (json.id === "mqtt_config") {
        if (json.status === "saved") {
            alert('MQTT configuration saved successfully!');
        } else if (json.status === "error") {
            alert('Error saving MQTT configuration: ' + (json.message || 'Unknown error'));
        }
    }
    
    if (json.id === "mqtt_test") {
        if (json.status === "connected") {
            alert('MQTT connection test successful!');
        } else if (json.status === "failed") {
            alert('MQTT connection test failed: ' + (json.message || 'Unknown error'));
        }
    }
        
    if (json.id === "mqtt_discovery") {
        if (json.status === "sent") {
            alert('Discovery messages sent to Home Assistant!');
        } else if (json.status === "reset") {
            alert('Discovery messages reset. Device removed from Home Assistant.');
        }
    }
}

function requestMasterInfo() {
    let data = {
        id: "master_info"
    };        
    connection.send(JSON.stringify(data));
    console.log('Request Master Info sent');

    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">hourglass_empty</span> Requesting...';
    button.style.background = '#ff9800';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#007bff';
        button.disabled = false;
    }, 2000);
}

function requestSensors() {
    let data = {
        id: "sensors"
    };
    connection.send(JSON.stringify(data));
    console.log('Request Sensors sent');
}

function requestAddresses() {
    let data = {
        id: "addresses"
    };
    connection.send(JSON.stringify(data));
    console.log('Request Addresses sent');
}

function requestSystemInfo() {
    let data = {
        id: "system_info"
    };
    connection.send(JSON.stringify(data));
    console.log('Request System Info sent');
}

// Function to update status icons
function updateStatusIcons(json) {
    const statusIconsContainer = document.getElementById('status-icons');
    
    // Declare all icon variables at the beginning with default values
    let modeIcon = '';
    let fanIcon = '';
    let flagsIcon = '';
    let timerIcon = '';
    let mqttIcon = '';
    let simulationModeIcon = '';
    
    // Add MQTT status icon
    if (json.mqtt !== undefined) {
        if (json.mqtt == true) {
            mqttIcon = ' <span class="material-icons" style="color:#4caf50;" title="MQTT Connected">home</span>';
        } else {
            mqttIcon = ' <span class="material-icons" style="color:#f44336;" title="MQTT Disconnected">home</span>';
        }
    }

    // Simulation Mode status icon
    if (json.simulation_mode !== undefined && json.simulation_mode == true) {
        simulationModeIcon = ' <span class="material-symbols-outlined" style="color:#ff9800;" title="Simulation Mode Active">computer</span>';
    }
    
    if (json.power == '1') {
        // Power is ON - show mode and fan icons
        
        // Mode icons
        switch(json.mode) {
            case 'COOL':
                modeIcon = '<span class="material-icons" style="color:#2196f3;" title="Cool">ac_unit</span>';
                break;
            case 'HEAT':
                modeIcon = '<span class="material-symbols-outlined" style="color:#ff9800;" title="Heat">sunny</span>';
                break;
            case 'DRY':
                modeIcon = '<span class="material-icons" style="color:#795548;" title="Dry">opacity</span>';
                break;
            case 'FAN':
                modeIcon = '<span class="material-symbols-outlined" style="color:#4caf50;" title="Fan">mode_fan</span>';
                break;
            case 'AUTO':
                modeIcon = '<span class="material-icons" style="color:#9c27b0;" title="Auto">hdr_auto</span>';
                break;
            default:
                modeIcon = '<span class="material-icons" style="color:#9e9e9e;" title="Unknown">help_outline</span>';
        }
        
        // Fan speed icons - different icons for each speed
        // Using density icons for fan speeds may seem counterintuitive because they are inversely related
        switch(json.fan) {
            case 'LOW':
                fanIcon = '<span class="material-icons" style="color:#4caf50;" title="Low">density_large</span>';
                break;
            case 'MED':
                fanIcon = '<span class="material-icons" style="color:#ff9800;" title="Medium">density_medium</span>';
                break;
            case 'HIGH':
                fanIcon = '<span class="material-icons" style="color:#f44336;" title="High">density_small</span>';
                break;
            case 'AUTO':
                fanIcon = '<span class="material-icons" style="color:#2196f3;" title="Auto">hdr_auto</span>';
                break;
            default:
                fanIcon = '<span class="material-icons" style="color:#9e9e9e;" title="Unknown">question_mark</span>';
        }
        
        // Timer icon if timer is enabled
        if (json.timer_enabled == '1') {
            const timerMode = json.timer_mode == '1' ? 'on' : 'off';
            const timerColor = timerMode === 'on' ? '#4caf50' : '#f44336';
            const pendingTime = json.timer_pending || '0';
            
            timerIcon = ` <span class="material-icons" style="color:${timerColor};" title="Timer ${timerMode.toUpperCase()}: ${pendingTime} min remaining">timer</span><span style="color:${timerColor}; font-size:10px; margin-left:2px;">${pendingTime}</span>`;
        }

        // add save icon if save is enabled and use a green color
        if (json.save == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#4caf50;" title="Save">energy_savings_leaf</span>';
        }

        // add filter alert icon if json.filter_alert exists and is 1
        if (json.filter_alert == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#f44336;" title="Filter">grid_on</span>';
        }

        //add preheat icon if json.preheat exists and is 1
        if (json.preheat == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#ff9800;" title="Pre-Heat">fireplace</span>';
        }

        statusIconsContainer.innerHTML = flagsIcon + ' ' + modeIcon + ' ' + fanIcon + mqttIcon + simulationModeIcon + timerIcon;
    } else {
        // Power is OFF - show only power off icon and timer if enabled
        if (json.timer_enabled == '1') {
            const timerMode = json.timer_mode == '1' ? 'on' : 'off';
            const timerColor = timerMode === 'on' ? '#4caf50' : '#f44336';
            const pendingTime = json.timer_pending || '0';
            
            timerIcon = ` <span class="material-icons" style="color:${timerColor};" title="Timer ${timerMode.toUpperCase()}: ${pendingTime} min">timer</span>`;
        }
                
        statusIconsContainer.innerHTML = '<span class="material-icons" style="color:#f44336;" title="Off">power_off</span>' + mqttIcon + simulationModeIcon + timerIcon;
    }
}

// Helper function to send command and request status
function sendRequestStatus() {
    //let json = JSON.stringify(data);
    //connection.send(json);
    //console.log('Send: ' + json);
    
    // Request status update after a short delay to allow command processing
    setTimeout(() => {
        let statusData = {
            id: "status",
            //value: new Date().getHours() + ":" + new Date().getMinutes() + ":" + new Date().getSeconds()
            value: new Date().toLocaleTimeString('default', { hour12: false }) + " - event"
            

        };
        let statusJson = JSON.stringify(statusData);
        connection.send(statusJson);
        console.log('Event status request: ' + statusJson);
    }, 800); // 100ms delay
}


function power_on() {
    let data = {
       id : "power",
       value : "on"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('power_on').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function power_off() {
    let data = {
       id : "power",
       value : "off"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('power_off').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function save_toggle() {
	var save_value;
	if (save) save_value = "0"; else save_value = "1";	
    let data = {
       id : "save",
       value : save_value
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);

    //if save_value is 1 use button_pressed_color, else button_released_color
    if (save_value == "1") {
        document.getElementById('save_button').style.backgroundColor = button_pressed_color;
    } else {
        document.getElementById('save_button').style.backgroundColor = button_released_color;
    }

    if (save_value == "1") {
        document.getElementById('save_button_compact').style.backgroundColor = button_pressed_color;
    } else {
        document.getElementById('save_button_compact').style.backgroundColor = button_released_color;
    }
    
    sendRequestStatus();
}

function mode_fan() {
    let data = {
       id : "mode",
       value : "fan"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_fan').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function mode_dry() {
    let data = {
       id : "mode",
       value : "dry"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_dry').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function mode_cool() {
    let data = {
       id : "mode",
       value : "cool"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_cool').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function mode_heat() {
    let data = {
       id : "mode",
       value : "heat"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_heat').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function mode_auto() {
    let data = {
       id : "mode",
       value : "auto"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_auto').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function fan_low() {
    let data = {
       id : "fan",
       value : "low"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_low').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function fan_medium() {
    let data = {
       id : "fan",
       value : "medium"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_medium').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function fan_high() {
    let data = {
       id : "fan",
       value : "high"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_high').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function fan_auto() {
    let data = {
       id : "fan",
       value : "auto"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_auto').style.backgroundColor = button_pressed_color;
    sendRequestStatus();
}

function temp_plus() {
    let data = {
       id : "temp",
       temp : "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    sendRequestStatus();
}

function temp_minus() {
    let data = {
       id : "temp",
       temp : "0"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json); 
    sendRequestStatus();
}

function timer_changed() {
	document.getElementById('timer_time').textContent  = document.getElementById('timer_range').value;
}

function setTimerValue(minutes) {
    // Defensive: only update if elements exist
    var timerTimeElem = document.getElementById('timer_time');
    if (timerTimeElem) timerTimeElem.textContent = minutes;

    // Remove active class from timer duration buttons only (not mode buttons)
    const timerDurationBtns = document.querySelectorAll('.timer-btn:not(#timer_mode_off):not(#timer_mode_on)');
    timerDurationBtns.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#00878f';
        btn.style.color = '#fff';
    });

    // Add active class to clicked button (only if event and event.target exist and it's a duration button)
    if (window.event && window.event.target && window.event.target.classList.contains('timer-btn') && 
        window.event.target.id !== 'timer_mode_off' && window.event.target.id !== 'timer_mode_on') {
        window.event.target.classList.add('active');
        window.event.target.style.background = '#ffbe0b';
        window.event.target.style.color = '#002F7A';
    }
}

function adjustTimer(delta) {
    const currentValue = parseInt(document.getElementById('timer_time').textContent);
    let newValue = currentValue + delta;
    
    // Keep within reasonable bounds (0 to 120 minutes)
    newValue = Math.max(0, Math.min(120, newValue));
    
    document.getElementById('timer_time').textContent = newValue;
    
    // Remove active state from preset duration buttons only (not mode buttons)
    const timerDurationBtns = document.querySelectorAll('.timer-btn:not(#timer_mode_off):not(#timer_mode_on)');
    timerDurationBtns.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#00878f';
        btn.style.color = '#fff';
    });
}

function toggleTimerControls() {
    const timerControls = document.getElementById('timer-controls');
    const timerIcon = document.querySelector('[onclick="toggleTimerControls()"]');
    
    if (timerControls.style.display === 'none') {
        timerControls.style.display = 'block';
        // Mark as expanded with border and shadow
        timerIcon.style.border = '2px solid #002F7A';
        timerIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        timerControls.style.display = 'none';
        // Mark as collapsed
        timerIcon.style.border = '2px solid #e9ecef';
        timerIcon.style.boxShadow = 'none';
    }
}


function setTimerMode(mode) {
    const offBtn = document.getElementById('timer_mode_off');
    const onBtn = document.getElementById('timer_mode_on');
    
    // Reset both buttons
    offBtn.style.background = '#00878f';
    offBtn.style.color = '#fff';
    onBtn.style.background = '#00878f';
    onBtn.style.color = '#fff';
    
    // Set active button
    if (mode === 'off') {
        offBtn.style.background = '#ffbe0b';
        offBtn.style.color = '#002F7A';        
    } else {
        onBtn.style.background = '#ffbe0b';
        onBtn.style.color = '#002F7A';        
    }
}

// Enhanced fan speed cycling with prev/next indicators
function cycleFanSpeed() {
    // Move to next fan speed
    currentFanSpeedIndex = (currentFanSpeedIndex + 1) % fanSpeedStates.length;
    
    var currentState = fanSpeedStates[currentFanSpeedIndex];
    
    // Update current fan speed display
    document.getElementById('fan_speed_icon').textContent = currentState.icon;
    document.getElementById('fan_speed_text').textContent = currentState.text;
    document.getElementById('fan_speed_btn').style.backgroundColor = button_pressed_color;
    
    // Update prev/next indicators
    updateFanSpeedIndicators();
    
    // Send the command
    let data = {
       id : "fan",
       value : currentState.value
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    sendRequestStatus();
}

// New function to update prev/next fan speed indicators
function updateFanSpeedIndicators() {
    const prevIndex = (currentFanSpeedIndex - 1 + fanSpeedStates.length) % fanSpeedStates.length;
    const nextIndex = (currentFanSpeedIndex + 1) % fanSpeedStates.length;
    
    const prevState = fanSpeedStates[prevIndex];
    const nextState = fanSpeedStates[nextIndex];
    
    // Update previous fan speed indicator
    document.getElementById('fan_prev_icon').textContent = prevState.icon;
    document.getElementById('fan_prev_text').textContent = prevState.text;
    
    // Update next fan speed indicator
    document.getElementById('fan_next_icon').textContent = nextState.icon;
    document.getElementById('fan_next_text').textContent = nextState.text;
}

// Enhanced updateFanSpeedButton function
function updateFanSpeedButton(fanMode) {
    // Add validation to prevent errors on startup
    if (!fanMode || fanMode === undefined || fanMode === null) {
        console.log('Fan mode not yet available');
        return;
    }

    // Defensive check: ensure fanSpeedStates is initialized
    if (!fanSpeedStates || !Array.isArray(fanSpeedStates) || fanSpeedStates.length === 0) {
        console.error('fanSpeedStates not initialized');
        return;
    }
        
    // Find the current fan mode index
    var index = fanSpeedStates.findIndex(state => 
        state.value === fanMode.toLowerCase() || 
        (fanMode === 'MED' && state.value === 'medium')
    );
    
    if (index !== -1) {
        currentFanSpeedIndex = index;
        var currentState = fanSpeedStates[currentFanSpeedIndex];
        
        // Update current fan speed
        document.getElementById('fan_speed_icon').textContent = currentState.icon;
        document.getElementById('fan_speed_text').textContent = currentState.text;
        document.getElementById('fan_speed_btn').style.backgroundColor = button_pressed_color;
        
        // Update prev/next indicators
        updateFanSpeedIndicators();
    } else {
        // Reset to default if unknown
        document.getElementById('fan_speed_btn').style.backgroundColor = button_released_color;
    }
}

// Enhanced mode cycling with prev/next indicators
function cycleMode() {
    // Move to next mode
    currentModeIndex = (currentModeIndex + 1) % modeStates.length;
    
    var currentState = modeStates[currentModeIndex];
    
    // Update current mode display
    document.getElementById('mode_icon').textContent = currentState.icon;
    document.getElementById('mode_text').textContent = currentState.text;
    document.getElementById('mode_btn').style.backgroundColor = button_pressed_color;
    
    // Update prev/next indicators
    updateModeIndicators();
    
    // Send the command
    let data = {
       id : "mode",
       value : currentState.value
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    sendRequestStatus();
}

// New function to update prev/next mode indicators
function updateModeIndicators() {
    const prevIndex = (currentModeIndex - 1 + modeStates.length) % modeStates.length;
    const nextIndex = (currentModeIndex + 1) % modeStates.length;
    
    const prevState = modeStates[prevIndex];
    const nextState = modeStates[nextIndex];
    
    // Update previous mode indicator
    document.getElementById('mode_prev_icon').textContent = prevState.icon;
    document.getElementById('mode_prev_text').textContent = prevState.text;
    
    // Update next mode indicator
    document.getElementById('mode_next_icon').textContent = nextState.icon;
    document.getElementById('mode_next_text').textContent = nextState.text;
}

// Enhanced updateModeButton function
function updateModeButton(mode) {
    // Add validation to prevent errors on startup
    if (!mode || mode === undefined || mode === null) {
        console.log('Mode not yet available');
        return;
    }

    // Find the current mode index
    var index = modeStates.findIndex(state => 
        state.value === mode.toLowerCase()
    );
    
    if (index !== -1) {
        currentModeIndex = index;
        var currentState = modeStates[currentModeIndex];
        
        // Update current mode
        document.getElementById('mode_icon').textContent = currentState.icon;
        document.getElementById('mode_text').textContent = currentState.text;
        document.getElementById('mode_btn').style.backgroundColor = button_pressed_color;
        
        // Update prev/next indicators
        updateModeIndicators();
    } else {
        // Reset to default if unknown
        document.getElementById('mode_btn').style.backgroundColor = button_released_color;
    }
}

function cyclePower() {
    // Move to next power state
    currentPowerIndex = (currentPowerIndex + 1) % powerStates.length;
    
    var currentState = powerStates[currentPowerIndex];
    
    // Update button appearance
    document.getElementById('power_icon').textContent = currentState.icon;
    document.getElementById('power_text').textContent = currentState.text;
    document.getElementById('power_btn').style.backgroundColor = button_pressed_color;
    
    // Send the command
    let data = {
       id : "power",
       value : currentState.value
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    sendRequestStatus(data);
}

// Update function to handle the single power button
function updatePowerButton(power) {
    // Add validation to prevent errors on startup
    if (power === undefined || power === null) {
        console.log('Power state not yet available');
        return;
    }

    // Find the current power state index
    var index = powerStates.findIndex(state => 
        (power == '1' && state.value === 'on') || (power == '0' && state.value === 'off')
    );
    
    if (index !== -1) {
        currentPowerIndex = index;
        var currentState = powerStates[currentPowerIndex];
        
        document.getElementById('power_icon').textContent = currentState.icon;
        document.getElementById('power_text').textContent = currentState.text;
        document.getElementById('power_btn').style.backgroundColor = button_pressed_color;
    } else {
        // Reset to default if unknown
        document.getElementById('power_btn').style.backgroundColor = button_released_color;
    }
}

function toggleDebugControls() {
    const debugControls = document.getElementById('debug-controls');
    const debugIcon = document.querySelector('[onclick="toggleDebugControls()"]');
    
    if (debugControls.style.display === 'none') {
        debugControls.style.display = 'block';
        debugIcon.style.border = '2px solid #002F7A';
        debugIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        debugControls.style.display = 'none';
        debugIcon.style.border = '2px solid #e9ecef';
        debugIcon.style.boxShadow = 'none';
    }
}

function toggleCollapse(section) {
    const body = document.getElementById(section + '_body');
    const icon = document.getElementById(section + '_icon');
    if (!body || !icon) return;
    const hidden = body.style.display === 'none';
    body.style.display = hidden ? 'grid' : 'none';
    icon.textContent = hidden ? 'expand_less' : 'expand_more';
}

function reset_sw_air_timer(){	
    let data = {
       id : "timer",
       timer_mode : 2,  //TIMER_SW_OFF 0, TIMER_SW_ON  1, TIMER_SW_RESET  2
       timer_time : "0"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('sw_set_timer_button').style.backgroundColor = button_released_color;

    sendRequestStatus();
}

// Add this variable at the top with other global variables
var currentTimerMode = 'off'; // Default to 'off'

// Update the setTimerMode function

function setTimerMode(mode) {
    currentTimerMode = mode; // Store the current mode
    
    const offBtn = document.getElementById('timer_mode_off');
    const onBtn = document.getElementById('timer_mode_on');
    
    // Reset both buttons
    offBtn.style.background = '#00878f';
    offBtn.style.color = '#fff';
    onBtn.style.background = '#00878f';
    onBtn.style.color = '#fff';
    
    // Set active button
    if (mode === 'off') {
        offBtn.style.background = '#ffbe0b';
        offBtn.style.color = '#002F7A';        
    } else {
        onBtn.style.background = '#ffbe0b';
        onBtn.style.color = '#002F7A';        
    }
}

// Update the set_sw_air_timer function
function set_sw_air_timer(){
    const timerTime = document.getElementById('timer_time').textContent;
    const val = currentTimerMode === 'off' ? 0 : 1;
    
    let data = {
       id : "timer",
       timer_mode : val, //TIMER_SW_OFF 0, TIMER_SW_ON  1, TIMER_SW_RESET  2
       timer_time : timerTime
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json); 

    sendRequestStatus();
}

function timer_hw_cancel() {
    let data = {
       id : "timer_hw",
       value : "cancel",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_off() {
    let data = {
       id : "timer_hw",
       value : "off",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_pressed_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_repeat_off() {
    let data = {
       id : "timer_hw",
       value : "repeat_off",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_pressed_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_on() {
    let data = {
       id : "timer_hw",
       value : "on",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_pressed_color;
}

//time series request
function getTimeseries() {
    let data = {
       id : "timeseries",
       value : "all"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
}

function set_sampling() {
    let data = {
       id : "sampling",
       value : parseInt(document.getElementById('sampling_text').value)
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
}

function showGraph()
{
    
    var ctx = document.getElementById("temperature_chart").getContext('2d');
    
    // Color palette - Chart.js 4.x compatible
    const colors = {
        primary: '#3B82F6',      // Blue
        secondary: '#10B981',    // Green
        accent: '#F59E0B',       // Amber
        danger: '#EF4444',       // Red
        purple: '#8B5CF6',       // Purple
        background: '#F8FAFC',   // Light gray
        text: '#1F2937'          // Dark gray
    };
    
    var config={
        type: 'line',
        data: {
            labels: ['Loading...'],
            datasets: [{
                label: 'AC Sensor',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.danger,
                borderColor: colors.danger,
                borderWidth: 2,
                pointRadius: 0,//3,
                pointHoverRadius: 4,//5,
                pointBackgroundColor: colors.danger,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.2,
                data: [],
            },{
                label: 'Room Temperature',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 2,
                pointRadius: 0,//3,
                pointHoverRadius: 4,//5,
                pointBackgroundColor: colors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.2,
                data: [],
            },{
                label: 'Room Humidity',
                yAxisID: 'humidity',
                fill: false,
                backgroundColor: colors.secondary,
                borderColor: colors.secondary,
                borderWidth: 2,
                pointRadius: 0,//3,
                pointHoverRadius: 4,//5,
                pointBackgroundColor: colors.secondary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.2,
                data: [],
            },{
                label: 'Pressure',
                yAxisID: 'pressure',
                fill: false,
                backgroundColor: colors.purple,
                borderColor: colors.purple,
                borderWidth: 2,
                pointRadius: 0,//3,
                pointHoverRadius: 4,//5,
                pointBackgroundColor: colors.purple,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.2,
                data: [],
            },{
                label: 'External Temp',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.accent,
                borderColor: colors.accent,
                borderWidth: 2,
                pointRadius: 0,//3,
                pointHoverRadius: 4,//5,
                pointBackgroundColor: colors.accent,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.2,
                data: [],
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: "Temperature & Humidity Chart",
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: colors.text,
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 15,
                        font: {
                            size: 12
                        },
                        color: colors.text
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: colors.text,
                    bodyColor: colors.text,
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.dataset.yAxisID === 'temperature') {
                                    label += context.parsed.y + '°C';
                                } else if (context.dataset.yAxisID === 'humidity') {
                                    label += context.parsed.y + '%';
                                } else if (context.dataset.yAxisID === 'pressure') {
                                    label += context.parsed.y + ' mb';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        color: '#F3F4F6',
                        drawBorder: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        maxTicksLimit: 8
                    }
                },
                temperature: {
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 36,
                    title: {
                        display: true,
                        text: 'Temperature (°C)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        color: '#F3F4F6',
                        drawBorder: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                },
                humidity: {
                    type: 'linear',
                    position: 'right',
                    min: 35,
                    max: 80,
                    title: {
                        display: true,
                        text: 'Humidity (%)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                pressure: {
                    type: 'linear',
                    position: 'right',
                    min: 950,
                    max: 1050,
                    display: false, // Hide by default, show when pressure data is available
                    title: {
                        display: true,
                        text: 'Pressure (mb)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + ' mb';
                        }
                    }
                }
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            elements: {
                point: {
                    hoverBorderWidth: 3
                }
            }
        }
    };

    // Create chart
    chart_obj = new Chart(ctx, config);
    //window.chart_obj_modern = chart_obj; // Point to the same chart instance    
}

function toggleGraphControls() {
    const graphControls = document.getElementById('graph-controls');
    const graphIcon = document.querySelector('[onclick="toggleGraphControls()"]');
    
    if (graphControls.style.display === 'none') {
        graphControls.style.display = 'block';
        graphIcon.style.border = '2px solid #002F7A';
        graphIcon.style.boxShadow = '0 2px 8px #002F7A44';
        
        // Initialize chart if needed
        if (!chart_obj) {
            console.log('Creating chart...');
            showGraph();
        } else {
            console.log('Chart already exists, updating ranges...');
            updateChartRanges();
        }
    } else {
        graphControls.style.display = 'none';
        graphIcon.style.border = '2px solid #e9ecef';
        graphIcon.style.boxShadow = 'none';
    }
}

function updateChartRanges() {
    if (!window.chart_obj) return;
    
    //console.log('Updating chart ranges...');
    
    // Get current data from all datasets
    const datasets = window.chart_obj.data.datasets;
    let tempValues = [];
    let humidityValues = [];
    let pressureValues = [];
    
    // Debug: log datasets info
    //console.log('Chart datasets:', datasets.length);
    
    // Collect all temperature values (datasets 0, 1, 4 - AC Sensor, Room Temp, External Temp)
    datasets.forEach((dataset, index) => {
        if (dataset && dataset.data && Array.isArray(dataset.data)) {
            //console.log(`Dataset ${index} (${dataset.label}):`, dataset.data.slice(0, 10), '... length:', dataset.data.length);
            
            if (dataset.yAxisID === 'temperature') {
                // Filter valid temperature values (between -20 and 60)
                const validTemps = dataset.data.filter(v => typeof v === 'number' && v > -20 && v < 60 && v !== 0);
                tempValues = tempValues.concat(validTemps);
                //console.log(`Added ${validTemps.length} temperature values from ${dataset.label}`);
            } else if (dataset.yAxisID === 'humidity') {
                // Filter valid humidity values (between 0 and 100)
                const validHumidity = dataset.data.filter(v => typeof v === 'number' && v > 0 && v <= 100);
                humidityValues = humidityValues.concat(validHumidity);
                //console.log(`Added ${validHumidity.length} humidity values from ${dataset.label}`);
            } else if (dataset.yAxisID === 'pressure') {
                // Filter valid pressure values (between 800 and 1200)
                const validPressure = dataset.data.filter(v => typeof v === 'number' && v > 800 && v < 1200);
                pressureValues = pressureValues.concat(validPressure);
                //console.log(`Added ${validPressure.length} pressure values from ${dataset.label}`);
            }
        }
    });
    
    //console.log('Collected values:');
    //console.log('Temperature values:', tempValues.length, tempValues.slice(0, 10));
    //console.log('Humidity values:', humidityValues.length, humidityValues.slice(0, 10));
    //console.log('Pressure values:', pressureValues.length, pressureValues.slice(0, 10));
    
    // Calculate adaptive ranges with 10% margin
    function calculateRange(values, defaultMin, defaultMax) {
        if (values.length === 0) {
            //console.log('No values, using defaults:', defaultMin, defaultMax);
            return { min: defaultMin, max: defaultMax };
        }
        
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min;
        const margin = Math.max(range * 0.1, 1); // At least 1 unit margin
        
        const newMin = Math.max(0, Math.floor(min - margin));
        const newMax = Math.ceil(max + margin);
        
        //console.log(`Range calculation: min=${min}, max=${max}, range=${range}, margin=${margin}, newMin=${newMin}, newMax=${newMax}`);
        
        return {
            min: newMin,
            max: newMax
        };
    }
    
    const tempRange = calculateRange(tempValues, 0, 36);
    const humidityRange = calculateRange(humidityValues, 35, 80);
    const pressureRange = calculateRange(pressureValues, 950, 1050);
    
    //console.log('Calculated ranges:');
    //console.log('Temperature:', tempRange);
    //console.log('Humidity:', humidityRange);
    //console.log('Pressure:', pressureRange);
    
    // Update chart scales
    if (window.chart_obj.options.scales.temperature) {
        window.chart_obj.options.scales.temperature.min = tempRange.min;
        window.chart_obj.options.scales.temperature.max = tempRange.max;
    }
    if (window.chart_obj.options.scales.humidity) {
        window.chart_obj.options.scales.humidity.min = humidityRange.min;
        window.chart_obj.options.scales.humidity.max = humidityRange.max;
    }
    if (window.chart_obj.options.scales.pressure) {
        window.chart_obj.options.scales.pressure.min = pressureRange.min;
        window.chart_obj.options.scales.pressure.max = pressureRange.max;
    }
    
    // Force chart update
    chart_obj.update();
}
 
//check for time labeling
//https://www.chartjs.org/samples/latest/scales/time/line.html

function getMinNoZero(data){
    let min = 9999999;
    let datalen = data.length;
    for(let i = 0; i < datalen; i++){
        // Ignore null and only consider numbers
        if (data[i] !== null && typeof data[i] === 'number' && data[i] < min && data[i] !== 0){
            min = data[i];
        }
    }
    if (min == 9999999) min = 0; // all zeroes or invalid
    if (min < -50) min = 0; // if min is too low, set to 0 
    return min;
}

//sometimes arduinojson sends unexpected big values, just filter them
function getMaxWithLimits(data){
    let max = -1500;
    let datalen = data.length;
    for(let i = 0; i < datalen; i++){
        // Ignore null and only consider numbers
        if (data[i] !== null && typeof data[i] === 'number' && data[i] > max && data[i] < 1500){
            max = data[i];
        }
    }
    if (max == -1500) max = 0;
    if (max > 10000) max = 10000; // if max is too high, set to 10000
    return max;
}

function parseTimeSeries(json){
    datalen=json.n;
    console.log(datalen);

    if (!chart_obj) showGraph();
    //https://stackoverflow.com/questions/49360165/chart-js-update-function-chart-labels-data-will-not-update-the-chart
    //update chart
    
    if (json.val == "timestamp"){
		 timeStamp=[]; 

		for(i=0;i<datalen;i++){
			const date = new Date(json.timestamp[i] * 1000);
			timeStamp.push(date.toLocaleTimeString('default', { 
				hour: '2-digit', 
				minute: '2-digit',
				hour12: false 
			}));
		} 

		chart_obj.data.labels=timeStamp;
	}
	
    if (json.val == "ac_sensor_temperature") {
        chart_obj.data.datasets[0].data=json.ac_sensor_temperature;
    }
    if (json.val == "sensor_temperature") {
        chart_obj.data.datasets[1].data=json.sensor_temperature;
    }
    if (json.val == "sensor_humidity") {        
        chart_obj.data.datasets[2].data=json.sensor_humidity;
    }
    if (json.val == "sensor_pressure") {   
        chart_obj.data.datasets[3].data=json.sensor_pressure;
    }
    if (json.val == "ac_external_temperature") {           
        chart_obj.data.datasets[4].data=json.ac_external_temperature;
    }

    //window.
    chart_obj.update();
    
    // Update adaptive ranges after data is loaded
    setTimeout(updateChartRanges, 100);
    
    //compute min/max
    if (json.val == "sensor_temperature"){
        // Defensive: filter only valid numbers for min/max
        let valid = (json.sensor_temperature || []).filter(v => v !== null && typeof v === 'number' && v > -50 && v < 100);
        let min = valid.length ? Math.min(...valid) : 0;
        let max = valid.length ? Math.max(...valid) : 0;
        document.getElementById('sensor_temperature_min').textContent = min.toFixed(1);
        document.getElementById('sensor_temperature_max').textContent = max.toFixed(1);
    }

    if (json.val == "sensor_humidity"){        
		document.getElementById('sensor_humidity_min').textContent  = getMinNoZero(json.sensor_humidity).toFixed(1);
		document.getElementById('sensor_humidity_max').textContent  = getMaxWithLimits(json.sensor_humidity).toFixed(1);
	}
	if (json.val == "sensor_pressure"){
		document.getElementById('sensor_pressure_min').textContent = getMinNoZero(json.sensor_pressure).toFixed(1);
		document.getElementById('sensor_pressure_max').textContent = getMaxWithLimits(json.sensor_pressure).toFixed(1);
	}

}

//Update connection status with icon
function updateConnectionStatus(status) {
    const connElem = document.getElementById('connection');
    if (!connElem) return;
    let icon = '';
    let color = '';
    let status_text = '';
    if (status === "open") {
        icon = '<span class="material-icons" style="color:#4caf50;vertical-align:middle;" title="Wifi Connected">wifi</span>';
        color = "#4caf50";
        status_text = "Connected";
    } else if (status === "closed") {
        icon = '<span class="material-icons" style="color:#f44336;vertical-align:middle;" title="Wifi Disconnected">wifi_off</span>';
        color = "#f44336";
        status_text = "Disconnected";
    } else if (status === "error") {
        icon = '<span class="material-icons" style="color:#ff9800;vertical-align:middle;" title="Error">error_outline</span>';
        color = "#ff9800";
        status_text = "Error";
    } else {
        icon = '<span class="material-icons" style="color:#9e9e9e;vertical-align:middle;" title="Unknown">help_outline</span>';
        color = "#9e9e9e";
        status_text = "Unknown";
    }

    connElem.innerHTML = icon + ' <span style="color:' + color + ';font-weight:bold;vertical-align:middle;"></span>';
}

function toggleHomeAssistantControls() {
    const homeassistantControls = document.getElementById('homeassistant-controls');
    const homeassistantIcon = document.querySelector('[onclick="toggleHomeAssistantControls()"]');
    
    if (homeassistantControls.style.display === 'none') {
        homeassistantControls.style.display = 'block';
        homeassistantIcon.style.border = '2px solid #002F7A';
        homeassistantIcon.style.boxShadow = '0 2px 8px #002F7A44';
        
        // Only load MQTT config if WebSocket is connected
        if (connection && connection.readyState === WebSocket.OPEN) {
            loadMQTTConfig();
        } else {
            console.log('WebSocket not connected, skipping MQTT config load');
        }
    } else {
        homeassistantControls.style.display = 'none';
        homeassistantIcon.style.border = '2px solid #e9ecef';
        homeassistantIcon.style.boxShadow = 'none';
    }
}

function saveMQTTConfig() {
    const mqttServer = document.getElementById('mqtt_server').value;
    const mqttPort = document.getElementById('mqtt_port').value;
    const mqttUsername = document.getElementById('mqtt_username').value;
    const mqttPassword = document.getElementById('mqtt_password').value;
    const mqttDeviceName = document.getElementById('mqtt_device_name').value;
    
    // Validation
    if (!mqttServer) {
        alert('Please enter MQTT server IP');
        return;
    }
    
    if (!mqttPort || mqttPort < 1 || mqttPort > 65535) {
        alert('Please enter a valid port (1-65535)');
        return;
    }
    
    let data = {
        id: "mqtt_config",
        server: mqttServer,
        port: parseInt(mqttPort),
        username: mqttUsername,
        password: mqttPassword,
        device_name: mqttDeviceName || "toshiba_ac"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Config: ' + json);
    
    // Show feedback
    const saveButton = event.target;
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Saved!';
    saveButton.style.background = '#4caf50';
    
    setTimeout(() => {
        saveButton.innerHTML = originalText;
        saveButton.style.background = '#4caf50';
    }, 2000);
}

function testMQTTConnection() {
    let data = {
        id: "mqtt_test",
        value: "test_connection"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Test: ' + json);
    
    // Show feedback
    const testButton = event.target;
    const originalText = testButton.innerHTML;
    testButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Testing...';
    testButton.style.background = '#ff9800';
    
    setTimeout(() => {
        testButton.innerHTML = originalText;
        testButton.style.background = '#2196f3';
    }, 3000);
}

function loadMQTTConfig() {
    let data = {
        id: "mqtt_get_config",
        value: "current"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Request MQTT Config: ' + json);
}

function sendMQTTDiscovery() {
    let data = {
        id: "mqtt_discovery",
        value: "send"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Discovery: ' + json);
    
    // Show feedback
    const discoveryButton = event.target;
    const originalText = discoveryButton.innerHTML;
    discoveryButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Sending...';
    discoveryButton.style.background = '#ff9800';
    
    setTimeout(() => {
        discoveryButton.innerHTML = originalText;
        discoveryButton.style.background = '#9c27b0';
        document.getElementById('mqtt_discovery_status').textContent = new Date().toLocaleTimeString();
    }, 2000);
}

function resetMQTTDiscovery() {
    if (confirm('This will remove the device from Home Assistant. Continue?')) {
        let data = {
            id: "mqtt_discovery",
            value: "reset"
        };
        
        let json = JSON.stringify(data);
        connection.send(json);
        console.log('Reset MQTT Discovery: ' + json);
        
        // Show feedback
        document.getElementById('mqtt_discovery_status').textContent = 'Reset at ' + new Date().toLocaleTimeString();
    }
}

function sendRawBytes() {
    const rawInput = document.getElementById('raw_bytes_input').value.trim();
    const crcOption = document.querySelector('input[name="raw_bytes_crc"]:checked').value;
    
    if (!rawInput) {
        alert('Please enter hex bytes');
        return;
    }
    
    // Validate and parse hex bytes
    const hexBytes = rawInput.split(/[\s:,;]+/); // Split by whitespace or common separators
    const validBytes = [];
    
    for (let i = 0; i < hexBytes.length; i++) {
        let hex = hexBytes[i].trim();
        if (hex === '') continue;
        
        // Remove 0x or 0X prefix if present
        if (hex.toLowerCase().startsWith('0x')) {
            hex = hex.substring(2);
        }

        // Check if it's a valid hex byte (00-FF)
        if (!/^[0-9A-Fa-f]{1,2}$/.test(hex)) {
            alert(`Invalid hex byte: "${hex}". Use format like "40 00 11 03 or 40:00:11:03"`);
            return;
        }
        
        const byteValue = parseInt(hex, 16);
        if (byteValue < 0 || byteValue > 255) {
            alert(`Byte value out of range: ${hex} (must be 00-FF)`);
            return;
        }
        
        validBytes.push(byteValue);
    }
    
    if (validBytes.length === 0) {
        alert('No valid bytes found');
        return;
    }
    
    // Handle CRC based on selected option
    if (crcOption === 'add') {
        // Always add CRC
        let crc = 0;
        for (let i = 0; i < validBytes.length; i++) {
            crc ^= validBytes[i];
        }
        validBytes.push(crc);
        console.log('CRC added: 0x' + crc.toString(16).toUpperCase().padStart(2, '0'));
    } else if (crcOption === 'auto') {
        // Check if CRC is already correct, if not add it
        let crc = 0;
        for (let i = 0; i < validBytes.length; i++) {
            crc ^= validBytes[i];
        }
        
        if (crc === 0) {
            // XOR of all bytes including last one is 0, CRC is already included
            console.log('CRC already included (XOR check passed)');
        } else {
            // CRC not included, add it
            validBytes.push(crc);
            console.log('CRC auto-added: 0x' + crc.toString(16).toUpperCase().padStart(2, '0'));
        }
    }
    // If crcOption === 'none', don't add CRC
    
    // Send the command
    let data = {
        id: "raw_bytes",
        bytes: validBytes
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send Raw Bytes: ' + json);
    
    // Visual feedback
    const sendButton = event.target;
    const originalText = sendButton.innerHTML;
    sendButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Sent!';
    sendButton.style.background = '#4caf50';
    
    setTimeout(() => {
        sendButton.innerHTML = originalText;
        sendButton.style.background = '#002F7A';
    }, 1500);
    
    // Clear the input after successful send
    setTimeout(() => {
        document.getElementById('raw_bytes_input').value = '';
    }, 100);
}

function startAutonomousMode() {
    let data = {
        id: "autonomous",
        value: "start"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Start Autonomous Mode: ' + json);
    
    // Visual feedback
    const startButton = document.getElementById('autonomous_start_btn');
    const originalText = startButton.innerHTML;
    startButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Started!';
    startButton.style.background = '#388e3c';
    
    setTimeout(() => {
        startButton.innerHTML = originalText;
        startButton.style.background = '#4caf50';
    }, 1500);
    
    // Update status
    document.getElementById('autonomous_status').textContent = 'Active';
    document.getElementById('autonomous_status').style.color = '#4caf50';
}

function stopAutonomousMode() {
    let data = {
        id: "autonomous",
        value: "stop"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Stop Autonomous Mode: ' + json);
    
    // Visual feedback
    const stopButton = document.getElementById('autonomous_stop_btn');
    const originalText = stopButton.innerHTML;
    stopButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Stopped!';
    stopButton.style.background = '#d32f2f';
    
    setTimeout(() => {
        stopButton.innerHTML = originalText;
        stopButton.style.background = '#f44336';
    }, 1500);
    
    // Update status
    document.getElementById('autonomous_status').textContent = 'Disabled';
    document.getElementById('autonomous_status').style.color = '#f44336';
}

function syncAddresses() {
    let data = {
        id: "sync_addresses"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Sync Addresses: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">check</span> Synced!';
    button.style.background = '#218838';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#28a745';
    }, 1500);
}

function resetAddresses() {
    let data = {
        id: "reset_addresses"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Reset Addresses: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">check</span> Reset!';
    button.style.background = '#5a6268';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#6c757d';
    }, 1500);
}

function setManualAddresses() {
    const masterValue = document.getElementById('manual_master').value.trim();
    const remoteValue = document.getElementById('manual_remote').value.trim();
    
    if (!masterValue && !remoteValue) {
        alert('Please enter at least one address value');
        return;
    }
    
    let data = {
        id: "set_addresses"
    };
    
    if (masterValue) {
        // Convert hex string to decimal
        const masterHex = masterValue.startsWith('0x') ? masterValue : '0x' + masterValue;
        data.master = parseInt(masterHex, 16);
    }
    
    if (remoteValue) {
        // Convert hex string to decimal
        const remoteHex = remoteValue.startsWith('0x') ? remoteValue : '0x' + remoteValue;
        data.remote = parseInt(remoteHex, 16);
    }
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Set Manual Addresses: ' + json);
    
    // Clear inputs and show feedback
    document.getElementById('manual_master').value = '';
    document.getElementById('manual_remote').value = '';
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'Set!';
    button.style.background = '#0056b3';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#007bff';
    }, 1500);
}

function resetObservedRemotes() {
    const message = {
        id: "reset_observed_remotes"
    };
    connection.send(JSON.stringify(message));
    
    // Optional: Show a loading indicator
    console.log("Clearing observed remotes...");
}

function announceRemote() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    // Send simple announcement command
    let data = { 
        id: "announce_remote"
    };
    
    connection.send(JSON.stringify(data));
    console.log('Announce Remote command sent');
    
    // Visual feedback
    button.disabled = true;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_top</span> Announcing...';
    button.style.background = '#ff9800';
    
    // Re-enable after 30 seconds (announcement process duration)
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalText;
        button.style.background = '#007bff';
    }, 30000);
}

function requestAnnounceStatus() {
    let data = {
        id: "announce_status"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Request Announce Status: ' + json);
}

function parseAnnounceStatus(json) {
    console.log("Announcement status:", json);
    
    const iconElem = document.getElementById('announce_status_icon');
    const textElem = document.getElementById('announce_status_text');
    
    if (!iconElem || !textElem) return;
    
    let icon = 'radio_button_unchecked';
    let color = '#ff9800';
    let text = 'BUSY';
    
    if (json.state === 'LINKED') {
        icon = 'check_circle';
        color = '#4caf50';
        text = 'LINKED';
    } else if (json.state === 'UNLINKED') {
        icon = 'cancel';
        color = '#f44336';
        text = 'UNLINKED';
    } else if (json.state === 'BUSY') {
        icon = 'pending';
        color = '#ff9800';
        text = 'BUSY';
    }
    
    iconElem.textContent = icon;
    iconElem.style.color = color;
    textElem.textContent = text;
    textElem.style.color = color;
}



function unlinkRemote() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    let data = { 
        id: "unlink_remote"
    };
    
    connection.send(JSON.stringify(data));
    console.log('Unlink Remote command sent');
    
    // Visual feedback
    button.disabled = true;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_top</span> Unlinking...';
    button.style.background = '#f57c00';
    
    // Re-enable after 2 seconds
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalText;
        button.style.background = '#ff9800';
        
        // Request updated status
        requestAnnounceStatus();
    }, 2000);
}

// Add this new function to update the announce status display
function updateAnnounceStatusDisplay(state, retryCount, isLinked) {
    const iconElem = document.getElementById('announce_status_icon');
    const textElem = document.getElementById('announce_status_text');
    
    if (!iconElem || !textElem) return;
    
    let icon = 'radio_button_unchecked';
    let color = '#ff9800';
    let text = 'BUSY';
    
    if (state === 'LINKED') {
        icon = 'check_circle';
        color = '#4caf50';
        text = 'LINKED';
    } else if (state === 'UNLINKED') {
        icon = 'cancel';
        color = '#f44336';
        text = 'UNLINKED';
    } else if (state === 'BUSY') {
        icon = 'pending';
        color = '#ff9800';
        text = 'BUSY';
    }
    
    iconElem.textContent = icon;
    iconElem.style.color = color;
    textElem.textContent = text;
    textElem.style.color = color;
}

function parseDNCode(json) {
    if (json.status === "ignored") {
        console.log("DN explore ignored in simulation mode");
        return;
    }
    
    if (json.status === "valid" && json.value !== undefined && json.value !== -1) {
        const code = json.code;
        const value = json.value;
        
        console.log(`DN Code 0x${code.toString(16).toUpperCase().padStart(2, '0')}: value=0x${value.toString(16).toUpperCase().padStart(2, '0')} (${value})`);
        
        // Add to results table
        const table = document.getElementById('explore_dn_results_table');
        if (table) {
            const row = table.insertRow(0); // Insert at top
            row.style.borderBottom = '1px solid #e9ecef';
            
            const codeCell = row.insertCell(0);
            codeCell.style.padding = '4px';
            codeCell.style.fontFamily = 'monospace';
            codeCell.innerHTML = '0x' + code.toString(16).toUpperCase().padStart(2, '0');
            
            const valueCell = row.insertCell(1);
            valueCell.style.padding = '4px';
            valueCell.style.fontFamily = 'monospace';
            valueCell.innerHTML = '0x' + value.toString(16).toUpperCase().padStart(2, '0') + 
                              ' (' + value + ')';
            
            const descCell = row.insertCell(2);
            descCell.style.padding = '4px';
            descCell.style.fontSize = '11px';
            const description = dnCodeDescriptions[code] || 'Unknown';
            descCell.innerHTML = description;
        }
        
        // Show results container
        const container = document.getElementById('explore_dn_results');
        if (container) container.style.display = 'block';
    } else if (json.value === -1) {
        console.log(`DN Code 0x${json.code.toString(16).toUpperCase().padStart(2, '0')}: No response or timeout`);
    }
}

function exploreDNCode() {
    const input = document.getElementById('explore_dn_code_input');
    const codeStr = input.value.trim();
    
    if (!codeStr) {
        alert('Please enter a hex code (00-FF)');
        return;
    }
    
    // Validate hex input
    if (!/^[0-9A-Fa-f]{1,2}$/.test(codeStr)) {
        alert('Invalid hex code. Use format like 00, 0F, FF');
        return;
    }
    
    const code = parseInt(codeStr, 16);
    if (code < 0 || code > 255) {
        alert('Code must be between 00 and FF');
        return;
    }
    
    console.log(`Exploring DN code 0x${code.toString(16).toUpperCase().padStart(2, '0')}`);
    
    // Send explore request
    let data = {
        id: "explore_dn_code",
        code: code
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    
    // Visual feedback
    input.value = '';
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_empty</span> Exploring...';
    button.style.background = '#7b1fa2';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#9c27b0';
        button.disabled = false;
    }, 1000);
}

function exploreRangeDNCodes() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">hourglass_empty</span> Exploring...';
    button.style.background = '#f57c00';
    
    console.log('Exploring DN codes 0x00 to 0xFF');
    
    // Show results container
    const container = document.getElementById('explore_dn_results');
    if (container) container.style.display = 'block';
    
    // Explore codes 0x00 to 0x0F sequentially with small delays
    let currentCode = 0;
    const maxCode = 0xFF;
    
    function exploreNext() {
        if (currentCode <= maxCode) {
            let data = {
                id: "explore_dn_code",
                code: currentCode
            };
            connection.send(JSON.stringify(data));
            
            currentCode++;
            setTimeout(exploreNext, 300); // 300ms delay between requests
        } else {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalText;
            button.style.background = '#ff9800';
        }
    }
    
    exploreNext();
}

function clearExploreDNResults() {
    const table = document.getElementById('explore_dn_results_table');
    if (table) {
        table.innerHTML = '';
    }
    const container = document.getElementById('explore_dn_results');
    if (container) {
        container.style.display = 'none';
    }
}

function enableSimulationMode() {
    let data = {
        id: "simulation_mode",
        value: "enable"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Enable Simulation Mode: ' + json);
    
    // Visual feedback
    const enableButton = document.getElementById('simulation_mode_enable_btn');
    const originalText = enableButton.innerHTML;
    enableButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Enabled!';
    enableButton.style.background = '#4caf50';
    
    setTimeout(() => {
        enableButton.innerHTML = originalText;
        enableButton.style.background = '#ff9800';
    }, 1500);
    
    // Update status
    document.getElementById('simulation_mode_status').textContent = 'Enabled';
    document.getElementById('simulation_mode_status').style.color = '#ff9800';
}

function disableSimulationMode() {
    let data = {
        id: "simulation_mode",
        value: "disable"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Disable Simulation Mode: ' + json);
    
    // Visual feedback
    const disableButton = document.getElementById('simulation_mode_disable_btn');
    const originalText = disableButton.innerHTML;
    disableButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Disabled!';
    disableButton.style.background = '#4caf50';
    
    setTimeout(() => {
        disableButton.innerHTML = originalText;
        disableButton.style.background = '#6c757d';
    }, 1500);
    
    // Update status
    document.getElementById('simulation_mode_status').textContent = 'Disabled';
    document.getElementById('simulation_mode_status').style.color = '#6c757d';
}

function enableListenMode() {
    let data = {
        id: "listen_mode",
        value: "enable"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Enable Listen Mode: ' + json);
    
    // Visual feedback
    const enableButton = document.getElementById('listen_mode_enable_btn');
    const originalText = enableButton.innerHTML;
    enableButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Enabled!';
    enableButton.style.background = '#4caf50';
    
    setTimeout(() => {
        enableButton.innerHTML = originalText;
        enableButton.style.background = '#2196f3';
    }, 1500);
    
    // Update status
    document.getElementById('listen_mode_status').textContent = 'Enabled';
    document.getElementById('listen_mode_status').style.color = '#2196f3';
}

function disableListenMode() {
    let data = {
        id: "listen_mode",
        value: "disable"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Disable Listen Mode: ' + json);
    
    // Visual feedback
    const disableButton = document.getElementById('listen_mode_disable_btn');
    const originalText = disableButton.innerHTML;
    disableButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Disabled!';
    disableButton.style.background = '#4caf50';
    
    setTimeout(() => {
        disableButton.innerHTML = originalText;
        disableButton.style.background = '#6c757d';
    }, 1500);
    
    // Update status
    document.getElementById('listen_mode_status').textContent = 'Disabled';
    document.getElementById('listen_mode_status').style.color = '#6c757d';
}

var addressesRefreshInterval = null;
var sensorsRefreshInterval = null;

function showSystemSubsection(subsection) {
    // Hide all subsections
    const subsections = ['info', 'sensors', 'addresses', 'modes', 'admin'];
    subsections.forEach(sub => {
        const element = document.getElementById(`system-${sub}-subsection`);
        if (element) {
            element.style.display = 'none';
        }
        
        // Reset button styles
        const btn = document.getElementById(`system-${sub}-btn`);
        if (btn) {
            btn.style.background = '#6c757d';
            btn.style.color = 'white';
        }
    });
    
    // Clear any existing address refresh interval
    if (addressesRefreshInterval) {
        clearInterval(addressesRefreshInterval);
        addressesRefreshInterval = null;
    }
    
   if (sensorsRefreshInterval) {
        clearInterval(sensorsRefreshInterval);
        sensorsRefreshInterval = null;
    }

    // Show selected subsection
    const selectedElement = document.getElementById(`system-${subsection}-subsection`);
    if (selectedElement) {
        selectedElement.style.display = 'block';
    }
    
    // Highlight selected button
    const selectedBtn = document.getElementById(`system-${subsection}-btn`);
    if (selectedBtn) {
        selectedBtn.style.background = '#002F7A';
        selectedBtn.style.color = 'white';
    }
    
    // Request relevant data when subsection is shown
    if (connection && connection.readyState === WebSocket.OPEN) {
        if (subsection === 'info') {
            requestSystemInfo();
            requestMasterInfo();

            // no need for refresh as this is static info
        } else if (subsection === 'sensors') {
            requestSensors();

            // Set up interval to refresh sensors every 120 seconds
            sensorsRefreshInterval = setInterval(() => {
                if (connection && connection.readyState === WebSocket.OPEN) {
                    requestSensors();
                    console.log('Auto-refreshing sensors...');
                }
            }, 120000); // 120000ms = 120 seconds
        } else if (subsection === 'addresses') {
            // Request addresses immediately
            requestAddresses();
            
            // Set up interval to refresh addresses every 5 seconds
            addressesRefreshInterval = setInterval(() => {
                if (connection && connection.readyState === WebSocket.OPEN) {
                    requestAddresses();
                    console.log('Auto-refreshing addresses...');
                }
            }, 5000); // 5000ms = 5 seconds
        }
    }
}

// Remove the duplicate toggleSystemControls() function around line 2040
// Keep only this complete version:

// Also clear the interval when system controls are closed
function toggleSystemControls() {
    const systemControls = document.getElementById('system-controls');
    const systemIcon = document.querySelector('[onclick="toggleSystemControls()"]');
    
    if (systemControls.style.display === 'none') {
        systemControls.style.display = 'block';
        systemIcon.style.border = '2px solid #002F7A';
        systemIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        systemControls.style.display = 'none';
        systemIcon.style.border = '2px solid #e9ecef';
        systemIcon.style.boxShadow = 'none';
        
        // Clear address refresh interval when closing system controls
        if (addressesRefreshInterval) {
            clearInterval(addressesRefreshInterval);
            addressesRefreshInterval = null;
            console.log('Address auto-refresh stopped');
        }
        
        if (sensorsRefreshInterval) {
            clearInterval(sensorsRefreshInterval);
            sensorsRefreshInterval = null;
            console.log('Sensors auto-refresh stopped');
        }

        // Hide all subsections when closing system controls
        const subsections = ['info', 'sensors', 'addresses', 'modes', 'admin'];
        subsections.forEach(sub => {
            const element = document.getElementById(`system-${sub}-subsection`);
            if (element) {
                element.style.display = 'none';
            }
            
            // Reset button styles
            const btn = document.getElementById(`system-${sub}-btn`);
            if (btn) {
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
            }
        });
    }
}

function restartDevice() {
    if (confirm('Are you sure you want to restart the device?')) {
        let data = {
            id: "restart"
        };
        let json = JSON.stringify(data);
        connection.send(json);
        console.log('Send Restart: ' + json);

        // Visual feedback
        const btn = document.getElementById('restart_button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="material-icons" style="font-size: 16px; vertical-align: middle;">autorenew</span> Restarting...';
        btn.style.background = '#ff9800';
        btn.disabled = true;
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '#d32f2f';
            btn.disabled = false;
        }, 8000);
    }
}

window.onload = function() {
    //getTimeseries();  //avoid errors when no connection is available
	showGraph();
};

<!-- end of javascript functions -->
	</script>

</head>

<body>
    <center>

        <div class="controller-card">
            <!-- Header -->
            <div
                style="text-align: center; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    <h1 style="margin: 0; font-size: 28px; color: #002F7A; font-weight: 600;">Air Conditioning</h1>
                </div>
                <!-- <div style="font-size: 14px; color: #666; font-weight: normal;">Smart Control Panel</div> -->
            </div>
            <div class="status-row">
                <span id="connection" style="font-size: 16px;">Connecting...</span>
                <span id="status-icons"></span>
            </div>
            <!-- End of header -->

            <!-- Target temperature Display -->
            <div class="temp-display">
                <span class="material-icons">thermostat</span>
                <span id="target_temperature">--</span>°C
            </div>
            <div style="text-align:center; color:#888; margin-bottom:10px;">
                <span>Room: <span id="ac_sensor_temperature">--</span>°C</span>
                <!-- | <span>Humidity: <span id="sensor_humidity">--</span>%</span>  -->
            </div>

            <!-- Sensor display elements -->
            <div style="text-align:center; color:#888; margin-bottom:10px; font-size: 12px;">
                <!-- <div>Sensor Temp: <span id="sensor_temperature">--</span>°C</div>  -->

                <div>Ext Temp: <span id="outdoor_te">--</span>°C
                    | Fan: <span id="indoor_fan_speed">--</span> rpm</div>
            </div>

            <!-- Expanded Controller Buttons. Not displayed. Maybe show these in computer and compact in small devices-->
            <div class="button-row" style="display: none;">
                <button class="control-btn" id="power_on" onclick="power_on();">
                    <span class="material-icons">power_settings_new</span>
                    ON
                </button>
                <button class="control-btn" id="power_off" onclick="power_off();">
                    <span class="material-icons">power_off</span>
                    OFF
                </button>
                <button class="control-btn" id="save_button" onclick="save_toggle();">
                    <span class="material-icons">energy_savings_leaf</span>
                    Save
                </button>
            </div>
            <div class="button-row" style="display: none;">
                <button class="control-btn" id="mode_fan" onclick="mode_fan();">
                    <span class="material-symbols-outlined">mode_fan</span>
                    Fan
                </button>
                <button class="control-btn" id="mode_dry" onclick="mode_dry();">
                    <span class="material-icons">opacity</span>
                    Dry
                </button>
                <button class="control-btn" id="mode_cool" onclick="mode_cool();">
                    <span class="material-icons">ac_unit</span>
                    Cool
                </button>
                <button class="control-btn" id="mode_heat" onclick="mode_heat();">
                    <span class="material-symbols-outlined">sunny</span>
                    Heat
                </button>

                <button class="control-btn" id="mode_auto" onclick="mode_auto();">
                    <span class="material-icons">autorenew</span>
                    Auto
                </button>
            </div>
            <div class="button-row" style="display: none;">
                <button class="control-btn" id="fan_low" onclick="fan_low();">
                    <span class="material-symbols-outlined">density_large</span>
                    Low
                </button>
                <button class="control-btn" id="fan_medium" onclick="fan_medium();">
                    <span class="material-symbols-outlined">density_medium</span>
                    Med
                </button>
                <button class="control-btn" id="fan_high" onclick="fan_high();">
                    <span class="material-symbols-outlined">density_small</span>
                    High
                </button>
                <button class="control-btn" id="fan_auto" onclick="fan_auto();">
                    <span class="material-symbols-outlined">hdr_auto</span>
                    Auto
                </button>
            </div>
            <!-- Compact controller buttons -->
            <div class="button-row">
                <button class="control-btn" id="power_btn" onclick="cyclePower();">
                    <span class="material-icons" id="power_icon">power_off</span>
                    <span id="power_text">OFF</span>
                </button>
                <button class="control-btn" id="save_button_compact" onclick="save_toggle();">
                    <span class="material-icons">energy_savings_leaf</span>
                    Save
                </button>
            </div>
            <div class="button-row">
                <!-- <button class="control-btn" id="mode_btn" onclick="cycleMode();">
                    <span class="material-symbols-outlined" id="mode_icon">mode_fan</span>
                    <span id="mode_text">Fan</span>
                </button> -->
                <button class="control-btn" id="mode_btn" onclick="cycleMode();" style="position: relative;">
                    <!-- Previous mode indicator (left) -->
                    <div
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 10px; display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="mode_prev_icon"
                            style="font-size: 16px;">mode_fan</span>
                        <span id="mode_prev_text" style="font-size: 9px;">Fan</span>
                    </div>

                    <!-- Current mode (center) -->
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="mode_icon"
                            style="font-size: 28px; margin-bottom: 2px;">mode_fan</span>
                        <span id="mode_text" style="font-size: 14px;">Fan</span>
                    </div>

                    <!-- Next mode indicator (right) -->
                    <div
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 10px; display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="mode_next_icon"
                            style="font-size: 16px;">opacity</span>
                        <span id="mode_next_text" style="font-size: 9px;">Dry</span>
                    </div>
                </button>


                <button class="control-btn" id="fan_speed_btn" onclick="cycleFanSpeed();" style="position: relative;">
                    <!-- Previous fan speed indicator (left) -->
                    <div
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 10px; display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="fan_prev_icon"
                            style="font-size: 16px;">hdr_auto</span>
                        <span id="fan_prev_text" style="font-size: 9px;">Auto</span>
                    </div>

                    <!-- Current fan speed (center) -->
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="fan_speed_icon"
                            style="font-size: 28px; margin-bottom: 2px;">density_large</span>
                        <span id="fan_speed_text" style="font-size: 14px;">Low</span>
                    </div>

                    <!-- Next fan speed indicator (right) -->
                    <div
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 10px; display: flex; flex-direction: column; align-items: center;">
                        <span class="material-symbols-outlined" id="fan_next_icon"
                            style="font-size: 16px;">density_medium</span>
                        <span id="fan_next_text" style="font-size: 9px;">Med</span>
                    </div>
                </button>
            </div>

            <div class="button-row">
                <button class="control-btn" onclick="temp_minus();">
                    <span class="material-symbols-outlined">arrow_drop_down</span>
                    Temp -
                </button>
                <button class="control-btn" onclick="temp_plus();">
                    <span class="material-symbols-outlined">arrow_drop_up</span>
                    Temp +
                </button>
            </div>
            <!-- End of Controller buttons -->

            <!-- Collapsible in a single row -->
            <div style="margin: 18px 0;">
                <!-- Compact Icon Row -->
                <div style="display: flex; justify-content: space-around; gap: 8px; margin-bottom: 12px;">
                    <!-- Timer Icon -->
                    <div onclick="toggleTimerControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">timer</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Timer</div>
                    </div>

                    <!-- Graph Icon -->
                    <div onclick="toggleGraphControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">analytics</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Charts</div>
                    </div>


                    <!-- System Icon -->
                    <div onclick="toggleSystemControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">settings</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">System</div>
                    </div>

                    <!-- Debug Icon -->
                    <div onclick="toggleDebugControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">troubleshoot</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Debug</div>
                    </div>

                    <!-- Home Assistant Icon -->
                    <div onclick="toggleHomeAssistantControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">home</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">MQTT</div>
                    </div>
                </div>

                <!-- Timer Controls - Hidden by Default -->
                <div id="timer-controls" style="display: none; margin-bottom: 12px;">
                    <!-- Timer Mode Selection -->
                    <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 12px;">
                        <button class="timer-btn" id="timer_mode_off" onclick="setTimerMode('off')"
                            style="background: #ffbe0b; color: #002F7A; flex: 1; max-width: 120px;">
                            <span class="material-icons" style="font-size: 16px; margin-right: 4px;">power_off</span>
                            Timer OFF
                        </button>
                        <button class="timer-btn" id="timer_mode_on" onclick="setTimerMode('on')"
                            style="flex: 1; max-width: 120px;">
                            <span class="material-icons"
                                style="font-size: 16px; margin-right: 4px;">power_settings_new</span>
                            Timer ON
                        </button>
                    </div>

                    <!-- Timer Duration Selection -->
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 8px;">
                        <button class="timer-btn" onclick="setTimerValue(0)">0m</button>
                        <button class="timer-btn" onclick="setTimerValue(15)">15m</button>
                        <button class="timer-btn" onclick="setTimerValue(30)"
                            style="background: #ffbe0b; color: #002F7A;">30m</button>
                        <button class="timer-btn" onclick="setTimerValue(45)">45m</button>
                        <button class="timer-btn" onclick="setTimerValue(60)">1h</button>
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                        <button class="timer-adjust-btn" onclick="adjustTimer(-5)">
                            <span class="material-icons">remove</span>
                        </button>
                        <button class="timer-adjust-btn" onclick="adjustTimer(-1)">-1</button>
                        <span
                            style="font-size: 18px; font-weight: bold; color: #002F7A; min-width: 60px; text-align: center;">
                            <span id="timer_time">30</span>m
                        </span>
                        <button class="timer-adjust-btn" onclick="adjustTimer(1)">+1</button>
                        <button class="timer-adjust-btn" onclick="adjustTimer(5)">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; gap: 8px;">
                        <button class="control-btn" id="sw_set_timer_button" style="width: 48%;"
                            onclick="set_sw_air_timer();">
                            <span class="material-icons">play_arrow</span>
                            Set Timer
                        </button>
                        <button class="control-btn" id="sw_reset_timer_button" style="width: 48%;"
                            onclick="reset_sw_air_timer();">
                            <span class="material-icons">stop</span>
                            Reset Timer
                        </button>
                    </div>
                    <div style="margin-top: 8px; color: #888;">
                        Pending: <span id="timer_pending">-</span>
                    </div>
                </div>

                <!-- Graph Controls - Hidden by Default -->
                <div id="graph-controls" style="display: none; margin-bottom: 12px;">
                    <!-- Chart Container -->
                    <div class="chart-container"
                        style="position: relative; height: 300px; width: 100%; background: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <canvas id="temperature_chart" width="400" height="300"></canvas>
                    </div>

                    <!-- Chart Info Summary -->
                    <div
                        style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-around; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Temp Range</div>
                            <div><span id="sensor_temperature_min">--</span>°C / <span
                                    id="sensor_temperature_max">--</span>°C</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Humidity Range</div>
                            <div><span id="sensor_humidity_min">--</span>% / <span id="sensor_humidity_max">--</span>%
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Pressure Range</div>
                            <div><span id="sensor_pressure_min">--</span> / <span id="sensor_pressure_max">--</span>mb
                            </div>
                        </div>
                    </div>

                    <!-- Temperature Sampling Rate -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">
                            Temperature Sampling Rate
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: #666; font-size: 12px;">Sampling interval:</span>
                            <div style="display: flex; gap: 4px; margin-top: 4px;">
                                <input id="sampling_text" type="number" min="1" max="3600"
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                    placeholder="seconds" />
                                <button id="sampling_button" onclick="set_sampling();"
                                    style="padding: 8px 16px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">schedule</span>
                                    Set
                                </button>
                            </div>
                        </div>
                        
                        <div style="color: #666; font-size: 11px;">
                            Configure how often temperature readings are sampled to show if in the chart (1-3600 seconds)
                        </div>
                    </div>
                    <!-- End Temperature Sampling Rate -->  
                </div>
                <!-- End Chart Info Summary -->
                <!-- System Controls - Hidden by Default -->
                <div id="system-controls" style="display: none; margin-bottom: 12px;">
                    <!-- System Subsection Navigation -->
                    <div
                        style="display: flex; gap: 4px; margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                        <button onclick="showSystemSubsection('info')" id="system-info-btn"
                            style="flex: 1; padding: 8px 4px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 14px; display: block;">info</span>
                            Info
                        </button>
                        <button onclick="showSystemSubsection('sensors')" id="system-sensors-btn"
                            style="flex: 1; padding: 8px 4px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 14px; display: block;">sensors</span>
                            Sensors
                        </button>
                        <button onclick="showSystemSubsection('addresses')" id="system-addresses-btn"
                            style="flex: 1; padding: 8px 4px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 14px; display: block;">router</span>
                            Addresses
                        </button>
                        <button onclick="showSystemSubsection('modes')" id="system-modes-btn"
                            style="flex: 1; padding: 8px 4px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 14px; display: block;">settings</span>
                            Modes
                        </button>
                        <button onclick="showSystemSubsection('admin')" id="system-admin-btn"
                            style="flex: 1; padding: 8px 4px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; display: block;">admin_panel_settings</span>
                            Admin
                        </button>
                    </div>

                    <!-- System Information Subsection -->
                    <div id="system-info-subsection">
                        <!-- System Information -->
                        <div
                            style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                            <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">System
                                Information</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div>
                                    <span style="color: #666;">Boot Time:</span><br>
                                    <span id="boot_time" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Compiled:</span><br>
                                    <span id="compile_date" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>                                
                                <div>
                                    <span style="color: #666;">IP Address:</span><br>
                                    <span id="ip" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Free Memory:</span><br>
                                    <span id="heap" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Decoded Msgs:</span><br>
                                    <span id="decoded_msgs" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Discarded Msgs:</span><br>
                                    <span id="discarded_msgs" style="color: #f44336; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Recovered Msgs:</span><br>
                                    <span id="recovered_msgs" style="color: #0b832b; font-weight: bold;">--</span>
                                </div>                                
                                <div>
                                    <span style="color: #666;">Error Ratio:</span><br>
                                    <span id="error_ratio" style="color: #f44336; font-weight: bold;">--</span>
                                </div>
                            </div>
                        </div>
                        <!-- End System Information -->

                        <!-- Master Unit Info -->
                        <div
                            style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                            <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Master
                                Unit Information</div>
                            <button onclick="requestMasterInfo();"
                                style="width: 100%; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; margin-bottom: 8px;">
                                <span class="material-icons"
                                    style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</span>
                                Request Master Info
                            </button>

                            <div
                                style="display: grid; gap: 8px; font-size: 12px; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <div>
                                    <span style="color: #666;">Model:</span><br>
                                    <span id="master_model" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <span style="color: #666;">Temp Limits:</span><br>
                                        <span id="master_temp_limits"
                                            style="color: #002F7A; font-weight: bold;">--</span>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Frost Protection:</span><br>
                                        <span id="master_frost_protection"
                                            style="color: #002F7A; font-weight: bold;">--</span>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid #e9ecef; padding-top: 8px; margin-top: 4px;">
                                    <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Default Setpoints:
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div>
                                            <span style="color: #666;">Auto/Cool:</span> <span id="master_setpoint_auto"
                                                style="color: #002F7A; font-weight: bold;">--</span> /
                                            <span id="master_setpoint_cool"
                                                style="color: #002F7A; font-weight: bold;">--</span>
                                        </div>
                                        <div>
                                            <span style="color: #666;">Heat/Dry:</span> <span id="master_setpoint_heat"
                                                style="color: #002F7A; font-weight: bold;">--</span> /
                                            <span id="master_setpoint_dry"
                                                style="color: #002F7A; font-weight: bold;">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="color: #666; font-size: 11px; margin-top: 8px;">
                                Requests model, temperature limits, and default setpoints from the master unit.
                            </div>
                        </div>
                        <!-- End Master Unit Info -->


                    </div>
                    <!-- End of System Information Subsection -->
                <!--</div>

                <!-- System Sensors Subsection -->
                <div id="system-sensors-subsection" style="display: none;">
                    <!-- Indoor Sensors Section -->
                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                        <div onclick="toggleCollapse('indoor_sensors')"
                            style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                            <div style="font-weight: bold; color: #002F7A; margin-bottom: 6px; font-size: 13px;">Indoor
                                Sensors</div>
                            <span id="indoor_sensors_icon" class="material-icons"
                                style="font-size:18px;color:#002F7A;">expand_less</span>
                        </div>
                        <div id="indoor_sensors_body"
                            style="display:grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px; margin-top:4px;">
                            <div>
                                <span style="color: #666;">Room Temp:</span><br>
                                <span id="indoor_room_temp" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TA:</span><br>
                                <span id="indoor_ta" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TCJ:</span><br>
                                <span id="indoor_tcj" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TC:</span><br>
                                <span id="indoor_tc" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">Filter Time:</span><br>
                                <span id="indoor_filter_time" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                            <div>
                                <span style="color: #666;">Fan Run Time:</span><br>
                                <span id="indoor_fan_run_time" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                        </div>
                    </div>
                    <!-- End Indoor Sensors Section -->

                    <!-- Outdoor Sensors Section -->
                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                        <div onclick="toggleCollapse('outdoor_sensors')"
                            style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                            <div style="font-weight: bold; color: #002F7A; margin-bottom: 6px; font-size: 13px;">Outdoor
                                Sensors</div>
                            <span id="outdoor_sensors_icon" class="material-icons"
                                style="font-size:18px;color:#002F7A;">expand_less</span>
                        </div>
                        <div id="outdoor_sensors_body"
                            style="display:grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px; margin-top:4px;">
                            <div>
                                <span style="color: #666;">TO:</span><br>
                                <span id="outdoor_to" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TD:</span><br>
                                <span id="outdoor_td" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TS:</span><br>
                                <span id="outdoor_ts" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">THS:</span><br>
                                <span id="outdoor_ths" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">TL:</span><br>
                                <span id="outdoor_tl" style="color: #002F7A; font-weight: bold;">--</span>°C
                            </div>
                            <div>
                                <span style="color: #666;">Current:</span><br>
                                <span id="outdoor_current" style="color: #002F7A; font-weight: bold;">--</span> A
                            </div>
                            <div>
                                <span style="color: #666;">Cumulative Hours:</span><br>
                                <span id="outdoor_cumhour" style="color: #002F7A; font-weight: bold;">--</span> h(x10)
                            </div>
                            <div>
                                <span style="color: #666;">Comp Freq:</span><br>
                                <span id="outdoor_comp_freq" style="color: #002F7A; font-weight: bold;">--</span> Hz
                            </div>
                            <div>
                                <span style="color: #666;">Fan Low Speed:</span><br>
                                <span id="outdoor_lower_fan_speed" style="color: #002F7A; font-weight: bold;">--</span>
                                rpm
                            </div>
                            <div>
                                <span style="color: #666;">Fan High Speed:</span><br>
                                <span id="outdoor_upper_fan_speed" style="color: #002F7A; font-weight: bold;">--</span>
                                rpm
                            </div>
                        </div>
                    </div>
                    <!-- End Outdoor Sensors Section -->

                    <!-- DN Code Explorer -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">DN Code
                            Explorer</div>

                        <!-- Code input and explore button -->
                        <div style="display: flex; gap: 4px; margin-bottom: 8px; align-items: center;">
                            <label for="explore_dn_code_input" style="color: #333; font-size: 11px;">Code:</label>
                            <input id="explore_dn_code_input" type="text" placeholder="00-FF" maxlength="2"
                                style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                            <button onclick="exploreDNCode();"
                                style="padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">search</span>
                                Explore
                            </button>
                            <button onclick="exploreRangeDNCodes();"
                                style="padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">playlist_add_check</span>
                                Range 0x00-0xFF
                            </button>
                        </div>

                        <!-- Results Display -->
                        <div id="explore_dn_results"
                            style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="color: #666; font-size: 11px;">Explored Codes:</div>
                                <button onclick="clearExploreDNResults();"
                                    style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                    Clear
                                </button>
                            </div>
                            <table id="explore_dn_results_table"
                                style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                <!-- Results will be added here dynamically -->
                            </table>
                        </div>

                        <div style="color: #666; font-size: 11px; margin-top: 8px;">
                            Explore individual DN codes. Enter a hex code (00-FF) or use the range button to scan
                            0x00-0xFF.
                        </div>
                        <div style="color: #666; font-size: 11px; margin-top: 8px;">
                            Explores DN service codes from the AC unit. This may take some seconds.
                        </div>
                    </div>
                    <!-- End DN Explorer -->

                    <!-- Sensor Explorer -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Sensor
                            Explorer</div>

                        <!-- Sensor input and explore button -->
                        <div style="display: flex; gap: 4px; margin-bottom: 8px; align-items: center;">
                            <label for="explore_sensor_input" style="color: #333; font-size: 11px;">Sensor
                                ID:</label>
                            <input id="explore_sensor_input" type="text" placeholder="00-FF" maxlength="2"
                                style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                            <button onclick="exploreSensor();"
                                style="padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">search</span>
                                Explore
                            </button>
                        </div>

                        <!-- Range buttons row -->
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <button onclick="exploreRangeSensors();"
                                style="flex: 1; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">playlist_add_check</span>
                                Known Sensors
                            </button>
                            <button onclick="exploreFullRangeSensors();"
                                style="flex: 1; padding: 4px 8px; background: #ff5722; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">format_list_numbered</span>
                                Full Range 0x00-0xFF
                            </button>
                        </div>

                        <!-- Results Display -->
                        <div id="explore_sensor_results"
                            style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="color: #666; font-size: 11px;">Explored Sensors:</div>
                                <button onclick="clearExploreSensorResults();"
                                    style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                    Clear
                                </button>
                            </div>
                            <table id="explore_sensor_results_table"
                                style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                <!-- Results will be added here dynamically -->
                            </table>
                        </div>

                        <div style="color: #666; font-size: 11px; margin-top: 8px;">
                            Explore individual sensors or scan ranges. Known Sensors scans common IDs, Full Range
                            scans all 0x00-0xFF (takes ~76 seconds).
                        </div>
                    </div>
                    <!-- End Sensor Explorer -->



                </div>

                <!-- System Addresses Subsection -->
                <div id="system-addresses-subsection" style="display: none;">
                    <!-- Address Configuration Section -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Address
                            Configuration</div>

                        <!-- Current Addresses Display -->
                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Current addresses:</div>
                            <div style="font-family: monospace; font-size: 11px; margin-bottom: 4px;">
                                <span style="color: #333;">Active Master:</span> <span id="current_master"
                                    style="color: #002F7A; font-weight: bold;">0x--</span>
                                <span style="margin-left: 16px; color: #333;">Active Remote:</span> <span
                                    id="current_remote" style="color: #002F7A; font-weight: bold;">0x--</span>
                            </div>
                            <div style="font-family: monospace; font-size: 11px;">
                                <span style="color: #666;">Observed Master:</span> <span id="observed_master"
                                    style="color: #28a745; font-weight: bold;">0x--</span>
                                <span style="margin-left: 16px; color: #666;">Observed Remotes:</span> <span
                                    id="observed_remotes" style="color: #28a745; font-weight: bold;">0x--</span>
                            </div>
                        </div>

                        <!-- Address Controls -->
                        <div
                            style="margin-bottom: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeaa7;">
                            <div style="color: #856404; font-size: 11px; margin-bottom: 6px;">Address Controls:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button onclick="syncAddresses();"
                                    style="flex: 1; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">sync</span>
                                    Use Observed
                                </button>
                                <button onclick="resetAddresses();"
                                    style="flex: 1; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">refresh</span>
                                    Reset Default
                                </button>
                                <button onclick="resetObservedRemotes();"
                                    style="flex: 1; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">clear</span>
                                    Clear Observed
                                </button>
                            </div>
                            <div style="color: #856404; font-size: 10px;">
                                "Use Observed" copies detected addresses to active ones. "Reset Default" restores
                                0x00/0x40.
                            </div>
                        </div>

                        <!-- Separate Announce Remote Frame -->
                        <div
                            style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px; border: 1px solid #90caf9;">
                            <div style="color: #0d47a1; font-size: 11px; margin-bottom: 6px; font-weight: bold;">Remote
                                Announcement:</div>

                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button onclick="announceRemote();"
                                    style="flex: 1; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">broadcast_on_home</span>
                                    Announce Remote
                                </button>
                                <button onclick="unlinkRemote();"
                                    style="flex: 1; padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">link_off</span>
                                    Unlink Remote
                                </button>
                                <!-- Status display with just icon and state -->
                                <div id="announce_status_display"
                                    style="flex: 1; padding: 6px 12px; background: #f8f9fa; border-radius: 4px; font-size: 11px; border: 1px solid #e9ecef; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                    <span class="material-icons" id="announce_status_icon"
                                        style="font-size: 14px; color: #999;">radio_button_unchecked</span>
                                    <span id="announce_status_text" style="font-weight: bold; color: #999;">--</span>
                                </div>
                            </div>

                            <div style="color: #0d47a1; font-size: 10px;">
                                <b>Announce:</b> Broadcasts remote address to AC unit. Status shows UNLINKED → BUSY →
                                LINKED.<br>
                                <b>Unlink:</b> Resets announcement state. To fully unlink hardware, power cycle the AC
                                unit.
                            </div>
                        </div>

                        <!-- Manual Address Setting -->
                        <div
                            style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Manual address setting:</div>
                            <div
                                style="display: flex; gap: 4px; margin-bottom: 4px; align-items: center; justify-content: center;">
                                <label for="manual_master" style="color: #333; font-size: 11px;">Master:</label>
                                <input id="manual_master" type="text" placeholder="0x00" maxlength="4"
                                    style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                                <label for="manual_remote" style="color: #333; font-size: 11px;">Remote:</label>
                                <input id="manual_remote" type="text" placeholder="0x40" maxlength="4"
                                    style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                                <button onclick="setManualAddresses();"
                                    style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    Set
                                </button>
                            </div>
                            <div style="color: #999; font-size: 10px;">
                                Enter hex values (e.g., 0x00, 0x40). Leave empty to keep current.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Modes Subsection -->
                <div id="system-modes-subsection" style="display: none;">
                    <!-- Mode Configuration -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Mode
                            Configuration</div>

                        <!-- Autonomous Mode Control -->
                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Autonomous Mode:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button id="autonomous_start_btn" onclick="startAutonomousMode();"
                                    style="flex: 1; padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 14px; vertical-align: middle;">play_arrow</span>
                                    Start Auto
                                </button>
                                <button id="autonomous_stop_btn" onclick="stopAutonomousMode();"
                                    style="flex: 1; padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 14px; vertical-align: middle;">stop</span>
                                    Stop Auto
                                </button>
                            </div>
                            <div style="color: #999; font-size: 10px;">
                                Sends ping and temperature every 8 seconds. A temperature sensor is required.
                            </div>
                            <div style="margin-top: 4px;">
                                Status: <span id="autonomous_status"
                                    style="font-weight: bold; color: #f44336;">Disabled</span>
                            </div>
                        </div>

                        <!-- Simulation Mode Control -->
                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeaa7;">
                            <div style="color: #856404; font-size: 11px; margin-bottom: 4px;">Simulation Mode:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button id="simulation_mode_enable_btn" onclick="enableSimulationMode();"
                                    style="flex: 1; padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 14px; vertical-align: middle;">computer</span>
                                    Enable Simulation Mode
                                </button>
                                <button id="simulation_mode_disable_btn" onclick="disableSimulationMode();"
                                    style="flex: 1; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 14px; vertical-align: middle;">cancel</span>
                                    Disable Simulation Mode
                                </button>
                            </div>
                            <div style="color: #856404; font-size: 10px;">
                                Simulation mode simulates AC without hardware. All commands update status directly.
                            </div>
                            <div style="margin-top: 4px;">
                                Status: <span id="simulation_mode_status"
                                    style="font-weight: bold; color: #6c757d;">Disabled</span>
                            </div>
                        </div>

                        <!-- Listen Mode Control -->
                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #e3f2fd; border-radius: 4px; border: 1px solid #90caf9;">
                            <div style="color: #0d47a1; font-size: 11px; margin-bottom: 4px;">Listen Mode:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button id="listen_mode_enable_btn" onclick="enableListenMode();"
                                    style="flex: 1; padding: 6px 12px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 14px; vertical-align: middle;">hearing</span>
                                    Enable Listen Mode
                                </button>
                                <button id="listen_mode_disable_btn" onclick="disableListenMode();"
                                    style="flex: 1; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 14px; vertical-align: middle;">cancel</span>
                                    Disable Listen Mode
                                </button>
                            </div>
                            <div style="color: #0d47a1; font-size: 10px;">
                                Listen mode prioritizes serial communication by disabling non-essential operations. Use
                                when capturing AC commands.
                            </div>
                            <div style="margin-top: 4px;">
                                Status: <span id="listen_mode_status"
                                    style="font-weight: bold; color: #6c757d;">Disabled</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Admin Subsection -->
                <div id="system-admin-subsection" style="display: none;">

                    <!-- Serial Configuration -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Serial Port
                            Configuration</div>

                        <!-- Current Configuration Display -->
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Current Configuration:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                <div>
                                    <span style="color: #666;">TX Pin:</span><br>
                                    <span id="current_tx_pin" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">RX Pin:</span><br>
                                    <span id="current_rx_pin" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div style="grid-column: 1 / -1; margin-top: 4px;">
                                    <span style="color: #666;">Buffer Size:</span>
                                    <span id="current_rx_buffer_size" style="color: #002F7A; font-weight: bold;">--</span> bytes
                                </div>
                            </div>
                        </div>

                        <!-- New Configuration Input -->
                        <div
                            style="background: #fff3cd; padding: 8px; border-radius: 4px; border: 1px solid #ffc107; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label for="new_tx_pin"
                                        style="color: #333; font-size: 11px; display: block; margin-bottom: 2px;">
                                        TX Pin (GPIO):
                                    </label>
                                    <input id="new_tx_pin" type="number" min="0" max="16" placeholder="15"
                                        style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                </div>
                                <div>
                                    <label for="new_rx_pin"
                                        style="color: #333; font-size: 11px; display: block; margin-bottom: 2px;">
                                        RX Pin (GPIO):
                                    </label>
                                    <input id="new_rx_pin" type="number" min="0" max="16" placeholder="13"
                                        style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <label for="new_rx_buffer_size"
                                    style="color: #333; font-size: 11px; display: block; margin-bottom: 2px;">
                                    RX Buffer Size (bytes):
                                </label>
                                <input id="new_rx_buffer_size" type="number" min="64" max="2048" step="64" placeholder="256"
                                    style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                            </div>
                            <button onclick="applySerialConfig();"
                                style="width: 100%; padding: 6px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">settings</span>
                                Apply Serial Configuration
                            </button>
                            <div id="serial_config_status" style="margin-top: 6px; font-size: 11px; text-align: center;">
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div style="color: #666; font-size: 10px; margin-top: 8px;">
                            <div style="font-weight: bold; margin-bottom: 2px;">Common Pin Usage:</div>
                            <b>Serial:</b> TX: D8 (GPIO 15) | RX: D7 (GPIO 13)<br>
                            <b>Other:</b> D3 (GPIO 0) FLASH | D4 (GPIO 2) LED
                        </div>
                    </div>
                    <!-- End Serial Configuration -->

                    <!-- I2C Configuration Section -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">
                            I2C Pin Configuration
                        </div>

                        <!-- Current Configuration Display -->
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Current Configuration:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                               <div>
                                    <span style="color: #666;">SDA Pin:</span><br>
                                    <span id="current_sda_pin" style="color: #002F7A; font-weight: bold;">--</span>
                                </div>
                                <div>
                                    <span style="color: #666;">SCL Pin:</span><br>
                                    <span id="current_scl_pin" style="color: #002F7A; font-weight: bold;">--</span> 
                                </div>
                            </div>
                        </div>

                        <!-- New Configuration Input -->
                        <div
                            style="background: #fff3cd; padding: 8px; border-radius: 4px; border: 1px solid #ffc107; margin-bottom: 8px;">
                            <div style="color: #856404; font-size: 11px; margin-bottom: 6px;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">warning</span>
                                Configure I2C pins (requires restart after applying):
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label for="new_sda_pin"
                                        style="color: #333; font-size: 11px; display: block; margin-bottom: 2px;">
                                        SDA Pin (GPIO):
                                    </label>
                                    <input id="new_sda_pin" type="number" min="0" max="16" placeholder="4"
                                        style="width: 50%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                </div>
                                <div>
                                    <label for="new_scl_pin"
                                        style="color: #333; font-size: 11px; display: block; margin-bottom: 2px;">
                                        SCL Pin (GPIO):
                                    </label>
                                    <input id="new_scl_pin" type="number" min="0" max="16" placeholder="5"
                                        style="width: 50%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                </div>
                            </div>
                            <button onclick="applyI2CConfig();"
                                style="width: 100%; padding: 6px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">settings</span>
                                Apply I2C Configuration
                            </button>
                            <div id="i2c_config_status" style="margin-top: 6px; font-size: 11px; text-align: center;">
                            </div>
                        </div>

                        <!-- Reference Info -->
                        <div style="color: #666; font-size: 10px; margin-top: 8px;">
                            <b>D1 Mini Default:</b> SDA=D2 (GPIO4), SCL=D1 (GPIO5)<br>
                            <b>Valid GPIO:</b> 0-16 (avoid GPIO 15, 6-11 reserved for flash)
                        </div>
                    </div>
                    <!-- End I2C Configuration Section -->

                    <!-- Settings -->
                    <div style="margin-top: 12px;">
                        <button onclick="saveSettings();" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 14px; margin: 4px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">save</span>
                            Save Settings
                        </button>
                        
                        <button onclick="loadSettings();" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 14px; margin: 4px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">folder_open</span>
                            Load Settings
                        </button>
                        
                        <button onclick="resetSettings();" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 14px; margin: 4px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete</span>
                            Reset to Defaults
                        </button>
                        
                        <div id="settings_status" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
                    </div> 
                    <!-- End Settings -->
                    
                    <!-- Filemanager -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">
                            File Manager
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <a href="/filemanager"
                                style="display: inline-block; width: 100%; padding: 8px 16px; background: #002F7A; color: white; text-decoration: none; border-radius: 4px; font-size: 13px; cursor: pointer; text-align: center; box-sizing: border-box;">
                                <span class="material-icons"
                                    style="font-size: 16px; vertical-align: middle; margin-right: 4px;">folder_open</span>
                                Open File Manager
                            </a>
                        </div>
                        
                        <div style="color: #666; font-size: 11px;">
                            Upload, download, and manage filesystem files
                        </div>
                    </div>

                    <!-- Restart Device -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">
                            Restart Device
                        </div>
                        
                        <button id="restart_button" onclick="restartDevice();"
                            style="width: 100%; padding: 8px 16px; background: #d32f2f; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">restart_alt</span>
                            Restart Device
                        </button>
                        
                        <div style="color: #666; font-size: 11px; margin-top: 8px;">
                            Restarts the ESP8266 device. All connections will be lost temporarily.
                        </div>
                    </div>
                </div>
            </div>

            <!-- comments -->


            <!-- Debug Controls - Hidden by Default -->
            <div id="debug-controls" style="display: none; margin-bottom: 12px;">

                <!-- Raw Bytes Input Section -->
                <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Send Raw
                    </div>

                    <div
                        style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                        <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Send Raw Bytes:</div>
                        <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                            <input id="raw_bytes_input" type="text" placeholder="00 FE 10 02 80 8A"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                            <button onclick="sendRawBytes();"
                                style="padding: 6px 12px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                Send
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px; font-size: 11px; margin-bottom: 4px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="raw_bytes_crc" value="auto" checked
                                    style="margin-right: 4px;">
                                <span>Auto CRC</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="raw_bytes_crc" value="add" style="margin-right: 4px;">
                                <span>Add CRC</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="raw_bytes_crc" value="none" style="margin-right: 4px;">
                                <span>No CRC</span>
                            </label>
                        </div>
                        <div style="color: #999; font-size: 10px;">
                            <b>Auto:</b> Adds CRC only if not already included (XOR=0 check)<br>
                            <b>Add:</b> Always appends CRC byte<br>
                            <b>No CRC:</b> Sends bytes as-is
                        </div>
                    </div>

                </div>

                <!-- Debug Output -->
                <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Debug AB
                        traffic</div>

                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                            <input id="check_traffic_capture" type="checkbox" checked onchange="toggleTrafficCapture();"
                                style="margin-right: 6px;">
                            <span style="font-weight: bold;">Enable Traffic Capture</span>
                        </label>
                        <div style="color: #666; font-size: 11px; margin-left: 22px;">
                            Uncheck to pause capturing AB bus traffic
                        </div>
                    </div>
                    <!-- Clear All Button -->
                    <div style="background: #fff; border-radius: 8px; padding: 8px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <button onclick="clearAll();"
                            style="width: 100%; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: bold;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete_sweep</span>
                            Clear All Debug Output
                        </button>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                            <input id="check_cmd_timestamp" type="checkbox" style="margin-right: 6px;">
                            <span>Timestamp</span>
                        </label>
                        <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                            <input id="check_cmd_typed" type="checkbox" style="margin-right: 6px;">
                            <span>Commands with type</span>
                        </label>
                        <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Decoded messages:</div>
                        <div id="last_cmd"
                            style="background: #f8f9fa; padding: 6px; border-radius: 4px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; word-break: break-all; text-align: left;">
                            --</div>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <button id="toggle_last_cmd_btn" onclick="toggleLastCmdSize();"
                                style="flex: 1; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">unfold_more</span>
                                Expand
                            </button>
                            <button onclick="copyLastCmd();"
                                style="flex: 1; padding: 4px 8px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">content_copy</span>
                                Copy
                            </button>
                            <button onclick="clearLastCmd();"
                                style="flex: 1; padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">delete</span>
                                Clear
                            </button>
                        </div>
                    </div>

                    <div>
                        <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                            <input id="check_rx" type="checkbox" style="margin-right: 6px;">
                            <span>Enable raw data</span>
                        </label>
                        <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Raw data:</div>
                        <div id="rx_data"
                            style="background: #f8f9fa; padding: 6px; border-radius: 4px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; word-break: break-all; text-align: left;">
                            --
                            <!-- Collapse, copy and clear buttons -->
                        </div>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <button id="toggle_rx_data_btn" onclick="toggleRxDataSize();"
                                style="flex: 1; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">unfold_more</span>
                                Expand
                            </button>
                            <button onclick="copyRxData();"
                                style="flex: 1; padding: 4px 8px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">content_copy</span>
                                Copy
                            </button>
                            <button onclick="clearRxData();"
                                style="flex: 1; padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 12px; vertical-align: middle;">delete</span>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
                <!-- End Debug Output -->

                <!-- System Log Display -->
                <div
                    style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 8px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">
                        System Log
                    </div>
                    <pre id="serial-log"
                        style="background: #f8f8f8; border: 1px solid #ddd; padding: 8px; border-radius: 4px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; margin: 0; white-space: pre-wrap; word-wrap: break-word; text-align: left;">Waiting for messages...
</pre> <!-- keep pre here to force a \n in pre-->

                    <div style="display: flex; gap: 4px; margin-top: 4px;">
                        <button id="toggle_serial_log_btn" onclick="toggleSerialLogSize();"
                            style="flex: 1; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 12px; vertical-align: middle;">unfold_more</span>
                            Expand
                        </button>
                        <button onclick="copySerialLog()"
                            style="flex: 1; padding: 4px 8px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 12px; vertical-align: middle;">content_copy</span>
                            Copy
                        </button>
                        <button onclick="clearSerialLog()"
                            style="flex: 1; padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 12px; vertical-align: middle;">delete</span>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Home Assistant Controls - Hidden by Default -->
            <div id="homeassistant-controls" style="display: none; margin-bottom: 12px;">
                <div
                    style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">MQTT Broker
                        Settings</div>

                    <div style="display: grid; gap: 8px;">
                        <div>
                            <label style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">MQTT
                                Server IP:</label>
                            <input id="mqtt_server" type="text" placeholder="homeassistant.local"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>
                                <label
                                    style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Port:</label>
                                <input id="mqtt_port" type="number" placeholder="1883" min="1" max="65535"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                            </div>
                            <div>
                                <label style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Device
                                    Name:</label>
                                <input id="mqtt_device_name" type="text" placeholder="toshiba_ac"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>
                                <label
                                    style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Username:</label>
                                <input id="mqtt_username" type="text" placeholder="mqtt_user"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                            </div>
                            <div>
                                <label
                                    style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Password:</label>
                                <input id="mqtt_password" type="password" placeholder="mqtt_password"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="saveMQTTConfig();"
                            style="flex: 1; padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle; margin-right: 4px;">save</span>
                            Save Config
                        </button>
                        <button onclick="testMQTTConnection();"
                            style="flex: 1; padding: 8px 12px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle; margin-right: 4px;">wifi_find</span>
                            Test Connection
                        </button>
                        <button onclick="loadMQTTConfig();"
                            style="flex: 1; padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle; margin-right: 4px;">refresh</span>
                            Load Current
                        </button>
                    </div>
                </div>

                <!-- Home Assistant Integration -->
                <div
                    style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Home
                        Assistant Integration</div>

                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <button onclick="sendMQTTDiscovery();"
                            style="flex: 1; padding: 8px 12px; background: #9c27b0; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle; margin-right: 4px;">search</span>
                            Send Discovery
                        </button>
                        <button onclick="resetMQTTDiscovery();"
                            style="flex: 1; padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle; margin-right: 4px;">delete</span>
                            Reset Discovery
                        </button>
                    </div>

                    <div style="color: #666; font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                        <strong>Instructions:</strong><br>
                        1. Configure your MQTT broker settings above<br>
                        2. Click "Save Config" to apply settings<br>
                        3. Click "Send Discovery" to register with Home Assistant<br>
                        4. The climate control should appear in Home Assistant automatically
                    </div>
                </div>
                <!-- End Home Assistant Integration -->

                <!-- MQTT Status -->
                <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                    <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">MQTT Status
                    </div>
                    <div
                        style="display: grid; grid-template-columns: auto 1fr; gap: 4px 8px; font-size: 12px; margin-bottom: 8px;">
                        <span style="color: #666;">Status:</span>
                        <span id="mqtt_status" style="color: #999; font-weight: bold;">Unknown</span>

                        <span style="color: #666;">Server:</span>
                        <span id="mqtt_status_server" style="color: #333; font-family: monospace;">--</span>

                        <span style="color: #666;">Device:</span>
                        <span id="mqtt_status_device" style="color: #333; font-family: monospace;">--</span>
                    </div>

                    <!-- Enable/Disable buttons -->
                    <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                        <button onclick="enableMQTT();"
                            style="flex: 1; padding: 8px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">power</span>
                            Enable MQTT
                        </button>
                        <button onclick="disableMQTT();"
                            style="flex: 1; padding: 8px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <span class="material-icons"
                                style="font-size: 14px; vertical-align: middle;">power_off</span>
                            Disable MQTT
                        </button>
                    </div>

                    <div style="color: #666; font-size: 11px;">
                        Enable or disable MQTT connection to Home Assistant. MQTT must be enabled to send/receive
                        commands.
                    </div>
                </div>
                <!-- End of MQTT Status -->
            </div> 
            <!-- End of Home Assistant Controls -->
        </div> 
        <!-- End of collapsible buttons -->

    </div>

</body>

</html>