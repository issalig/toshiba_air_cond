<!--Description: Main page -->
<!--Project: https://github.com/issalig/toshiba_air_cond -->
<!--Author: Ismael Salvador -->
<!--Date: July 2025 -->

<!DOCTYPE html>
<html>

<head>
    <title>Air conditioning</title>
    <!-- <link href='main.css' rel='stylesheet' type='text/css'> -->
    <!-- begin inline css -->
    <style>

        body {
            background: #f4f8fb;
            font-family: 'Roboto', sans-serif;
            margin: 0;
        }

        .controller-card {
            max-width: 420px;
            margin: 30px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px #002F7A22;
            padding: 24px 18px 18px 18px;
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .status-icon {
            font-size: 32px;
            color: #00878f;
            margin-right: 8px;
        }

        .temp-display {
            font-size: 48px;
            font-weight: bold;
            color: #002F7A;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .temp-display .material-icons {
            font-size: 48px;
            margin-right: 8px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            margin: 18px 0;
        }

        .control-btn {
            flex: 1;
            margin: 0 6px;
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            background: #00878f;
            color: #fff;
            font-size: 20px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 8px #002F7A22;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-btn.active,
        .control-btn:active {
            background: #ffbe0b;
            color: #002F7A;
        }

        .control-btn .material-icons {
            font-size: 28px;
            margin-bottom: 2px;
        }

        .control-btn .material-symbols-outlined {
            font-size: 28px;
            margin-bottom: 2px;
        }

        .timer-section .control-btn {
            margin: 4px 2px;
            padding: 10px 0;
            font-size: 16px;
        }

        .timer-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #00878f;
            color: #fff;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 4px #002F7A22;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-btn:hover {
            background: #006d73;
        }

        .timer-btn.active {
            background: #ffbe0b;
            color: #002F7A;
        }

        .timer-btn .material-icons {
            font-size: 16px;
        }

        .timer-adjust-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            background: #002F7A;
            color: #fff;
            font-size: 12px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 1px 3px #002F7A22;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-adjust-btn:hover {
            background: #004080;
        }

        .timer-adjust-btn .material-icons {
            font-size: 16px;
        }

        @media (max-width: 500px) {
            .controller-card {
                max-width: 98vw;
            }

            .button-row {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .control-btn {
                margin: 6px 4px;
                min-width: 90px;
                flex: 0 1 auto;
            }
        }
    </style>
    <!-- end of inline css -->

    <!--    <link rel="icon" type="image/png" sizes="144x144"  href="/favicon-144x144.png"> -->
    <!--    <link rel="icon" type="image/png" sizes="48x48" href="/favicon.ico"> -->
    <link rel="shortcut icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAAAAAByaaZbAAAA53pUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjadVFbEsMgCPz3FD2CAlE5jmnSmd6gxy8g5jUJMyIC7rIa1t/3E15qUHOgqdTMOUcxYmJoEtTYbTafIpk3Qy/J+ZQPWwEkhXsng/ePfNoA+tYkmg5A7OxpPhfawK8XICdCnUjJFgdqDoTQC4lcVXYClOzNRJlrOUl7D+phdV9YjHMDv56pyKsukzJBgBWVVH3tk6EuwCZ7Eo82kvRITFjMK5BNzDEWRZSJumy7Kqo5jYLL6LL0xQ557MD24kN2OOqO+vd3X40PebfwB1IRdQnTQs4ZAAABI2lDQ1BJQ0MgcHJvZmlsZQAAeJydkL1KxFAQhb+s4h9aKRYiEtB20cZUNqtCEBRiXMHVKptkcTGJIcmy7Bv4JvowWwiCj+ADKFh7brSwMI0Dw3wMM+fMvdCykzAtZ/cgzarC9Tu9q961Pf+GxRaL7LIdhGXe8bxTGuPzVdOKl7bRap77M+aiuAxVp8oszIsKrAOxM65yw0rW7rr+kfhBbEdpFomfxDtRGhk2u36ajMIfTXPNcpxdXpi+chOXE87wsOkzYkhCRVs1U+cYh31Vl4KACSWhakKs3lgzFbeiUkouh6KuSNc0+G3Ufp5c+tIYSss43JNK0/hh/vd77eO83rTWp3lQBHVrRtkaDOD9EVZ6sPoMSzcNXgu/39Yw49Qz/3zjFx6yUIDsQg7GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5gEeCS8zI3I51wAABL5JREFUSMeNVn9oVVUc/3zOe8/Z2j1ibNfQd9Pd0oeu0lZBIEPzHxsqYRmJhUkkQUgEIRiBECWbFYVoQoSFSAaRpFIGiWRQyCiW6KY9FdfymbY317b73K97z/n2x33vbaM97Vwul8/3fM/5fC/n+/18Dy0AUEoPbgNJCwgFxLj1VhBJCIvGiQ4VoaIVERCAMH5REQIgk0KF/z8EFJw7PxSvKYfNqaG9Y9EiwehukuCkURnuGeOhdQvC/x1R6sJXbMqOBDFizYwUABRiQ/kQMP51pmcIFle703Kljep7gwn+TpkgAIU63t+ZkcMjG+pnp4Lc2VZgzl+T9hdVgg6hBEBdHm+sX2B7CphWVz3cvvtI7UhQ9K+rwmjVaNVoFZADhASAdG7ZrvsvHmlfMDN6J3hpVVP1t8/ACUBBOvfjQkMAkERfc5cTACQ9bhns2br2RJ+I9G8g1cGxc77WiqTP81Ia/Q3UAEmXW8bO8PURERONyT7d6HJTf7fnaZI+z0pooshEoc1nqAko120eaiezEkbWGLtLecxwRdBBj6TPDomMscYYuVFk8HjpGjP6kg2tMXZ4FTXp80XZT4/0VYeExhpjI+ltoCbo8QPZpBvUTxKZaEw66ZFkhodHlmpNn50SWWNsmQEer/xKX+v1gY1EpFV7JJX2vMLX9JXPs3FINpLeBqUJl5ujrdqjx50i7e+9Rk1SkT5P9HBWzGBsmYGqBiuD95FDLr3tiwMP1yxrCRwnPa++ruB8P2NdjwNIqagRn7bPM1nlk6THB6+LyHGqGDUO76U3iSFDjSTgXBUADqrTH84KmVix+Z8VSZz6rO63wkykAAtRRYYkwGQoMgCkU11SEM8yYZKZ2o3AxnWrMZoEQIWyxESAqBSVg1Sua37zGlxWMAmcrJcomta806mKAIiN/wEoMgA3XefCx4/Nrk60Lev2gCOnl4AqSmQCHSBMQRWFy4IRgSSYXR4cXQ1Amg7M3XNX9q0OJ0oIef05dZIDtRCIElAASQoELrfYZ7N2zJjIyu/NpH9ZImNs9OTRG3Qn5VJvhpqqp+6j/MsdJKBE5s+uf6DrEwsIrx19vA01KBc04/gF9LjXvNInobWhtNGnx28kiqTl03C51jGDNcaaUvJBefzzwgvDEobWvKpdao+nRH5ear6kN3V6z3LXh8c39InIIbqkomZrC3svKo9Tpreiy+32h8bDp94u+ns+G67/3ejqYgGFxhhjojg1ijW9fbhrLUnP932X5L6Ry01x2vrsLNd0X4PSRd301Nqs6Xh3MUhyzf5rY98puiQVPf5ys39wcCAYGCxcyVAzVj7OyaH16XuinlGbcGZGnXsP1CAoythDd8ImjLJQYRsA6njCmZ7HUyvvvTs53J3dl2U69191BQDUECxa0rhamqkv5Mcdx6UVAQA+2t0rk9U7HKio3qiby4PPLxxMAYU8pa6mQlso5MHaGiDU5z/H0I64y/ieX7kHlSZVyxAlOn3Ggn/sAN6cN+H3xhu7JLp2ANvuM+SSxUmaWL/zx6rGnnArhJQ/Nn14dS0AiFBsqfqAaLxrlrqzUBhPGkBIRRsXoFiClS4DsCBjCNrb3hYmwZgBkxxuCUGxSiYc/oRbz9TwX9V0AeR8vcR8AAAAAElFTkSuQmCC">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="theme-color" content="#00878f">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


    <!-- <script src="WebSocket.js" type="text/javascript"></script> -->

    <!-- begin inline js -->
    <script type=text/javascript>

var power = false;
var save = false;
var debug_cmd = false;
var chart;
var ac_sensor_values=[];
var ac_target_values=[];
var dht_t_values=[25,27,30,25]; //dummy values
var dht_h_values=[60,70,80,90]; //dummy values
var timeStamp = [0,1,2,3];
var chart_obj;

///////////////////////
//Websocket connections
///////////////////////

//small delay not to interrupt the load of files
setTimeout(() => {
  console.log('Waiting 0.6 sec')
}, 600);
 

var connection;

  window.addEventListener('load', onLoad);
  function initWebSocket() {
    try {
        // Defensive: Only try to open a WebSocket if location.hostname is valid
        if (!location.hostname) {
            updateConnectionStatus("error");
            console.error('WebSocket error: location.hostname is empty');
            return;
        }
        // Try to open a WebSocket connection
        connection = new WebSocket('ws://' + location.hostname + ':81/', ['arduino']);
        connection.onopen    = onOpen;
        connection.onclose   = onClose;
        connection.onmessage = onMessage;
        connection.onerror   = onError;
    } catch (e) {
        updateConnectionStatus("error");
        console.error('WebSocket exception:', e);
    }
}

function onOpen(event) {
    console.log('Connection opened');
    updateConnectionStatus("open");
    connection.send('Connect ' + new Date());
    //document.getElementById('connection').textContent = "open";
    
   (function scheduleRequestStatus() {
      //send json            
	  var today = new Date();
      var curr_time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        let data = {
			id: "status",
			value: curr_time
		}
		let json = JSON.stringify(data);
		connection.send(json);
      //end send json

      setTimeout(scheduleRequestStatus, 2 * 1000); //ask for status every X seconds
   })();

   (function scheduleRequestTimeSeries() {	  
		getTimeseries();
      setTimeout(scheduleRequestTimeSeries, 60*1000); //ask for time series every minute
   })();
  }
  function onClose(event) {    
    console.log('WebSocket connection closed');
    updateConnectionStatus("closed");
    console.log('Reconnecting ...');
    setTimeout(initWebSocket, 2000);
  }
  function onMessage(event) {
    console.log('Server: ', event.data);
    processData(event.data);
  }
  
   function onError(e) {
    console.log('WebSocket Error ', e);
    updateConnectionStatus("error");
};

  function onLoad(event) {
    initWebSocket();
  }

////////////////////
// Process requests
////////////////////

function processData(data)
{
  let json = JSON.parse(data); 
  console.log(json);

  if (json.id=="status") parseStatus(json);
  if (json.id=="timeseries") parseTimeSeries(json);
  if (json.id=="debug") parseSerialLog(json);

    // MQTT response handling
    if (json.id && json.id.startsWith("mqtt_")) {
    parseMQTTResponse(json);
    }
}

function parseSerialLog(json) {
    if (json.message) {
        appendSerialLog(json.message);
    }
}

// Global variable to store log lines
let serialLogLines = [];

function appendSerialLog(msg) {
    const log = document.getElementById('serial-log');
    if (log) {
        // Just append the message as-is (it already has \n if needed)
        log.textContent += msg;
        
        // Keep only the last 100 lines by splitting and rejoining
        const lines = log.textContent.split('\n');
        if (lines.length > 100) {
            const trimmedLines = lines.slice(-100);
            log.textContent = trimmedLines.join('\n');
        }
        
        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
    }
}

function clearSerialLog() {
    const log = document.getElementById('serial-log');
    if (log) {
        log.textContent = "";
        serialLogLines = []; // Clear the array too
    }
}

// helper functions for the serial log display
function appendSerialLog00(msg) {
    const log = document.getElementById('serial-log');
    if (log) {
        log.textContent += msg;// + "\n";
        log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
    }
}

function clearSerialLog00() {
    const log = document.getElementById('serial-log');
    if (log) {
        log.textContent = "";
    }
}

function parseStatus(json)
{
  button_pressed_color ='#002F7A';
  button_released_color='#99C0FF';

  if (json.save=='1') save = true; else save=false;
  if (json.power=='1') power = true; else power=false;
  
  document.getElementById('temp').textContent = json.temp;
  document.getElementById('sensor_temp').textContent = json.sensor_temp;
  //document.getElementById('dht_temp').textContent = json.dht_temp;
  //document.getElementById('dht_hum').textContent = json.dht_hum;
  if (json.dht_temp !== undefined && document.getElementById('dht_temp')) {
    document.getElementById('dht_hum').textContent = json.dht_hum;
}
 
  if (json.dht_hum !== undefined && document.getElementById('dht_hum')) {
    document.getElementById('dht_hum').textContent = json.dht_hum;
}
  


  //document.getElementById('sampling_text').value = json.sampling;  
  document.getElementById('decode_errors').textContent = json.decode_errors;

  document.getElementById('heap').textContent = json.heap;

  // Update status icons based on power state
  updateStatusIcons(json);
  

  // parsed rx data
  debug_cmd=document.getElementById('check_cmd').checked;
  debug_cmd_typed=document.getElementById('check_cmd_typed').checked;

  cmdlen=0;
  if (debug_cmd){
	if (json.last_cmd){ //if not null or empty
		textlen = document.getElementById('last_cmd').textContent.length;
		cmdlen = json.last_cmd.length;
		//add last cmd that it is not the same (just compare last 4 characters)
		if (document.getElementById('last_cmd').textContent[textlen-4] != json.last_cmd[cmdlen-4]) { //-2
            // if debug_cmd_typed is checked, add the type of command
            if (debug_cmd_typed && json.last_cmd_type != undefined) {
                document.getElementById('last_cmd').innerHTML += '<br>' + json.last_cmd_type + " " + getCommandTypeString(json.last_cmd_type) + ': ' + json.last_cmd;
            } else {
                document.getElementById('last_cmd').innerHTML += '<br>' + json.last_cmd;
            }
            // Auto-scroll to bottom
            const lastCmdDiv = document.getElementById('last_cmd');
            lastCmdDiv.scrollTop = lastCmdDiv.scrollHeight;
			//document.getElementById('last_cmd').innerHTML +=  json.last_cmd;
			//document.getElementById('last_cmd_type').innerHTML +=  " " + json.last_cmd_type;
		}
    }
  } else document.getElementById('last_cmd').innerHTML = json.last_cmd;

  // raw rx data 
  debug_rx=document.getElementById('check_rx').checked;

  cmdlen=0;
  if (debug_rx){
    if (json.rx_data){ //if not null or empty	
		textlen = document.getElementById('rx_data').textContent.length; //rx_data
		cmdlen = json.rx_data.length;
		//add last rx_data that it is not the same
		//if (document.getElementById('rx_data').textContent[textlen-4] != json.rx_data[cmdlen-4])  //-2
		if (cmdlen > 1) {
			document.getElementById('rx_data').innerHTML += '<br>' + json.rx_data;
            // Auto-scroll to bottom
            const rxDataDiv = document.getElementById('rx_data');
            rxDataDiv.scrollTop = rxDataDiv.scrollHeight;
        }
    }
  } else document.getElementById('rx_data').innerHTML = json.rx_data;
    
  //document.getElementById('timer_time').textContent = json.timer_time;
  document.getElementById('timer_pending').textContent = json.timer_pending;


  //reset color
  document.getElementById('fan_low').style.backgroundColor = button_released_color;
  document.getElementById('fan_medium').style.backgroundColor = button_released_color;
  document.getElementById('fan_high').style.backgroundColor = button_released_color;
  document.getElementById('fan_auto').style.backgroundColor = button_released_color;
 
  document.getElementById('mode_fan').style.backgroundColor = button_released_color;
  document.getElementById('mode_dry').style.backgroundColor = button_released_color;
  document.getElementById('mode_cool').style.backgroundColor = button_released_color;
  document.getElementById('mode_heat').style.backgroundColor = button_released_color;
  document.getElementById('mode_auto').style.backgroundColor = button_released_color;
  
  document.getElementById('power_on').style.backgroundColor = button_released_color;
  document.getElementById('power_off').style.backgroundColor = button_released_color;

  document.getElementById('save_button').style.backgroundColor = button_released_color;

  document.getElementById('sw_set_timer_button').style.backgroundColor = button_released_color;
  

  //set color
  if (json.fan == 'LOW') { document.getElementById('fan_low').style.backgroundColor = button_pressed_color;}
  else if (json.fan == 'MED') { document.getElementById('fan_medium').style.backgroundColor = button_pressed_color; }
  else if (json.fan == 'HIGH') { document.getElementById('fan_high').style.backgroundColor = button_pressed_color; }
  else if (json.fan == 'AUTO') { document.getElementById('fan_auto').style.backgroundColor = button_pressed_color; }       
  
  if (json.mode == 'DRY') { document.getElementById('mode_dry').style.backgroundColor = button_pressed_color;}
  else if (json.mode == 'COOL') { document.getElementById('mode_cool').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'FAN') { document.getElementById('mode_fan').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'HEAT') { document.getElementById('mode_heat').style.backgroundColor = button_pressed_color; }
  else if (json.mode == 'AUTO') { document.getElementById('mode_auto').style.backgroundColor = button_pressed_color; }
    
  if (json.power == '1') { document.getElementById('power_on').style.backgroundColor = button_pressed_color;} 
  else { document.getElementById('power_off').style.backgroundColor = button_pressed_color;} 
  
  if (json.save == '1') { document.getElementById('save_button').style.backgroundColor = button_pressed_color;}
  
  if (json.timer_enabled =='1')   {
    document.getElementById('sw_set_timer_button').style.backgroundColor = button_pressed_color;
  }
  
    // Update timer status display
    const timerStatusElem = document.getElementById('timer_status');
    const timerPendingElem = document.getElementById('timer_pending');

    // Update timer_pending as before
    if (timerPendingElem) {
        timerPendingElem.textContent = json.timer_pending;
    }

    // Update timer_status based on timer state
    if (timerStatusElem) {
        if (json.timer_enabled){
        // Timer is active - show mode and pending time
        const timerMode = json.timer_mode == '1' ? 'ON' : 'OFF';
        timerStatusElem.textContent = `${timerMode} ${json.timer_pending} / ${json.timer_time} min`;
        } else {
        // Timer is not active - show nothing
        timerStatusElem.textContent = '';
        }
    }
  
  //document.getElementById('indoor_room_temp').textContent = json.indoor_room_temp;
  //document.getElementById('indoor_ta').textContent = json.indoor_ta;
  //document.getElementById('indoor_tcj').textContent = json.indoor_tcj;
  //document.getElementById('indoor_tc').textContent = json.indoor_tc;
  //document.getElementById('indoor_filter_time').textContent = json.indoor_filter_time;
  document.getElementById('outdoor_te').textContent = json.outdoor_te;
  //document.getElementById('outdoor_to').textContent = json.outdoor_to;
  //document.getElementById('outdoor_td').textContent = json.outdoor_td;
  //document.getElementById('outdoor_ts').textContent = json.outdoor_ts;
  //document.getElementById('outdoor_ths').textContent = json.outdoor_ths;
  //document.getElementById('outdoor_current').textContent = json.outdoor_current;
  //document.getElementById('outdoor_cumhour').textContent = json.outdoor_cumhour;
  
  document.getElementById('indoor_fan_speed').textContent = json.indoor_fan_speed;
  //document.getElementById('indoor_fan_run_time').textContent = json.indoor_fan_run_time;
  
  //document.getElementById('outdoor_tl').textContent = json.outdoor_tl;
  //document.getElementById('outdoor_comp_freq').textContent = json.outdoor_comp_freq;
  //document.getElementById('outdoor_lower_fan_speed').textContent = json.outdoor_lower_fan_speed;
  //document.getElementById('outdoor_upper_fan_speed').textContent = json.outdoor_upper_fan_speed;
  
  var d = new Date(parseInt(json.boot_time*1000));
  document.getElementById('boot_time').innerHTML = d.toLocaleTimeString() + " " + d.toLocaleDateString()
  
  document.getElementById('ip').textContent = json.ip;  

   
    if (json.mqtt_config) {
        // Update the form fields with current configuration
        document.getElementById('mqtt_server').value = json.mqtt_config.server || '';
        document.getElementById('mqtt_port').value = json.mqtt_config.port || 1883;
        document.getElementById('mqtt_username').value = json.mqtt_config.username || '';
        document.getElementById('mqtt_password').value = json.mqtt_config.password || '';
        document.getElementById('mqtt_device_name').value = json.mqtt_config.device_name || '';
    }
    
    // Update MQTT status display
    if (json.mqtt !== undefined) {
        const statusElem = document.getElementById('mqtt_status');
        if (statusElem) {
            if (json.mqtt == true) {
                statusElem.textContent = 'Connected';
                statusElem.style.color = '#4caf50';
            } else {
                statusElem.textContent = 'Disconnected';
                statusElem.style.color = '#f44336';
            }
        }
    }

    // Update autonomous mode status
    if (json.autonomous !== undefined) {
        const statusElem = document.getElementById('autonomous_status');
        if (statusElem) {
        if (json.autonomous == true) {
            statusElem.textContent = 'Active';
            statusElem.style.color = '#4caf50';
        } else {
            statusElem.textContent = 'Disabled';
            statusElem.style.color = '#f44336';
        }
        }
    }

    // Update address displays
    if (json.master !== undefined) {
        document.getElementById('current_master').textContent = '0x' + json.master.toString(16).toUpperCase().padStart(2, '0');
    }
    if (json.remote !== undefined) {
        document.getElementById('current_remote').textContent = '0x' + json.remote.toString(16).toUpperCase().padStart(2, '0');
    }
    if (json.observed_master !== undefined) {
        const observedMasterElem = document.getElementById('observed_master');
        if (json.observed_master === 255) { // 0xFF means not detected yet
        observedMasterElem.textContent = '0x--';
        observedMasterElem.style.color = '#999';
        } else {
        observedMasterElem.textContent = '0x' + json.observed_master.toString(16).toUpperCase().padStart(2, '0');
        observedMasterElem.style.color = '#28a745';
        }
    }
    if (json.observed_remotes !== undefined && Array.isArray(json.observed_remotes)) {
        const observedRemotesElem = document.getElementById('observed_remotes');
        if (json.observed_remotes.length === 0) {
            observedRemotesElem.textContent = '0x--';
            observedRemotesElem.style.color = '#999';
        } else {
            observedRemotesElem.textContent = json.observed_remotes
                .map(val => '0x' + val.toString(16).toUpperCase().padStart(2, '0'))
                .join(', ');
            observedRemotesElem.style.color = '#28a745';
        }
    }
    if (json.id === "reset_observed_remotes") {
    console.log("Observed remotes cleared:", json.message);
    // Update UI to show empty observed remotes
    const observedRemotesElem = document.getElementById('observed_remotes');
    if (observedRemotesElem) {
        observedRemotesElem.textContent = '0x--';
        observedRemotesElem.style.color = '#999';
    }
}

}

function getCommandTypeString(cmdType) {
    switch(cmdType) {
        case 0: return '[UNKNOWN]';
        case 1: return '[SENSOR_ERROR]';
        case 2: return '[STATUS]';
        case 3: return '[STATUS_EXT]';
        case 4: return '[MASTER_ACK]';
        case 5: return '[MASTER_ALIVE]';
        case 6: return '[STATUS_MODE]';
        case 7: return '[SENSOR_ANSWER]';
        default: return '[TYPE_' + cmdType + ']';
    }
}

// Handle MQTT-specific responses
function parseMQTTResponse(json) {
    if (json.id === "mqtt_config") {
        if (json.status === "saved") {
            alert('MQTT configuration saved successfully!');
        } else if (json.status === "error") {
            alert('Error saving MQTT configuration: ' + (json.message || 'Unknown error'));
        }
    }
    
    if (json.id === "mqtt_test") {
        if (json.status === "connected") {
            alert('MQTT connection test successful!');
        } else if (json.status === "failed") {
            alert('MQTT connection test failed: ' + (json.message || 'Unknown error'));
        }
    }
    
    if (json.id === "mqtt_discovery") {
        if (json.status === "sent") {
            alert('Discovery messages sent to Home Assistant!');
        } else if (json.status === "reset") {
            alert('Discovery messages reset. Device removed from Home Assistant.');
        }
    }

        updateHVACControl(json);

}


// Function to update status icons
function updateStatusIcons(json) {
    const statusIconsContainer = document.getElementById('status-icons');
    
    if (json.power == '1') {
        // Power is ON - show mode and fan icons
        let modeIcon = '';
        let fanIcon = '';
        let flagsIcon = '';
        
        // Mode icons
        switch(json.mode) {
            case 'COOL':
                modeIcon = '<span class="material-icons" style="color:#2196f3;" title="Cool">ac_unit</span>';
                break;
            case 'HEAT':
                modeIcon = '<span class="material-symbols-outlined" style="color:#ff9800;" title="Heat">sunny</span>';
                break;
            case 'DRY':
                modeIcon = '<span class="material-icons" style="color:#795548;" title="Dry">opacity</span>';
                break;
            case 'FAN':
                modeIcon = '<span class="material-symbols-outlined" style="color:#4caf50;" title="Fan">mode_fan</span>';
                break;
            case 'AUTO':
                modeIcon = '<span class="material-icons" style="color:#9c27b0;" title="Auto">hdr_auto</span>';
                break;
            default:
                modeIcon = '<span class="material-icons" style="color:#9e9e9e;" title="Unknown">help_outline</span>';
        }
        
        // Fan speed icons - different icons for each speed
        // Using density icons for fan speeds may seem counterintuitive because they are inversely related
        switch(json.fan) {
            case 'LOW':
                fanIcon = '<span class="material-icons" style="color:#4caf50;" title="Low">density_large</span>';
                break;
            case 'MED':
                fanIcon = '<span class="material-icons" style="color:#ff9800;" title="Medium">density_medium</span>';
                break;
            case 'HIGH':
                fanIcon = '<span class="material-icons" style="color:#f44336;" title="High">density_small</span>';
                break;
            case 'AUTO':
                fanIcon = '<span class="material-icons" style="color:#2196f3;" title="Auto">hdr_auto</span>';
                break;
            default:
                fanIcon = '<span class="material-icons" style="color:#9e9e9e;" title="Unknown">quenstion_mark</span>';
        }
        
        // Timer icon if timer is enabled
        let timerIcon = '';
        if (json.timer_enabled == '1') {
            const timerMode = json.timer_mode == '1' ? 'on' : 'off';
            const timerColor = timerMode === 'on' ? '#4caf50' : '#f44336';
            const pendingTime = json.timer_pending || '0';
            
            //timerIcon = `<span class="material-icons" style="color:${timerColor};" title="Timer ${timerMode.toUpperCase()}: ${pendingTime} min">timer</span>`;
            timerIcon = `<span class="material-icons" style="color:${timerColor};" title="Timer ${timerMode.toUpperCase()}: ${pendingTime} min remaining">timer</span><span style="color:${timerColor}; font-size:10px; margin-left:2px;">${pendingTime}</span>`;
        }

        // add save icon if save is enabled and use a green color
        if (json.save == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#4caf50;" title="Save">energy_savings_leaf</span>';
        }

        // add filter alert icon if json.filter_alert exists and is 1
        if (json.filter_alert == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#f44336;" title="Filter">grid_on/span>';
        }

        //add preheat icon if json.preheat exists and is 1
        if (json.preheat == '1') {
            flagsIcon += ' <span class="material-icons" style="color:#ff9800;" title="Heat">fireplace</span>';
        }

        // Add MQTT status icon
        let mqttIcon = '';
        if (json.mqtt !== undefined) {
            if (json.mqtt == true) {
                mqttIcon = ' <span class="material-icons" style="color:#4caf50;" title="MQTT Connected">home</span>';
            } else {
                mqttIcon = ' <span class="material-icons" style="color:#f44336;" title="MQTT Disconnected">home</span>';
            }
        }

        statusIconsContainer.innerHTML = flagsIcon + ' ' + modeIcon + ' ' + fanIcon + mqttIcon + timerIcon;
    } else {
        // Power is OFF - show only power off icon and timer if enabled
        let timerIcon = '';
        if (json.timer_enabled == '1') {
            const timerMode = json.timer_mode == '1' ? 'on' : 'off';
            const timerColor = timerMode === 'on' ? '#4caf50' : '#f44336';
            const pendingTime = json.timer_pending || '0';
            
            timerIcon = ` <span class="material-icons" style="color:${timerColor};" title="Timer ${timerMode.toUpperCase()}: ${pendingTime} min">timer</span>`;
        }
        
        // Add MQTT status icon even when power is off
        let mqttIcon = '';
        if (json.mqtt !== undefined) {
            if (json.mqtt == true) {
                mqttIcon = ' <span class="material-icons" style="color:#4caf50;" title="MQTT Connected">home</span>';
            } else {
                mqttIcon = ' <span class="material-icons" style="color:#f44336;" title="MQTT Disconnected">home</span>';
            }
        }
        
        statusIconsContainer.innerHTML = '<span class="material-icons" style="color:#f44336;" title="Off">power_off</span>' + mqttIcon + timerIcon;
    }
}

// Helper function to send command and request status
function sendRequestStatus(data) {
    //let json = JSON.stringify(data);
    //connection.send(json);
    //console.log('Send: ' + json);
    
    // Request status update after a short delay to allow command processing
    setTimeout(() => {
        let statusData = {
            id: "status",
            value: new Date().getHours() + ":" + new Date().getMinutes() + ":" + new Date().getSeconds()
        };
        let statusJson = JSON.stringify(statusData);
        connection.send(statusJson);
        console.log('Auto status request: ' + statusJson);
    }, 100); // 100ms delay
}


function power_on() {
    let data = {
       id : "power",
       value : "on"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('power_on').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function power_off() {
    let data = {
       id : "power",
       value : "off"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('power_off').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function save_toggle() {
	var save_value;
	if (save) save_value = "0"; else save_value = "1";	
    let data = {
       id : "save",
       value : save_value
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);

    //if save_value is 1 use button_pressed_color, else button_released_color
    if (save_value == "1") {
        document.getElementById('save_button').style.backgroundColor = button_pressed_color;
    } else {
        document.getElementById('save_button').style.backgroundColor = button_released_color;
    }
    
    sendRequestStatus(data);
}

function mode_fan() {
    let data = {
       id : "mode",
       value : "fan"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_fan').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function mode_dry() {
    let data = {
       id : "mode",
       value : "dry"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_dry').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function mode_cool() {
    let data = {
       id : "mode",
       value : "cool"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_cool').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function mode_heat() {
    let data = {
       id : "mode",
       value : "heat"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_heat').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function mode_auto() {
    let data = {
       id : "mode",
       value : "auto"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('mode_auto').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function fan_low() {
    let data = {
       id : "fan",
       value : "low"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_low').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function fan_medium() {
    let data = {
       id : "fan",
       value : "medium"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_medium').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function fan_high() {
    let data = {
       id : "fan",
       value : "high"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_high').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function fan_auto() {
    let data = {
       id : "fan",
       value : "auto"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('fan_auto').style.backgroundColor = button_pressed_color;
    sendRequestStatus(data);
}

function temp_plus() {
    let data = {
       id : "temp",
       temp : "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    sendRequestStatus(data);
}

function temp_minus() {
    let data = {
       id : "temp",
       temp : "0"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json); 
    sendRequestStatus(data);
}

function timer_changed() {
	document.getElementById('timer_time').textContent  = document.getElementById('timer_range').value;
}

function setTimerValue(minutes) {
    // Defensive: only update if elements exist
    var timerTimeElem = document.getElementById('timer_time');
    if (timerTimeElem) timerTimeElem.textContent = minutes;

    // Remove active class from timer duration buttons only (not mode buttons)
    const timerDurationBtns = document.querySelectorAll('.timer-btn:not(#timer_mode_off):not(#timer_mode_on)');
    timerDurationBtns.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#00878f';
        btn.style.color = '#fff';
    });

    // Add active class to clicked button (only if event and event.target exist and it's a duration button)
    if (window.event && window.event.target && window.event.target.classList.contains('timer-btn') && 
        window.event.target.id !== 'timer_mode_off' && window.event.target.id !== 'timer_mode_on') {
        window.event.target.classList.add('active');
        window.event.target.style.background = '#ffbe0b';
        window.event.target.style.color = '#002F7A';
    }
}

function adjustTimer(delta) {
    const currentValue = parseInt(document.getElementById('timer_time').textContent);
    let newValue = currentValue + delta;
    
    // Keep within reasonable bounds (0 to 120 minutes)
    newValue = Math.max(0, Math.min(120, newValue));
    
    document.getElementById('timer_time').textContent = newValue;
    
    // Remove active state from preset duration buttons only (not mode buttons)
    const timerDurationBtns = document.querySelectorAll('.timer-btn:not(#timer_mode_off):not(#timer_mode_on)');
    timerDurationBtns.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#00878f';
        btn.style.color = '#fff';
    });
}

function toggleTimerControls00() {
    const timerControls = document.getElementById('timer-controls');
    const expandIcon = document.getElementById('timer-expand-icon');
    
    if (timerControls.style.display === 'none') {
        timerControls.style.display = 'block';
        expandIcon.textContent = 'expand_less';
        expandIcon.style.transform = 'rotate(180deg)';
    } else {
        timerControls.style.display = 'none';
        expandIcon.textContent = 'expand_more';
        expandIcon.style.transform = 'rotate(0deg)';
    }
}

function toggleTimerControls() {
    const timerControls = document.getElementById('timer-controls');
    const timerIcon = document.querySelector('[onclick="toggleTimerControls()"]');
    
    if (timerControls.style.display === 'none') {
        timerControls.style.display = 'block';
        // Mark as expanded with border and shadow
        timerIcon.style.border = '2px solid #002F7A';
        timerIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        timerControls.style.display = 'none';
        // Mark as collapsed
        timerIcon.style.border = '2px solid #e9ecef';
        timerIcon.style.boxShadow = 'none';
    }
}


function setTimerMode(mode) {
    const offBtn = document.getElementById('timer_mode_off');
    const onBtn = document.getElementById('timer_mode_on');
    
    // Reset both buttons
    offBtn.style.background = '#00878f';
    offBtn.style.color = '#fff';
    onBtn.style.background = '#00878f';
    onBtn.style.color = '#fff';
    
    // Set active button
    if (mode === 'off') {
        offBtn.style.background = '#ffbe0b';
        offBtn.style.color = '#002F7A';        
    } else {
        onBtn.style.background = '#ffbe0b';
        onBtn.style.color = '#002F7A';        
    }
}

function toggleDebugControls() {
    const debugControls = document.getElementById('debug-controls');
    const debugIcon = document.querySelector('[onclick="toggleDebugControls()"]');
    
    if (debugControls.style.display === 'none') {
        debugControls.style.display = 'block';
        debugIcon.style.border = '2px solid #002F7A';
        debugIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        debugControls.style.display = 'none';
        debugIcon.style.border = '2px solid #e9ecef';
        debugIcon.style.boxShadow = 'none';
    }
}

function reset_sw_air_timer(){	
    let data = {
       id : "timer",
       timer_mode : 2,  //TIMER_SW_OFF 0, TIMER_SW_ON  1, TIMER_SW_RESET  2
       timer_time : "0"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('sw_set_timer_button').style.backgroundColor = button_released_color;
}

// Add this variable at the top with other global variables
var currentTimerMode = 'off'; // Default to 'off'

// Update the setTimerMode function
function setTimerMode(mode) {
    currentTimerMode = mode; // Store the current mode
    
    const offBtn = document.getElementById('timer_mode_off');
    const onBtn = document.getElementById('timer_mode_on');
    
    // Reset both buttons
    offBtn.style.background = '#00878f';
    offBtn.style.color = '#fff';
    onBtn.style.background = '#00878f';
    onBtn.style.color = '#fff';
    
    // Set active button
    if (mode === 'off') {
        offBtn.style.background = '#ffbe0b';
        offBtn.style.color = '#002F7A';        
    } else {
        onBtn.style.background = '#ffbe0b';
        onBtn.style.color = '#002F7A';        
    }
}

// Update the set_sw_air_timer function
function set_sw_air_timer(){
    const timerTime = document.getElementById('timer_time').textContent;
    const val = currentTimerMode === 'off' ? 0 : 1;
    
    let data = {
       id : "timer",
       timer_mode : val, //TIMER_SW_OFF 0, TIMER_SW_ON  1, TIMER_SW_RESET  2
       timer_time : timerTime
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json); 
}

function timer_hw_cancel() {
    let data = {
       id : "timer_hw",
       value : "cancel",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_off() {
    let data = {
       id : "timer_hw",
       value : "off",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_pressed_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_repeat_off() {
    let data = {
       id : "timer_hw",
       value : "repeat_off",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_pressed_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_released_color;
}

function timer_hw_on() {
    let data = {
       id : "timer_hw",
       value : "on",
       time: "1"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
    
    document.getElementById('timer_hw_repeat_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_off').style.backgroundColor = button_released_color;
    document.getElementById('timer_hw_on').style.backgroundColor = button_pressed_color;
}

//time series request
function getTimeseries() {
    let data = {
       id : "timeseries",
       value : "all"
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
}

function set_sampling() {
    let data = {
       id : "sampling",
       value : parseInt(document.getElementById('sampling_text').value)
    }
    let json = JSON.stringify(data);
 
    connection.send(json);
    console.log('Send: ' + json);
}

function showGraph()
{
    
    var ctx = document.getElementById("temp_chart").getContext('2d');
    
    // Color palette - Chart.js 4.x compatible
    const colors = {
        primary: '#3B82F6',      // Blue
        secondary: '#10B981',    // Green
        accent: '#F59E0B',       // Amber
        danger: '#EF4444',       // Red
        purple: '#8B5CF6',       // Purple
        background: '#F8FAFC',   // Light gray
        text: '#1F2937'          // Dark gray
    };
    
    var config={
        type: 'line',
        data: {
            labels: ['Loading...'],
            datasets: [{
                label: 'AC Sensor',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.danger,
                borderColor: colors.danger,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: colors.danger,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                data: [],
            },{
                label: 'Room Temperature',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: colors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                data: [],
            },{
                label: 'Room Humidity',
                yAxisID: 'humidity',
                fill: false,
                backgroundColor: colors.secondary,
                borderColor: colors.secondary,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: colors.secondary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                data: [],
            },{
                label: 'BMP Pressure',
                yAxisID: 'pressure',
                fill: false,
                backgroundColor: colors.purple,
                borderColor: colors.purple,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: colors.purple,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                data: [],
            },{
                label: 'External Temp',
                yAxisID: 'temperature',
                fill: false,
                backgroundColor: colors.accent,
                borderColor: colors.accent,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: colors.accent,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                data: [],
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: "Temperature & Humidity Chart",
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: colors.text,
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 15,
                        font: {
                            size: 12
                        },
                        color: colors.text
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: colors.text,
                    bodyColor: colors.text,
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.dataset.yAxisID === 'temperature') {
                                    label += context.parsed.y + '°C';
                                } else if (context.dataset.yAxisID === 'humidity') {
                                    label += context.parsed.y + '%';
                                } else if (context.dataset.yAxisID === 'pressure') {
                                    label += context.parsed.y + ' mb';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        color: '#F3F4F6',
                        drawBorder: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        maxTicksLimit: 8
                    }
                },
                temperature: {
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 36,
                    title: {
                        display: true,
                        text: 'Temperature (°C)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        color: '#F3F4F6',
                        drawBorder: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                },
                humidity: {
                    type: 'linear',
                    position: 'right',
                    min: 35,
                    max: 80,
                    title: {
                        display: true,
                        text: 'Humidity (%)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                pressure: {
                    type: 'linear',
                    position: 'right',
                    min: 950,
                    max: 1050,
                    display: false, // Hide by default, show when pressure data is available
                    title: {
                        display: true,
                        text: 'Pressure (mb)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: colors.text
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: colors.text,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + ' mb';
                        }
                    }
                }
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            elements: {
                point: {
                    hoverBorderWidth: 3
                }
            }
        }
    };

    // Create chart
    chart_obj = new Chart(ctx, config);
    //window.chart_obj_modern = chart_obj; // Point to the same chart instance    
}

function toggleGraphControls() {
    const graphControls = document.getElementById('graph-controls');
    const graphIcon = document.querySelector('[onclick="toggleGraphControls()"]');
    
    if (graphControls.style.display === 'none') {
        graphControls.style.display = 'block';
        graphIcon.style.border = '2px solid #002F7A';
        graphIcon.style.boxShadow = '0 2px 8px #002F7A44';
        
        // Initialize chart if needed
        if (!chart_obj) {
            console.log('Creating chart...');
            showGraph();
        } else {
            console.log('Chart already exists, updating ranges...');
            updateChartRanges();
        }
    } else {
        graphControls.style.display = 'none';
        graphIcon.style.border = '2px solid #e9ecef';
        graphIcon.style.boxShadow = 'none';
    }
}

function updateChartRanges() {
    if (!window.chart_obj) return;
    
    console.log('Updating chart ranges...');
    
    // Get current data from all datasets
    const datasets = window.chart_obj.data.datasets;
    let tempValues = [];
    let humidityValues = [];
    let pressureValues = [];
    
    // Debug: log datasets info
    console.log('Chart datasets:', datasets.length);
    
    // Collect all temperature values (datasets 0, 1, 4 - AC Sensor, Room Temp, External Temp)
    datasets.forEach((dataset, index) => {
        if (dataset && dataset.data && Array.isArray(dataset.data)) {
            //console.log(`Dataset ${index} (${dataset.label}):`, dataset.data.slice(0, 10), '... length:', dataset.data.length);
            
            if (dataset.yAxisID === 'temperature') {
                // Filter valid temperature values (between -20 and 60)
                const validTemps = dataset.data.filter(v => typeof v === 'number' && v > -20 && v < 60 && v !== 0);
                tempValues = tempValues.concat(validTemps);
                //console.log(`Added ${validTemps.length} temperature values from ${dataset.label}`);
            } else if (dataset.yAxisID === 'humidity') {
                // Filter valid humidity values (between 0 and 100)
                const validHumidity = dataset.data.filter(v => typeof v === 'number' && v > 0 && v <= 100);
                humidityValues = humidityValues.concat(validHumidity);
                //console.log(`Added ${validHumidity.length} humidity values from ${dataset.label}`);
            } else if (dataset.yAxisID === 'pressure') {
                // Filter valid pressure values (between 800 and 1200)
                const validPressure = dataset.data.filter(v => typeof v === 'number' && v > 800 && v < 1200);
                pressureValues = pressureValues.concat(validPressure);
                //console.log(`Added ${validPressure.length} pressure values from ${dataset.label}`);
            }
        }
    });
    
    //console.log('Collected values:');
    //console.log('Temperature values:', tempValues.length, tempValues.slice(0, 10));
    //console.log('Humidity values:', humidityValues.length, humidityValues.slice(0, 10));
    //console.log('Pressure values:', pressureValues.length, pressureValues.slice(0, 10));
    
    // Calculate adaptive ranges with 10% margin
    function calculateRange(values, defaultMin, defaultMax) {
        if (values.length === 0) {
            //console.log('No values, using defaults:', defaultMin, defaultMax);
            return { min: defaultMin, max: defaultMax };
        }
        
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min;
        const margin = Math.max(range * 0.1, 1); // At least 1 unit margin
        
        const newMin = Math.max(0, Math.floor(min - margin));
        const newMax = Math.ceil(max + margin);
        
        //console.log(`Range calculation: min=${min}, max=${max}, range=${range}, margin=${margin}, newMin=${newMin}, newMax=${newMax}`);
        
        return {
            min: newMin,
            max: newMax
        };
    }
    
    const tempRange = calculateRange(tempValues, 0, 36);
    const humidityRange = calculateRange(humidityValues, 35, 80);
    const pressureRange = calculateRange(pressureValues, 950, 1050);
    
    //console.log('Calculated ranges:');
    //console.log('Temperature:', tempRange);
    //console.log('Humidity:', humidityRange);
    //console.log('Pressure:', pressureRange);
    
    // Update chart scales
    if (window.chart_obj.options.scales.temperature) {
        window.chart_obj.options.scales.temperature.min = tempRange.min;
        window.chart_obj.options.scales.temperature.max = tempRange.max;
    }
    if (window.chart_obj.options.scales.humidity) {
        window.chart_obj.options.scales.humidity.min = humidityRange.min;
        window.chart_obj.options.scales.humidity.max = humidityRange.max;
    }
    if (window.chart_obj.options.scales.pressure) {
        window.chart_obj.options.scales.pressure.min = pressureRange.min;
        window.chart_obj.options.scales.pressure.max = pressureRange.max;
    }
    
    // Force chart update
    chart_obj.update();
}
 
//check for time labeling
//https://www.chartjs.org/samples/latest/scales/time/line.html

function getMinNoZero(data){
    let min = 9999999;
    let datalen = data.length;
    for(let i = 0; i < datalen; i++){
        // Ignore null and only consider numbers
        if (data[i] !== null && typeof data[i] === 'number' && data[i] < min && data[i] !== 0){
            min = data[i];
        }
    }
    if (min == 9999999) min = 0; // all zeroes or invalid
    if (min < -50) min = 0; // if min is too low, set to 0 
    return min;
}

//sometimes arduinojson sends unexpected big values, just filter them
function getMaxWithLimits(data){
    let max = -1500;
    let datalen = data.length;
    for(let i = 0; i < datalen; i++){
        // Ignore null and only consider numbers
        if (data[i] !== null && typeof data[i] === 'number' && data[i] > max && data[i] < 1500){
            max = data[i];
        }
    }
    if (max == -1500) max = 0;
    if (max > 10000) max = 10000; // if max is too high, set to 10000
    return max;
}

function parseTimeSeries(json){
    datalen=json.n;
    console.log(datalen);

    if (!chart_obj) showGraph();
    //https://stackoverflow.com/questions/49360165/chart-js-update-function-chart-labels-data-will-not-update-the-chart
    //update chart
    
    if (json.val == "timestamp"){
		 timeStamp=[]; 

		for(i=0;i<datalen;i++){
			const date = new Date(json.timestamp[i] * 1000);
			timeStamp.push(date.toLocaleTimeString('en-US', { 
				hour: '2-digit', 
				minute: '2-digit',
				hour12: false 
			}));
		} 

		chart_obj.data.labels=timeStamp;
	}
	
    if (json.val == "ac_sensor_t") {
        chart_obj.data.datasets[0].data=json.ac_sensor_t;
    }
    if (json.val == "dht_t") {
        chart_obj.data.datasets[1].data=json.dht_t;
    }
    if (json.val == "dht_h") {        
        chart_obj.data.datasets[2].data=json.dht_h;
    }
    if (json.val == "bmp_p") {   
        chart_obj.data.datasets[3].data=json.bmp_p;
    }
    if (json.val == "te") {           
        chart_obj.data.datasets[4].data=json.te;
    }

    //chart_obj.data.datasets[3].backgroundColor= 'rgba('+Math.floor()*255+','+Math.floor()*255+','+Math.floor()*255+', 1)';
	//chart_obj.data.datasets[3].borderColor= chart_obj.data.datasets[3].backgroundColor;

    //window.
    chart_obj.update();
    
    // Update adaptive ranges after data is loaded
    setTimeout(updateChartRanges, 100);
    
    //compute min/max
    if (json.val == "dht_t"){
        // Defensive: filter only valid numbers for min/max
        let valid = (json.dht_t || []).filter(v => v !== null && typeof v === 'number' && v > -50 && v < 100);
        let min = valid.length ? Math.min(...valid) : 0;
        let max = valid.length ? Math.max(...valid) : 0;
        document.getElementById('dht_temp_min').textContent = min;
        document.getElementById('dht_temp_max').textContent = max;      
    }

    if (json.val == "dht_h"){        
		document.getElementById('dht_hum_min').textContent  = getMinNoZero(json.dht_h);
		document.getElementById('dht_hum_max').textContent  = getMaxWithLimits(json.dht_h);
	}
	if (json.val == "bmp_p"){
		document.getElementById('bmp_pres_min').textContent = getMinNoZero(json.bmp_p);
		document.getElementById('bmp_pres_max').textContent = getMaxWithLimits(json.bmp_p);
	}
}



//Update connection status with icon
function updateConnectionStatus(status) {
    const connElem = document.getElementById('connection');
    if (!connElem) return;
    let icon = '';
    let color = '';
    let status_text = '';
    if (status === "open") {
        icon = '<span class="material-icons" style="color:#4caf50;vertical-align:middle;" title="Wifi Connected">wifi</span>';
        color = "#4caf50";
        status_text = "Connected";
    } else if (status === "closed") {
        icon = '<span class="material-icons" style="color:#f44336;vertical-align:middle;" title="Wifi Disconnected">wifi_off</span>';
        color = "#f44336";
        status_text = "Disconnected";
    } else if (status === "error") {
        icon = '<span class="material-icons" style="color:#ff9800;vertical-align:middle;" title="Error">error_outline</span>';
        color = "#ff9800";
        status_text = "Error";
    } else {
        icon = '<span class="material-icons" style="color:#9e9e9e;vertical-align:middle;" title="Unknown">help_outline</span>';
        color = "#9e9e9e";
        status_text = "Unknown";
    }

    connElem.innerHTML = icon + ' <span style="color:' + color + ';font-weight:bold;vertical-align:middle;"></span>';
}

function toggleHomeAssistantControls() {
    const homeassistantControls = document.getElementById('homeassistant-controls');
    const homeassistantIcon = document.querySelector('[onclick="toggleHomeAssistantControls()"]');
    
    if (homeassistantControls.style.display === 'none') {
        homeassistantControls.style.display = 'block';
        homeassistantIcon.style.border = '2px solid #002F7A';
        homeassistantIcon.style.boxShadow = '0 2px 8px #002F7A44';
        
        loadMQTTConfig();
    } else {
        homeassistantControls.style.display = 'none';
        homeassistantIcon.style.border = '2px solid #e9ecef';
        homeassistantIcon.style.boxShadow = 'none';
    }
}

function toggleSystemControls() {
    const systemControls = document.getElementById('system-controls');
    const systemIcon = document.querySelector('[onclick="toggleSystemControls()"]');
    
    if (systemControls.style.display === 'none') {
        systemControls.style.display = 'block';
        systemIcon.style.border = '2px solid #002F7A';
        systemIcon.style.boxShadow = '0 2px 8px #002F7A44';
    } else {
        systemControls.style.display = 'none';
        systemIcon.style.border = '2px solid #e9ecef';
        systemIcon.style.boxShadow = 'none';
    }
}

function saveMQTTConfig() {
    const mqttServer = document.getElementById('mqtt_server').value;
    const mqttPort = document.getElementById('mqtt_port').value;
    const mqttUsername = document.getElementById('mqtt_username').value;
    const mqttPassword = document.getElementById('mqtt_password').value;
    const mqttDeviceName = document.getElementById('mqtt_device_name').value;
    
    // Validation
    if (!mqttServer) {
        alert('Please enter MQTT server IP');
        return;
    }
    
    if (!mqttPort || mqttPort < 1 || mqttPort > 65535) {
        alert('Please enter a valid port (1-65535)');
        return;
    }
    
    let data = {
        id: "mqtt_config",
        server: mqttServer,
        port: parseInt(mqttPort),
        username: mqttUsername,
        password: mqttPassword,
        device_name: mqttDeviceName || "toshiba_ac"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Config: ' + json);
    
    // Show feedback
    const saveButton = event.target;
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Saved!';
    saveButton.style.background = '#4caf50';
    
    setTimeout(() => {
        saveButton.innerHTML = originalText;
        saveButton.style.background = '#4caf50';
    }, 2000);
}

function testMQTTConnection() {
    let data = {
        id: "mqtt_test",
        value: "test_connection"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Test: ' + json);
    
    // Show feedback
    const testButton = event.target;
    const originalText = testButton.innerHTML;
    testButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Testing...';
    testButton.style.background = '#ff9800';
    
    setTimeout(() => {
        testButton.innerHTML = originalText;
        testButton.style.background = '#2196f3';
    }, 3000);
}

function loadMQTTConfig() {
    let data = {
        id: "mqtt_get_config",
        value: "current"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Request MQTT Config: ' + json);
}

function sendMQTTDiscovery() {
    let data = {
        id: "mqtt_discovery",
        value: "send"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send MQTT Discovery: ' + json);
    
    // Show feedback
    const discoveryButton = event.target;
    const originalText = discoveryButton.innerHTML;
    discoveryButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">hourglass_empty</span> Sending...';
    discoveryButton.style.background = '#ff9800';
    
    setTimeout(() => {
        discoveryButton.innerHTML = originalText;
        discoveryButton.style.background = '#9c27b0';
        document.getElementById('mqtt_discovery_status').textContent = new Date().toLocaleTimeString();
    }, 2000);
}

function resetMQTTDiscovery() {
    if (confirm('This will remove the device from Home Assistant. Continue?')) {
        let data = {
            id: "mqtt_discovery",
            value: "reset"
        };
        
        let json = JSON.stringify(data);
        connection.send(json);
        console.log('Reset MQTT Discovery: ' + json);
        
        // Show feedback
        document.getElementById('mqtt_discovery_status').textContent = 'Reset at ' + new Date().toLocaleTimeString();
    }
}

// Update the HVAC control UI
function updateHVACControl(json) {
    // Target temperature
    document.getElementById('hvac-target-temp').textContent = json.target_temp || '--';
    // Current temperature
    document.getElementById('hvac-current-temp').textContent = json.temp || '--';

    // Mode and fan mode
    document.getElementById('hvac-mode').textContent = 'Mode: ' + (json.mode || '--');
    document.getElementById('hvac-fan-mode').textContent = 'Fan: ' + (json.fan || '--');

    // Draw arc for current temperature (relative to min/max)
    var minTemp = 16, maxTemp = 32;
    var current = parseFloat(json.temp);
    var percent = (current - minTemp) / (maxTemp - minTemp);
    percent = Math.max(0, Math.min(1, percent));
    var arc = document.getElementById('hvac-arc');
    var circumference = 2 * Math.PI * 70;
    arc.setAttribute('stroke-dasharray', circumference);
    arc.setAttribute('stroke-dashoffset', circumference * (1 - percent));
}

function sendRawBytes() {
    const rawInput = document.getElementById('raw_bytes_input').value.trim();
    
    if (!rawInput) {
        alert('Please enter hex bytes');
        return;
    }
    
    // Validate and parse hex bytes
    const hexBytes = rawInput.split(/\s+/); // Split by whitespace
    const validBytes = [];
    
    for (let i = 0; i < hexBytes.length; i++) {
        const hex = hexBytes[i].trim();
        if (hex === '') continue;
        
        // Check if it's a valid hex byte (00-FF)
        if (!/^[0-9A-Fa-f]{1,2}$/.test(hex)) {
            alert(`Invalid hex byte: "${hex}". Use format like "40 00 11 03"`);
            return;
        }
        
        const byteValue = parseInt(hex, 16);
        if (byteValue < 0 || byteValue > 255) {
            alert(`Byte value out of range: ${hex} (must be 00-FF)`);
            return;
        }
        
        validBytes.push(byteValue);
    }
    
    if (validBytes.length === 0) {
        alert('No valid bytes found');
        return;
    }
    
    // Send the command
    let data = {
        id: "raw_bytes",
        bytes: validBytes
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Send Raw Bytes: ' + json);
    
    // Visual feedback
    const sendButton = event.target;
    const originalText = sendButton.innerHTML;
    sendButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Sent!';
    sendButton.style.background = '#4caf50';
    
    setTimeout(() => {
        sendButton.innerHTML = originalText;
        sendButton.style.background = '#ff5722';
    }, 1500);
    
    // Clear the input after successful send
    setTimeout(() => {
        document.getElementById('raw_bytes_input').value = '';
    }, 100);
}

function startAutonomousMode() {
    let data = {
        id: "autonomous",
        value: "start"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Start Autonomous Mode: ' + json);
    
    // Visual feedback
    const startButton = document.getElementById('autonomous_start_btn');
    const originalText = startButton.innerHTML;
    startButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Started!';
    startButton.style.background = '#388e3c';
    
    setTimeout(() => {
        startButton.innerHTML = originalText;
        startButton.style.background = '#4caf50';
    }, 1500);
    
    // Update status
    document.getElementById('autonomous_status').textContent = 'Active';
    document.getElementById('autonomous_status').style.color = '#4caf50';
}

function stopAutonomousMode() {
    let data = {
        id: "autonomous",
        value: "stop"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Stop Autonomous Mode: ' + json);
    
    // Visual feedback
    const stopButton = document.getElementById('autonomous_stop_btn');
    const originalText = stopButton.innerHTML;
    stopButton.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span> Stopped!';
    stopButton.style.background = '#d32f2f';
    
    setTimeout(() => {
        stopButton.innerHTML = originalText;
        stopButton.style.background = '#f44336';
    }, 1500);
    
    // Update status
    document.getElementById('autonomous_status').textContent = 'Disabled';
    document.getElementById('autonomous_status').style.color = '#f44336';
}

function syncAddresses() {
    let data = {
        id: "sync_addresses"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Sync Addresses: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">check</span> Synced!';
    button.style.background = '#218838';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#28a745';
    }, 1500);
}

function resetAddresses() {
    let data = {
        id: "reset_addresses"
    };
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Reset Addresses: ' + json);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">check</span> Reset!';
    button.style.background = '#5a6268';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#6c757d';
    }, 1500);
}

function setManualAddresses() {
    const masterValue = document.getElementById('manual_master').value.trim();
    const remoteValue = document.getElementById('manual_remote').value.trim();
    
    if (!masterValue && !remoteValue) {
        alert('Please enter at least one address value');
        return;
    }
    
    let data = {
        id: "set_addresses"
    };
    
    if (masterValue) {
        // Convert hex string to decimal
        const masterHex = masterValue.startsWith('0x') ? masterValue : '0x' + masterValue;
        data.master = parseInt(masterHex, 16);
    }
    
    if (remoteValue) {
        // Convert hex string to decimal
        const remoteHex = remoteValue.startsWith('0x') ? remoteValue : '0x' + remoteValue;
        data.remote = parseInt(remoteHex, 16);
    }
    
    let json = JSON.stringify(data);
    connection.send(json);
    console.log('Set Manual Addresses: ' + json);
    
    // Clear inputs and show feedback
    document.getElementById('manual_master').value = '';
    document.getElementById('manual_remote').value = '';
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'Set!';
    button.style.background = '#0056b3';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '#007bff';
    }, 1500);
}

function resetObservedRemotes() {
    const message = {
        id: "reset_observed_remotes"
    };
    connection.send(JSON.stringify(message));
    
    // Optional: Show a loading indicator
    console.log("Clearing observed remotes...");
}

window.onload = function() {
    //getTimeseries();  //avoid errors when no connection is available
	showGraph();
};

<!-- end of javascript functions -->
	</script>

</head>

<body>
    <center>

        <!-- sensors information -->

        <!-- 01 Room:<span id="indoor_room_temp"  foostyle="font-size:3vw">-</span> -->
        <!-- 02 TA:<span id="indoor_ta"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- 03 TCJ:<span id="indoor_tcj"  foostyle="font-size:3vw">-</span><br> -->
        <!-- 04 TC:<span id="indoor_tc"  foostyle="font-size:3vw">-</span> -->
        <!-- F3 Flt t:<span id="indoor_filter_time2"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- 07 Fan t:<span id="indoor_fan_run_time2"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- 60 TE TempExt:<span id="outdoor_te2"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- 07 Fan Fan:<span id="indoor_fan_speed2"  foostyle="font-size:3vw">-</span>  <br> -->
        <!-- 61 TO:<span id="outdoor_to"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- 62 TD:<span id="outdoor_td"  foostyle="font-size:3vw">-</span><br> -->
        <!-- 63 TS:<span id="outdoor_ts"  foostyle="font-size:3vw">-</span> -->
        <!-- 65 THS:<span id="outdoor_ths"  foostyle="font-size:3vw">-</span><br> -->
        <!-- 6A Current:<span id="outdoor_current"  foostyle="font-size:3vw">-</span> <br> -->
        <!-- F1 Hours:<span id="outdoor_cumhour"  foostyle="font-size:3vw">-</span> -->
        <!-- 6D TL:<span id="outdoor_tl"  foostyle="font-size:3vw">-</span> -->
        <!-- 70 Comp Freq:<span id="outdoor_comp_freq"  foostyle="font-size:3vw">-</span><br> -->
        <!-- 72 Fan low:<span id="outdoor_lower_fan_speed"  foostyle="font-size:3vw">-</span> -->
        <!-- 73 Fan up:<span id="outdoor_upper_fan_speed"  foostyle="font-size:3vw">-</span> -->

        <div class="controller-card">
            <!-- Header -->
            <div
                style="text-align: center; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">                    
                    <h1 style="margin: 0; font-size: 28px; color: #002F7A; font-weight: 600;">Air Conditioning</h1>
                </div>
                <!-- <div style="font-size: 14px; color: #666; font-weight: normal;">Smart Control Panel</div> -->
            </div>
            <div class="status-row">
                <span id="connection" style="font-size: 16px;">Connecting...</span>
                <span id="status-icons"></span>
            </div>

            <!-- Target temperature Display -->
            <div class="temp-display">
                <span class="material-icons">thermostat</span>
                <span id="temp">--</span>°C
            </div>
            <div style="text-align:center; color:#888; margin-bottom:10px;">
                <span>Room: <span id="sensor_temp">--</span>°C</span>
                <!-- | <span>Humidity: <span id="dht_hum">--</span>%</span>  -->
            </div>

            <!-- Sensor display elements -->
            <div style="text-align:center; color:#888; margin-bottom:10px; font-size: 12px;">
                <!-- <div>DHT: <span id="dht_temp">--</span>°C</div>  -->

                <div>Ext Temp: <span id="outdoor_te">--</span>°C
                    | Fan: <span id="indoor_fan_speed">--</span> rpm</div>
            </div>

            <!-- Controller Buttons -->
            <div class="button-row">
                <button class="control-btn" id="power_on" onclick="power_on();">
                    <span class="material-icons">power_settings_new</span>
                    ON
                </button>
                <button class="control-btn" id="power_off" onclick="power_off();">
                    <span class="material-icons">power_off</span>
                    OFF
                </button>
                <button class="control-btn" id="save_button" onclick="save_toggle();">
                    <span class="material-icons">energy_savings_leaf</span>
                    Save
                </button>
            </div>
            <div class="button-row">
                <button class="control-btn" id="mode_fan" onclick="mode_fan();">
                    <span class="material-symbols-outlined">mode_fan</span>
                    Fan
                </button>
                <button class="control-btn" id="mode_dry" onclick="mode_dry();">
                    <span class="material-icons">opacity</span>
                    Dry
                </button>
                <button class="control-btn" id="mode_cool" onclick="mode_cool();">
                    <span class="material-icons">ac_unit</span>
                    Cool
                </button>
                <button class="control-btn" id="mode_heat" onclick="mode_heat();">
                    <span class="material-symbols-outlined">sunny</span>
                    Heat
                </button>

                <button class="control-btn" id="mode_auto" onclick="mode_auto();">
                    <span class="material-icons">autorenew</span>
                    Auto
                </button>
            </div>
            <div class="button-row">
                <button class="control-btn" id="fan_low" onclick="fan_low();">
                    <span class="material-symbols-outlined">density_large</span>
                    Low
                </button>
                <button class="control-btn" id="fan_medium" onclick="fan_medium();">
                    <span class="material-symbols-outlined">density_medium</span>
                    Med
                </button>
                <button class="control-btn" id="fan_high" onclick="fan_high();">
                    <span class="material-symbols-outlined">density_small</span>
                    High
                </button>
                <button class="control-btn" id="fan_auto" onclick="fan_auto();">
                    <span class="material-symbols-outlined">hdr_auto</span>
                    Auto
                </button>
            </div>
            <div class="button-row">
                <button class="control-btn" onclick="temp_minus();">
                    <span class="material-symbols-outlined">arrow_drop_down</span>
                    Temp -
                </button>
                <button class="control-btn" onclick="temp_plus();">
                    <span class="material-symbols-outlined">arrow_drop_up</span>
                    Temp +
                </button>
            </div>
            <!-- End of Controller buttons -->

            <!-- Collapsible in a single row -->
            <div style="margin: 18px 0;">
                <!-- Compact Icon Row -->
                <div style="display: flex; justify-content: space-around; gap: 8px; margin-bottom: 12px;">
                    <!-- Timer Icon -->
                    <div onclick="toggleTimerControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">timer</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Timer</div>
                    </div>

                    <!-- Graph Icon -->
                    <div onclick="toggleGraphControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">analytics</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Charts</div>
                    </div>

                    <!-- System Icon -->
                    <div onclick="toggleSystemControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">settings</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">System</div>
                    </div>

                    <!-- Debug Icon -->
                    <div onclick="toggleDebugControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">troubleshoot</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">Debug</div>
                    </div>

                    <!-- Home Assistant Icon -->
                    <div onclick="toggleHomeAssistantControls()"
                        style="cursor: pointer; padding: 12px; border-radius: 12px; background: #f8f9fa; border: 2px solid #e9ecef; transition: all 0.2s; flex: 1; text-align: center;">
                        <span class="material-icons" style="font-size: 24px; color: #002F7A;">home</span>
                        <div style="font-size: 10px; color: #002F7A; margin-top: 4px;">MQTT</div>
                    </div>
                </div>

                <!-- Timer Controls - Hidden by Default -->
                <div id="timer-controls" style="display: none; margin-bottom: 12px;">
                    <!-- Timer Mode Selection -->
                    <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 12px;">
                        <button class="timer-btn" id="timer_mode_off" onclick="setTimerMode('off')"
                            style="background: #ffbe0b; color: #002F7A; flex: 1; max-width: 120px;">
                            <span class="material-icons" style="font-size: 16px; margin-right: 4px;">power_off</span>
                            Timer OFF
                        </button>
                        <button class="timer-btn" id="timer_mode_on" onclick="setTimerMode('on')"
                            style="flex: 1; max-width: 120px;">
                            <span class="material-icons"
                                style="font-size: 16px; margin-right: 4px;">power_settings_new</span>
                            Timer ON
                        </button>
                    </div>

                    <!-- Timer Duration Selection -->
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 8px;">
                        <button class="timer-btn" onclick="setTimerValue(0)">0m</button>
                        <button class="timer-btn" onclick="setTimerValue(15)">15m</button>
                        <button class="timer-btn" onclick="setTimerValue(30)"
                            style="background: #ffbe0b; color: #002F7A;">30m</button>
                        <button class="timer-btn" onclick="setTimerValue(45)">45m</button>
                        <button class="timer-btn" onclick="setTimerValue(60)">1h</button>
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                        <button class="timer-adjust-btn" onclick="adjustTimer(-5)">
                            <span class="material-icons">remove</span>
                        </button>
                        <button class="timer-adjust-btn" onclick="adjustTimer(-1)">-1</button>
                        <span
                            style="font-size: 18px; font-weight: bold; color: #002F7A; min-width: 60px; text-align: center;">
                            <span id="timer_time">30</span>m
                        </span>
                        <button class="timer-adjust-btn" onclick="adjustTimer(1)">+1</button>
                        <button class="timer-adjust-btn" onclick="adjustTimer(5)">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; gap: 8px;">
                        <button class="control-btn" id="sw_set_timer_button" style="width: 48%;"
                            onclick="set_sw_air_timer();">
                            <span class="material-icons">play_arrow</span>
                            Set Timer
                        </button>
                        <button class="control-btn" id="sw_reset_timer_button" style="width: 48%;"
                            onclick="reset_sw_air_timer();">
                            <span class="material-icons">stop</span>
                            Reset Timer
                        </button>
                    </div>
                    <div style="margin-top: 8px; color: #888;">
                        Pending: <span id="timer_pending">-</span>
                    </div>
                </div>

                <!-- Graph Controls - Hidden by Default -->
                <div id="graph-controls" style="display: none; margin-bottom: 12px;">
                    <!-- Chart Container -->
                    <div class="chart-container"
                        style="position: relative; height: 300px; width: 100%; background: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <canvas id="temp_chart" width="400" height="300"></canvas>
                    </div>

                    <!-- Chart Info Summary -->
                    <div
                        style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-around; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Temp Range</div>
                            <div><span id="dht_temp_min">--</span>°C / <span id="dht_temp_max">--</span>°C</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Humidity Range</div>
                            <div><span id="dht_hum_min">--</span>% / <span id="dht_hum_max">--</span>%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #002F7A;">Pressure Range</div>
                            <div><span id="bmp_pres_min">--</span> / <span id="bmp_pres_max">--</span>mb</div>
                        </div>
                    </div>
                </div>

                <!-- System Controls - Hidden by Default -->
                <div id="system-controls" style="display: none; margin-bottom: 12px;">
                    <!-- System Information -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">System
                            Information</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>
                                <span style="color: #666;">Boot Time:</span><br>
                                <span id="boot_time" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                            <div>
                                <span style="color: #666;">IP Address:</span><br>
                                <span id="ip" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                            <div>
                                <span style="color: #666;">Free Memory:</span><br>
                                <span id="heap" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                            <div>
                                <span style="color: #666;">Decode Errors:</span><br>
                                <span id="decode_errors" style="color: #002F7A; font-weight: bold;">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Address Configuration Section -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Address
                            Configuration</div>

                        <!-- Current Addresses Display -->
                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Current addresses:</div>
                            <div style="font-family: monospace; font-size: 11px; margin-bottom: 4px;">
                                <span style="color: #333;">Active Master:</span> <span id="current_master"
                                    style="color: #002F7A; font-weight: bold;">0x--</span>
                                <span style="margin-left: 16px; color: #333;">Active Remote:</span> <span
                                    id="current_remote" style="color: #002F7A; font-weight: bold;">0x--</span>
                            </div>
                            <div style="font-family: monospace; font-size: 11px;">
                                <span style="color: #666;">Observed Master:</span> <span id="observed_master"
                                    style="color: #28a745; font-weight: bold;">0x--</span>
                                <span style="margin-left: 16px; color: #666;">Observed Remotes:</span> <span
                                    id="observed_remotes" style="color: #28a745; font-weight: bold;">0x--</span>
                            </div>
                        </div>

                        <!-- Address Controls -->
                        <div
                            style="margin-bottom: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeaa7;">
                            <div style="color: #856404; font-size: 11px; margin-bottom: 6px;">Address Controls:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button onclick="syncAddresses();"
                                    style="flex: 1; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">sync</span>
                                    Use Observed
                                </button>
                                <button onclick="resetAddresses();"
                                    style="flex: 1; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    <span class="material-icons"
                                        style="font-size: 12px; vertical-align: middle;">refresh</span>
                                    Reset Default
                                </button>
                                <button onclick="resetObservedRemotes();"
                                    style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 4px;">
                                    Clear Observed
                                </button>
                            </div>
                            <div style="color: #856404; font-size: 10px;">
                                "Use Observed" copies detected addresses to active ones. "Reset Default" restores
                                0x00/0x40.
                            </div>
                        </div>

                        <!-- Manual Address Setting -->
                        <div
                            style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Manual address setting:</div>
                            <div
                                style="display: flex; gap: 4px; margin-bottom: 4px; align-items: center; justify-content: center;">
                                <label for="manual_master" style="color: #333; font-size: 11px;">Master:</label>
                                <input id="manual_master" type="text" placeholder="0x00" maxlength="4"
                                    style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                                <label for="manual_remote" style="color: #333; font-size: 11px;">Remote:</label>
                                <input id="manual_remote" type="text" placeholder="0x40" maxlength="4"
                                    style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                                <button onclick="setManualAddresses();"
                                    style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    Set
                                </button>
                            </div>
                            <div style="color: #999; font-size: 10px;">
                                Enter hex values (e.g., 0x00, 0x40). Leave empty to keep current.
                            </div>
                        </div>
                    </div>


                    <!-- Autonomous Mode Control -->
                    <div
                        style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                        <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Autonomous Mode:</div>
                        <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                            <button id="autonomous_start_btn" onclick="startAutonomousMode();"
                                style="flex: 1; padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle;">play_arrow</span>
                                Start Auto
                            </button>
                            <button id="autonomous_stop_btn" onclick="stopAutonomousMode();"
                                style="flex: 1; padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle;">stop</span>
                                Stop Auto
                            </button>
                        </div>
                        <div style="color: #999; font-size: 10px;">
                            Sends ping and temperature every 8 seconds. A temperature sensor is required.
                        </div>
                        <div style="margin-top: 4px;">
                            Status: <span id="autonomous_status"
                                style="font-weight: bold; color: #f44336;">Disabled</span>
                        </div>
                    </div>

                    <!-- Temperature Sampling Rate -->
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666; font-size: 12px;">Temperature sampling rate:</span>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <input id="sampling_text" type="number" min="1" max="3600"
                                style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                placeholder="seconds" />
                            <button id="sampling_button" onclick="set_sampling();"
                                style="padding: 4px 8px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Set</button>
                        </div>
                    </div>
                    <!-- Upload file -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Upload File
                        </div>
                        <input type="file" id="file_input" accept=".txt,.json" style="margin-bottom: 8px;">
                        <button id="upload_button" onclick="uploadFile();"
                            style="padding: 6px 12px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Upload</button>

                        <div style="margin-top: 12px;">
                            <a href="/edit.html"
                                style="color: #002F7A; text-decoration: underline; font-size: 13px;">Upload file</a>
                        </div>
                    </div>
                </div>

                <!-- Debug Controls - Hidden by Default -->
                <div id="debug-controls" style="display: none; margin-bottom: 12px;">

                    <!-- Raw Bytes Input Section -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Send Raw
                        </div>

                        <div
                            style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Send Raw Bytes:</div>
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <input id="raw_bytes_input" type="text" placeholder="00 FE 10 02 80 8A E6"
                                    style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" />
                                <button onclick="sendRawBytes();"
                                    style="padding: 6px 12px; background: #002F7A; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">

                                    Send
                                </button>
                            </div>
                            <div style="color: #999; font-size: 10px;">
                                Bytes separted by spaces: PING "00 FE 10 02 80 8A E6"
                            </div>
                        </div>

                    </div>

                    <!-- Debug Output -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Debug
                            Output</div>

                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                                <input id="check_cmd" type="checkbox" style="margin-right: 6px;">
                                <span>Last commands log</span>

                            </label>
                            <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                                <input id="check_cmd_typed" type="checkbox" style="margin-right: 6px;">
                                <span>Commands with type</span>
                            </label>

                            <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer;">
                                <input id="check_rx" type="checkbox" style="margin-right: 6px;">
                                <span>Raw data log</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Last commands:</div>
                            <div id="last_cmd"
                                style="background: #f8f9fa; padding: 6px; border-radius: 4px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; word-break: break-all; text-align: left;">
                                --</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Raw data:</div>
                            <div id="rx_data"
                                style="background: #f8f9fa; padding: 6px; border-radius: 4px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; word-break: break-all; text-align: left;">
                                --</div>
                        </div>
                    </div>

                    <!-- Serial Log Display -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-top: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div
                            style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
                            <span>Serial Log</span>
                            <button onclick="clearSerialLog()"
                                style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Clear</button>
                        </div>
                        <pre id="serial-log"
                            style="background: #f8f8f8; border: 1px solid #ddd; padding: 8px; border-radius: 4px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; margin: 0; white-space: pre-wrap; word-wrap: break-word;  text-align: left;">Waiting for messages...</pre>
                    </div>
                </div>

                <!-- Home Assistant Controls - Hidden by Default -->
                <div id="homeassistant-controls" style="display: none; margin-bottom: 12px;">
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">MQTT Broker
                            Settings</div>

                        <div style="display: grid; gap: 8px;">
                            <div>
                                <label style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">MQTT
                                    Server IP:</label>
                                <input id="mqtt_server" type="text" placeholder="homeassistant.local"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <label
                                        style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Port:</label>
                                    <input id="mqtt_port" type="number" placeholder="1883" min="1" max="65535"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                                </div>
                                <div>
                                    <label
                                        style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Device
                                        Name:</label>
                                    <input id="mqtt_device_name" type="text" placeholder="toshiba_ac"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <label
                                        style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Username:</label>
                                    <input id="mqtt_username" type="text" placeholder="mqtt_user"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                                </div>
                                <div>
                                    <label
                                        style="color: #666; font-size: 12px; display: block; margin-bottom: 4px;">Password:</label>
                                    <input id="mqtt_password" type="password" placeholder="mqtt_password"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;" />
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="saveMQTTConfig();"
                                style="flex: 1; padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle; margin-right: 4px;">save</span>
                                Save Config
                            </button>
                            <button onclick="testMQTTConnection();"
                                style="flex: 1; padding: 8px 12px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle; margin-right: 4px;">wifi_find</span>
                                Test Connection
                            </button>
                            <button onclick="loadMQTTConfig();"
                                style="flex: 1; padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle; margin-right: 4px;">refresh</span>
                                Load Current
                            </button>
                        </div>
                    </div>

                    <!-- Home Assistant Integration -->
                    <div
                        style="background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">Home
                            Assistant Integration</div>

                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button onclick="sendMQTTDiscovery();"
                                style="flex: 1; padding: 8px 12px; background: #9c27b0; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle; margin-right: 4px;">search</span>
                                Send Discovery
                            </button>
                            <button onclick="resetMQTTDiscovery();"
                                style="flex: 1; padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <span class="material-icons"
                                    style="font-size: 14px; vertical-align: middle; margin-right: 4px;">delete</span>
                                Reset Discovery
                            </button>
                        </div>

                        <div
                            style="color: #666; font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                            <strong>Instructions:</strong><br>
                            1. Configure your MQTT broker settings above<br>
                            2. Click "Save Config" to apply settings<br>
                            3. Click "Send Discovery" to register with Home Assistant<br>
                            4. The climate control should appear in Home Assistant automatically
                        </div>
                    </div>

                    <!-- MQTT Status -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px #002F7A22;">
                        <div style="font-weight: bold; color: #002F7A; margin-bottom: 8px; font-size: 14px;">MQTT Status
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>
                                <span style="color: #666;">Connection:</span><br>
                                <span id="mqtt_status" style="color: #f44336; font-weight: bold;">Disconnected</span>
                            </div>
                            <div>
                                <span style="color: #666;">Last Discovery:</span><br>
                                <span id="mqtt_discovery_status" style="color: #666; font-weight: bold;">Never
                                    sent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End of collapsible buttons -->



        </div>



</body>

</html>